<!DOCTYPE html><html lang=[&quot;zh-CN&quot;,&quot;zh-TW&quot;,&quot;en&quot;,&quot;default&quot;] data-theme=light><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>RabbtMQ教程一 | YuydotのBlog</title><meta name=author content=yuydot><meta name=copyright content=yuydot><meta name=format-detection content="telephone=no"><meta name=theme-color content=#3eb8be;><meta name=description content="一、MQ 的相关概念1. 什么是MQMQ(message queue)，从字面意思上看，本质是个队列，FIFO 先入先出，只不过队列中存放的内容是 message 而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，MQ 是一种非常常 见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不 用依赖其他服务。 2. 为什么要用MQ 流量消"><meta property=og:type content=article><meta property=og:title content=RabbtMQ教程一><meta property=og:url content=https://yuydot.gitee.io/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/index.html><meta property=og:site_name content=YuydotのBlog><meta property=og:description content="一、MQ 的相关概念1. 什么是MQMQ(message queue)，从字面意思上看，本质是个队列，FIFO 先入先出，只不过队列中存放的内容是 message 而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，MQ 是一种非常常 见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不 用依赖其他服务。 2. 为什么要用MQ 流量消"><meta property=og:locale content=zh_CN><meta property=og:image content=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png><meta property=article:published_time content=2023-05-09T11:51:28.000Z><meta property=article:modified_time content=2023-05-21T15:00:55.832Z><meta property=article:author content=yuydot><meta property=article:tag content=RabbitMQ><meta name=twitter:card content=summary><meta name=twitter:image content=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png><link rel="shortcut icon" href=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/logo1.png><link rel=canonical href=https://yuydot.gitee.io/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css media=print onload="this.media='all'"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/4.0.31/fancybox.min.css media=print onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"距离上次更新已经过去","messageNext":"天了，文章内容可能已经过时。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id=config-diff>var GLOBAL_CONFIG_SITE = {
  title: 'RabbtMQ教程一',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-21 23:00:55'
}</script><noscript><style type=text/css>
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#3eb8be;')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel=stylesheet href=/css/background.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/readPercent.css><link rel=stylesheet href=/css/footer.css><link rel=stylesheet href=/css/loading_css.css><span id=fps></span><link rel=stylesheet href=https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css><svg aria-hidden=true style="position:absolute; overflow:hidden; width:0; height:0"><symbol id=icon-sun viewbox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill=#FFD878 p-id=8420></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill=#FFE4A9 p-id=8421></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill=#4D5152 p-id=8422></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill=#4D5152 p-id=8423></path></symbol><symbol id=icon-moon viewbox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill=#FFB531 p-id=11345></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill=#030835 p-id=11346></path></symbol></svg><div id=myscoll></div><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css><style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css media=print onload="this.media='screen'"><meta name=generator content="Hexo 6.3.0"></head><body><div id=loading-box onclick=document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)><div class=loading-bg><div class=loading-img></div><div class=loading-image-dot></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel=stylesheet href=/css/progress_bar.css><script src=https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js></script><div id=web_bg></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img is-center"><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wang.jpg onerror="onerror=null;src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/friend_404.gif'" alt=avatar></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class=headline>文章</div><div class=length-num>19</div></a><a href="/tags/"><div class=headline>标签</div><div class=length-num>10</div></a><a href="/categories/"><div class=headline>分类</div><div class=length-num>5</div></a></div><hr><div class=menus_items><div class=menus_item><a class=site-page href="/"><i class="fa-fw fas fa-home"></i><span>主页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fa fa-graduation-cap"></i><span>博文</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span>标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span>归档</span></a></li></ul></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fas fa-list"></i><span>生活</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span>分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span>影视</span></a></li></ul></div><div class=menus_item><a class=site-page href="/links/"><i class="fa-fw fa fa-link"></i><span>友链</span></a></div><div class=menus_item><a class=site-page href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span>留言板</span></a></div><div class=menus_item><a class=site-page href="/about/"><i class="fa-fw fas fa-heart"></i><span>关于笔者</span></a></div></div></div></div><div class=post id=body-wrap><header class=post-bg id=page-header style="background-image: url('https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png')"><nav id=nav><span id=blog-info><a href="/" title=YuydotのBlog><span class=site-name>YuydotのBlog</span></a></span><div id=weather><div id=tp-weather-widget></div></div><div id=menus><div class=menus_items><div class=menus_item><a class=site-page href="/"><i class="fa-fw fas fa-home"></i><span>主页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fa fa-graduation-cap"></i><span>博文</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span>标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span>归档</span></a></li></ul></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fas fa-list"></i><span>生活</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span>分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span>影视</span></a></li></ul></div><div class=menus_item><a class=site-page href="/links/"><i class="fa-fw fa fa-link"></i><span>友链</span></a></div><div class=menus_item><a class=site-page href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span>留言板</span></a></div><div class=menus_item><a class=site-page href="/about/"><i class="fa-fw fas fa-heart"></i><span>关于笔者</span></a></div></div><div id=toggle-menu><a class=site-page href=javascript:void(0);><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id=post-info><h1 class=post-title>RabbtMQ教程一</h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class=post-meta-label>发表于</span><time class=post-meta-date-created datetime=2023-05-09T11:51:28.000Z title="发表于 2023-05-09 19:51:28">2023-05-09</time><span class=post-meta-separator>|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class=post-meta-label>更新于</span><time class=post-meta-date-updated datetime=2023-05-21T15:00:55.832Z title="更新于 2023-05-21 23:00:55">2023-05-21</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href="/categories/Springboot/">Springboot</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>字数总计:</span><span class=word-count>9.9k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>阅读时长:</span><span>34分钟</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv data-flag-title=RabbtMQ教程一><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>阅读量:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class=waves-svg xmlns=http://www.w3.org/2000/svg xlink=http://www.w3.org/1999/xlink viewbox="0 24 150 28" preserveaspectratio=none shape-rendering=auto><defs><path id=gentle-wave d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class=parallax><use href=#gentle-wave x=48 y=0></use><use href=#gentle-wave x=48 y=3></use><use href=#gentle-wave x=48 y=5></use><use href=#gentle-wave x=48 y=7></use></g></svg></section></header><main class=layout id=content-inner><div id=post><article class=post-content id=article-container><h2 id=一、MQ-的相关概念><a href=#一、MQ-的相关概念 class=headerlink title="一、MQ 的相关概念"></a>一、MQ 的相关概念</h2><h3 id=1-什么是MQ><a href=#1-什么是MQ class=headerlink title="1. 什么是MQ"></a>1. 什么是MQ</h3><p>MQ(message queue)，从字面意思上看，本质是个队列，FIFO 先入先出，只不过队列中存放的内容是 message 而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，MQ 是一种非常常 见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不 用依赖其他服务。</p><h3 id=2-为什么要用MQ><a href=#2-为什么要用MQ class=headerlink title="2. 为什么要用MQ"></a>2. 为什么要用MQ</h3><ul><li><strong>流量消峰</strong></li></ul><p>举个例子，如果订单系统最多能处理一万次订单，这个处理能力应付正常时段的下单时绰绰有余，正常时段我们下单一秒后就能返回结果。但是在高峰期，如果有两万次下单操作系统是处理不了的，只能限制订单超过一万后不允许用户下单。使用消息队列做缓冲，我们可以取消这个限制，把一秒内下的订单分散成一段时间来处理，这时有些用户可能在下单十几秒后才能收到下单成功的操作，但是比不能下单的体验要好。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/19-36-29-59161dd5530dd5dcaa8fd6cfce8694db-1f684a91d6194500a95a1b5439f58e38-9904f0.png alt=在这里插入图片描述></p><ul><li><strong>应用解耦</strong></li></ul><p>以电商应用为例，应用中有订单系统、库存系统、物流系统、支付系统。用户创建订单后，如果耦合 调用库存系统、物流系统、支付系统，任何一个子系统出了故障，都会造成下单操作异常。当转变成基于 消息队列的方式后，系统间调用的问题会减少很多，比如物流系统因为发生故障，需要几分钟来修复。在 这几分钟的时间里，物流系统要处理的内存被缓存在消息队列中，用户的下单操作可以正常完成。当物流 系统恢复后，继续处理订单信息即可，中单用户感受不到物流系统的故障，提升系统的可用性。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/19-54-56-b9e447f39d200b1f55917b4d1fcee50e-RabbitMQ-00000004-b33bdf.png alt=RabbitMQ-00000004></p><ul><li><strong>异步处理</strong></li></ul><p>有些服务间调用是异步的，例如 A 调用 B，B 需要花费很长时间执行，但是 A 需要知道 B 什么时候可以执行完。</p><p>以前一般有两种方式，A 过一段时间去调用 B 的查询 api 查询。或者 A 提供一个 callback api， B 执行完之后调用 api 通知 A 服务。这两种方式都不是很优雅。</p><p>使用消息总线，可以很方便解决这个问题， A 调用 B 服务后，只需要监听 B 处理完成的消息，当 B 处理完成后，会发送一条消息给 MQ，MQ 会将此消息转发给 A 服务。这样 A 服务既不用循环调用 B 的查询 api，也不用提供 callback api。同样B 服务也不用 做这些操作。A 服务还能及时的得到异步处理成功的消息。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/19-54-56-8d9ce50390c044fb57669dd35beaba6b-RabbitMQ-00000005-726766.png alt=RabbitMQ-00000005></p><p>上面的说明不是很理解是吧，举个栗子：</p><p>场景说明：用户需发送短信验证码时，点击发送短信，第三方平台发送短信至用户手机成功，执行倒计时60秒。传统的做法有两种 1.串行的方式;2.并行方式：</p><p>(1) 串行方式：将用户点击发送短信，第三方平台发送短信至用户手机成功，执行倒计时60秒。以上三个任务全部完成后，返回给客户端(响应150ms)。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/19-29-49-1cb61a28a75a44625e1ac2c3d647387a-cbcb38b6ee390cae4c11acd7424cf18e-772c1d.png alt=硬核！动力节点RabbitMQ入门教程，详细到哭></p><p>(2) 并行方式：在用户点击发送短信成功后，第三方平台发送短信的同时，执行倒计时60秒。与串行的差别是，并行的方式可以提高处理的时间(响应100ms)。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/19-30-12-223cefb88f43036d26711081b1845ddf-2e32125351a8b343e1f9bfa807a07311-1c930a.png alt=硬核！动力节点RabbitMQ入门教程，详细到哭></p><p>(3) 引入消息队列，将不是必须的业务逻辑，异步处理(55ms)。改造后的架构如下：</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/19-30-28-987aa61fa9fdd859fa582b95be669da4-8d0551dba2030c90c703591f085d904a-24e08d.png alt=硬核！动力节点RabbitMQ入门教程，详细到哭></p><p>为了更好的理解者三个特性:<a target=_blank rel=noopener href="https://blog.csdn.net/Javanewspaper/article/details/122251486?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168414966416800215013095%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168414966416800215013095&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-2-122251486-null-null.142%5Ev87%5Econtrol_2,239%5Ev2%5Einsert_chatgpt&utm_term=rabbitmq%E6%95%99%E7%A8%8B&spm=1018.2226.3001.4187">参考此链接</a></p><h3 id=3-MQ-的分类><a href=#3-MQ-的分类 class=headerlink title="3. MQ 的分类"></a>3. MQ 的分类</h3><p>::: tip ActiveMQ</p><p>:::</p><p>优点：单机吞吐量万级，时效性 ms 级，可用性高，基于主从架构实现高可用性，消息可靠性较 低的概率丢失数据</p><p>缺点：官方社区现在对 ActiveMQ 5.x 维护越来越少，高吞吐量场景较少使用。</p><p>::: tip Kafka</p><p>:::</p><p>大数据的杀手锏，谈到大数据领域内的消息传输，则绕不开 Kafka，这款为<strong>大数据而生</strong>的消息中间件， 以其百万级 TPS 的吞吐量名声大噪，迅速成为大数据领域的宠儿，在数据采集、传输、存储的过程中发挥 着举足轻重的作用。目前已经被 LinkedIn，Uber, Twitter, Netflix 等大公司所采纳。</p><p><strong>优点</strong>：性能卓越，单机写入 TPS 约在百万条&#x2F;秒，最大的优点，就是<strong>吞吐量高</strong>。时效性 ms 级可用性非 常高，kafka 是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用,消费者采 用 Pull 方式获取消息, 消息有序, 通过控制能够保证所有消息被消费且仅被消费一次;有优秀的第三方Kafka Web 管理界面 Kafka-Manager；在日志领域比较成熟，被多家公司和多个开源项目使用；功能支持： 功能 较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</p><p><strong>缺点</strong>：Kafka 单机超过 64 个队列&#x2F;分区，Load 会发生明显的飙高现象，队列越多，load 越高，发送消 息响应时间变长，使用短轮询方式，实时性取决于轮询间隔时间，消费失败不支持重试；支持消息顺序， 但是一台代理宕机后，就会产生消息乱序，<strong>社区更新较慢</strong>；</p><p>::: tip RocketMQ</p><p>:::</p><p>RocketMQ 出自阿里巴巴的开源产品，用 Java 语言实现，在设计时参考了 Kafka，并做出了自己的一 些改进。被阿里巴巴广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，binglog 分发等场 景。</p><p>优点：<strong>单机吞吐量十万级</strong>,可用性非常高，分布式架构，<strong>消息可以做到 0 丢失</strong>,MQ 功能较为完善，还是分 布式的，扩展性好,支<strong>持 10 亿级别的消息堆积</strong>，不会因为堆积导致性能下降,源码是 java 我们可以自己阅 读源码，定制自己公司的 MQ</p><p>缺点：<strong>支持的客户端语言不多</strong>，目前是 java 及 c++，其中 c++不成熟；社区活跃度一般,没有在MQ 核心中去实现 JMS 等接口,有些系统要迁移需要修改大量代码</p><p>::: note RabbitMQ</p><p>:::</p><p>2007 年发布，是一个在AMQP(高级消息队列协议)基础上完成的，可复用的企业消息系统，<strong>是当前最主流的消息中间件之一。</strong></p><p>优点：由于 erlang 语言的高并发特性，性能较好；吞吐量到万级，MQ 功能比较完备,健壮、稳定、易 用、跨平台、支持多种语言 如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等，支持 AJAX 文档齐全；开源提供的管理界面非常棒，用起来很好用,社区活跃度高；更新频率相当高</p><p>官网更新：<a target=_blank rel=noopener href=https://www.rabbitmq.com/news.html>https://www.rabbitmq.com/news.html</a></p><p>缺点：商业版需要收费,学习成本较高</p><h3 id=4-MQ-的选择><a href=#4-MQ-的选择 class=headerlink title="4. MQ 的选择"></a>4. MQ 的选择</h3><ul><li><strong>Kafka</strong></li></ul><p>Kafka 主要特点是基于Pull 的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集 和传输，适合产生大量数据的互联网服务的数据收集业务。大型公司建议可以选用，如果有日志采集功能， 肯定是首选 kafka 了。</p><p><a target=_blank rel=noopener href=http://www.gulixueyuan.com/course/330/tasks>尚硅谷官网 kafka 视频教程</a></p><ul><li><strong>RocketMQ</strong></li></ul><p>天生为<strong>金融互联网</strong>领域而生，对于可靠性要求很高的场景，尤其是电商里面的订单扣款，以及业务削 峰，在大量交易涌入时，后端可能无法及时处理的情况。RoketMQ 在稳定性上可能更值得信赖，这些业务 场景在阿里双 11 已经经历了多次考验，如果你的业务有上述并发场景，建议可以选择 RocketMQ。</p><ul><li>RabbitMQ</li></ul><p>结合 erlang 语言本身的并发优势，性能好时效性微秒级，社区活跃度也比较高，管理界面用起来十分 方便，如果你的<strong>数据量没有那么大</strong>，中小型公司优先选择功能比较完备的 RabbitMQ。</p><h2 id=二、RabbitMQ><a href=#二、RabbitMQ class=headerlink title=二、RabbitMQ></a>二、RabbitMQ</h2><h3 id=1-RabbitMQ-的概念><a href=#1-RabbitMQ-的概念 class=headerlink title="1. RabbitMQ 的概念"></a>1. RabbitMQ 的概念</h3><p>RabbitMQ 是一个消息中间件：它接受并转发消息。</p><p>你可以把它当做一个快递站点，当你要发送一个包裹时，你把你的包裹放到快递站，快递员最终会把你的快递送到收件人那里，按照这种逻辑 RabbitMQ 是 一个快递站，一个快递员帮你传递快件。</p><p>RabbitMQ 与快递站的主要区别在于，它不处理快件而是接收， 存储和转发消息数据。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/19-54-57-0ff07c7857a14bd322fcf2d06c52637a-image-20210625230930992-eb718b.png alt=image-20210625230930992></p><p>官网：<a target=_blank rel=noopener href=https://www.rabbitmq.com/#features>https://www.rabbitmq.com/#features</a></p><h3 id=2-四大核心概念><a href=#2-四大核心概念 class=headerlink title="2. 四大核心概念"></a>2. 四大核心概念</h3><ul><li><p>生产者</p><p>产生数据发送消息的程序是生产者</p></li><li><p>交换机</p><p>交换机是 RabbitMQ 非常重要的一个部件，一方面它接收来自生产者的消息，另一方面它将消息 推送到队列中。交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推 送到多个队列，亦或者是把消息丢弃，这个得有交换机类型决定</p></li><li><p>队列</p><p>队列是 RabbitMQ 内部使用的一种数据结构，尽管消息流经 RabbitMQ 和应用程序，但它们只能存 储在队列中。队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。许多生产者可 以将消息发送到一个队列，许多消费者可以尝试从一个队列接收数据。这就是我们使用队列的方式</p></li><li><p>消费者</p><p>消费与接收具有相似的含义。消费者大多时候是一个等待接收消息的程序。请注意生产者，消费 者和消息中间件很多时候并不在同一机器上。同一个应用程序既可以是生产者又是可以是消费者。</p></li></ul><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/19-37-29-1965e2cd79bd2783558a21b4ba8c6588-e1fb69fd30e942b2942b1e1b80ffe244-6c05bb.png alt=在这里插入图片描述></p><h3 id=3-RabbitMQ的核心部分><a href=#3-RabbitMQ的核心部分 class=headerlink title="3. RabbitMQ的核心部分"></a>3. RabbitMQ的核心部分</h3><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/19-38-55-50caf5b30439a8ccabfdec2f2e3d4b88-ff99a7aa44b7476cbbc5a4b508605d1a-77fdfe.png alt=在这里插入图片描述></p><h3 id=4-各个名词介绍><a href=#4-各个名词介绍 class=headerlink title="4. 各个名词介绍"></a>4. 各个名词介绍</h3><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/19-54-58-7ba1b021e027f130ef0de286cb0a7a55-RabbitMQ-00000007-47a19d.png alt=RabbitMQ-00000007></p><ul><li><p>Broker</p><p>接收和分发消息的应用，RabbitMQ Server 就是 Message Broker</p></li><li><p>Virtual host</p><p>出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似 于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出 多个 vhost，每个用户在自己的 vhost 创建 exchange／queue 等</p></li><li><p>Connection</p><p>publisher／consumer 和 broker 之间的 TCP 连接</p></li><li><p>Channel</p><p>如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection 的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程 序支持多线程，通常每个 thread 创建单独的 channel 进行通讯，AMQP method 包含了 channel id 帮助客 户端和 message broker 识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销</p></li><li><p>Exchange</p><p>message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发 消息到 queue 中去。常用的类型有：direct (point-to-point), topic (publish-subscribe) and fanout (multicast)</p></li><li><p>Queue</p><p>消息最终被送到这里等待 consumer 取走</p></li><li><p>Binding</p><p>exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key，Binding 信息被保 存到 exchange 中的查询表中，用于 message 的分发依据</p></li></ul><h2 id=三、RabbitMQ安装><a href=#三、RabbitMQ安装 class=headerlink title=三、RabbitMQ安装></a>三、RabbitMQ安装</h2><h3 id=1-Linux环境下安装RabbitMQ><a href=#1-Linux环境下安装RabbitMQ class=headerlink title="1. Linux环境下安装RabbitMQ"></a>1. Linux环境下安装RabbitMQ</h3><blockquote><p>我的安装参考：<a target=_blank rel=noopener href=https://blog.csdn.net/m0_67392182/article/details/126040124>RabbitMQ安装教程</a></p></blockquote><h4 id=1-1-下载><a href=#1-1-下载 class=headerlink title="1.1 下载"></a>1.1 下载</h4><p>官网下载地址：<a target=_blank rel=noopener href=https://www.rabbitmq.com/download.html>https://www.rabbitmq.com/download.html</a></p><p>这里我们选择的版本号（注意这两版本要求）</p><ul><li><p>rabbitmq-server-3.8.8-1.el7.noarch.rpm</p><p>GitHub：<a target=_blank rel=noopener href=https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.8.8>https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.8.8</a></p><p>加载下载：<a target=_blank rel=noopener href=https://packagecloud.io/rabbitmq/rabbitmq-server/packages/el/7/rabbitmq-server-3.8.8-1.el7.noarch.rpm>https://packagecloud.io/rabbitmq/rabbitmq-server/packages/el/7/rabbitmq-server-3.8.8-1.el7.noarch.rpm</a></p></li><li><p>erlang-21.3.8.21-1.el7.x86_64.rpm</p><p>官网：<a target=_blank rel=noopener href="https://www.erlang-solutions.com/downloads/">https://www.erlang-solutions.com/downloads/</a></p><p>加速：<a target=_blank rel=noopener href=https://packagecloud.io/rabbitmq/erlang/packages/el/7/erlang-21.3.8.21-1.el7.x86_64.rpm>https://packagecloud.io/rabbitmq/erlang/packages/el/7/erlang-21.3.8.21-1.el7.x86_64.rpm</a></p></li></ul><p>Red Hat 8, CentOS 8 和 modern Fedora 版本，把 “el7” 替换成 “el8”</p><h4 id=1-2-安装><a href=#1-2-安装 class=headerlink title="1.2 安装"></a>1.2 安装</h4><p>上传到 <code>/usr/local/software</code> 目录下(如果没有 software 需要自己创建)</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>rpm -ivh erlang-21.3.8.21-1.el7.x86_64.rpm</span><br><span class=line>yum install socat -y</span><br><span class=line>rpm -ivh rabbitmq-server-3.8.8-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure><h4 id=1-3-启动><a href=#1-3-启动 class=headerlink title="1.3 启动"></a>1.3 启动</h4><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 启动服务</span></span><br><span class=line>systemctl start rabbitmq-server</span><br><span class=line><span class=comment># 查看服务状态</span></span><br><span class=line>systemctl status rabbitmq-server</span><br><span class=line><span class=comment># 开机自启动</span></span><br><span class=line>systemctl <span class=built_in>enable</span> rabbitmq-server</span><br><span class=line><span class=comment># 停止服务</span></span><br><span class=line>systemctl stop rabbitmq-server</span><br><span class=line><span class=comment># 重启服务</span></span><br><span class=line>systemctl restart rabbitmq-server</span><br></pre></td></tr></table></figure><h3 id=2-Web管理界面及授权操作><a href=#2-Web管理界面及授权操作 class=headerlink title="2. Web管理界面及授权操作"></a>2. Web管理界面及授权操作</h3><h4 id=2-1-安装><a href=#2-1-安装 class=headerlink title="2.1 安装"></a>2.1 安装</h4><p>默认情况下，是没有安装web端的客户端插件，需要安装才可以生效</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>rabbitmq-plugins <span class=built_in>enable</span> rabbitmq_management</span><br></pre></td></tr></table></figure><p>安装完毕以后，重启服务即可</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>systemctl restart rabbitmq-server</span><br></pre></td></tr></table></figure><p>访问 <a target=_blank rel=noopener href="http://42.192.149.71:15672/">http://42.192.149.71:15672</a> ，用默认账号密码(guest)登录，出现权限问题</p><p>默认情况只能在 localhost 本机下访问，所以需要添加一个远程登录的用户</p><h4 id=2-2-添加用户><a href=#2-2-添加用户 class=headerlink title="2.2 添加用户"></a>2.2 添加用户</h4><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 创建账号和密码</span></span><br><span class=line>rabbitmqctl add_user admin 123456</span><br><span class=line></span><br><span class=line><span class=comment># 设置用户角色</span></span><br><span class=line>rabbitmqctl set_user_tags admin administrator</span><br><span class=line></span><br><span class=line><span class=comment># 为用户添加资源权限</span></span><br><span class=line><span class=comment># set_permissions [-p &lt;vhostpath&gt;] &lt;user&gt; &lt;conf&gt; &lt;write&gt; &lt;read&gt;</span></span><br><span class=line>rabbitmqctl set_permissions -p <span class=string>&quot;/&quot;</span> admin <span class=string>&quot;.*&quot;</span> <span class=string>&quot;.*&quot;</span> <span class=string>&quot;.*&quot;</span></span><br><span class=line><span class=comment># 添加配置、写、读权限</span></span><br></pre></td></tr></table></figure><p>用户级别：</p><ol><li><strong>administrator</strong>：可以登录控制台、查看所有信息、可以对 rabbitmq 进行管理</li><li><strong>monitoring</strong>：监控者 登录控制台，查看所有信息</li><li><strong>policymaker</strong>：策略制定者 登录控制台，指定策略</li><li><strong>managment</strong>：普通管理员 登录控制台</li></ol><p>再次登录，用 admin 用户</p><p>::: tip 重置命令</p><p>:::</p><p>关闭应用的命令为：rabbitmqctl stop_app</p><p>清除的命令为：rabbitmqctl reset</p><p>重新启动命令为：rabbitmqctl start_app</p><p><strong>问题：</strong><a target=_blank rel=noopener href="https://blog.csdn.net/weixin_44827844/article/details/115587788?ops_request_misc=&request_id=&biz_id=102&utm_term=linux%E5%BC%80%E5%90%AFrabbitMQ%EF%BC%8C%E5%9C%A8windows%E8%AE%BF%E9%97%AE&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-115587788.142%5Ev86%5Einsert_down1,239%5Ev2%5Einsert_chatgpt&spm=1018.2226.3001.4187">解决Linux中安装RabbitMQ后在windows无法打开15672和无法通过java发送消息</a></p><p>​ (1) <strong>解决Linux中安装RabbitMQ后，无法在windows打开15672</strong></p><p>​ 首先，要确保自己的linux虚拟机已经安装部署好<a target=_blank rel=noopener href="https://so.csdn.net/so/search?q=RabbitMQ&spm=1001.2101.3001.7020">RabbitMQ</a>，并且在linux中能够访问15672端口</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/20-07-50-91692924eb5ab5ed2449a9a1eefb6823-20210411033040653-1a4062.png alt=在这里插入图片描述></p><p>​ 如图所示，我们在linux虚拟机中能够访问15672端口，但是windows中不能访问。</p><p>​ <strong>(2) 打开Linux终端</strong></p><ol><li><p><strong>关闭firewall</strong>：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>systemctl stop firewalld.service</span><br></pre></td></tr></table></figure></li><li><p><strong>禁止firewall开机启动</strong></p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>systemctl <span class=built_in>disable</span> firewalld.service</span><br></pre></td></tr></table></figure><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/20-12-33-8beb198a242768e918bd6ec17e24f11b-image-20230509201233799-e58545.png alt=image-20230509201233799></p><p>之后再windos中就可以通过浏览器访问15672端口拉~ 地址：<a target=_blank rel=noopener href="http://192.168.32.128:15672/">http://192.168.32.128:15672/</a></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/20-15-46-4f08954d7f29a7f1338c42030a033b72-image-20230509201546520-45bddb.png alt=image-20230509201546520></p></li></ol><h2 id=四、Docker-安装><a href=#四、Docker-安装 class=headerlink title="四、Docker 安装"></a>四、Docker 安装</h2><p>官网：<a target=_blank rel=noopener href="https://registry.hub.docker.com/_/rabbitmq/">https://registry.hub.docker.com/_/rabbitmq/</a></p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>docker run -<span class=built_in>id</span> --name myrabbit -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=123456 -p 15672:15672 rabbitmq:3-management</span><br></pre></td></tr></table></figure><h2 id=五、HelloWorld><a href=#五、HelloWorld class=headerlink title=五、HelloWorld></a>五、HelloWorld</h2><h3 id=1-准备（代码demo1）><a href=#1-准备（代码demo1） class=headerlink title="1. 准备（代码demo1）"></a>1. 准备（代码demo1）</h3><p>我们将用 Java 编写两个程序。发送单个消息的生产者和接收消息并打印出来的消费者</p><p>在下图中，“ P” 是我们的生产者，“ C” 是我们的消费者。中间的框是一个队列 RabbitMQ 代表使用者保留的消息缓冲区</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/20-54-57-6e24c8d5786bcae1a58cbd1600ce5ef1-RabbitMQ-00000012-b7a6a7.png alt=RabbitMQ-00000012></p><p>连接的时候，需要开启 5672 端口</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/20-54-57-6dc50b5ebbeb7d6e50d22fa6d0c3a99b-image-20210626162052259-efde46.png alt=image-20210626162052259></p><h3 id=2-新建项目导入依赖><a href=#2-新建项目导入依赖 class=headerlink title="2. 新建项目导入依赖"></a>2. 新建项目导入依赖</h3><p>pom.xml</p><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre></td><td class=code><pre><span class=line><span class=comment>&lt;!--指定 jdk 编译版本--&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>build</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>plugins</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>plugin</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.maven.plugins<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>maven-compiler-plugin<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>configuration</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>source</span>&gt;</span>8<span class=tag>&lt;/<span class=name>source</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>target</span>&gt;</span>8<span class=tag>&lt;/<span class=name>target</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>plugin</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>plugins</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>build</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependencies</span>&gt;</span></span><br><span class=line>    <span class=comment>&lt;!--rabbitmq 依赖客户端--&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.rabbitmq<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>amqp-client<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>version</span>&gt;</span>5.8.0<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=comment>&lt;!--操作文件流的一个依赖--&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>commons-io<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>commons-io<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>version</span>&gt;</span>2.6<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id=3-Producer消息生产者><a href=#3-Producer消息生产者 class=headerlink title="3. Producer消息生产者"></a>3. Producer消息生产者</h3><p>编码过程参考RabbitMQ工作原理图：</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/21-00-36-9485f4e7fb4a1cca1026212a887eb349-image-20230509210036800-207b92.png alt=image-20230509210036800></p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br></pre></td><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@Author</span> yu</span></span><br><span class=line><span class=comment> * <span class=doctag>@Date</span> 2023/5/9 20:33</span></span><br><span class=line><span class=comment> * <span class=doctag>@Description</span>: 生产者：发送消息</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Producer</span> &#123;</span><br><span class=line>    <span class=comment>//队列</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String queue_name=<span class=string>&quot;Hello&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=comment>//发消息：</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> IOException, TimeoutException &#123;</span><br><span class=line>        <span class=comment>//1、创建一个连接工厂</span></span><br><span class=line>        ConnectionFactory factory=<span class=keyword>new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class=line>        <span class=comment>//2、设置工厂ip,连接rabbitMQ队列</span></span><br><span class=line>        factory.setHost(<span class=string>&quot;192.168.32.128&quot;</span>);</span><br><span class=line>        <span class=comment>//3、设置用户名</span></span><br><span class=line>        factory.setUsername(<span class=string>&quot;yu&quot;</span>);</span><br><span class=line>        <span class=comment>//4、设置密码</span></span><br><span class=line>        factory.setPassword(<span class=string>&quot;yu0804&quot;</span>);</span><br><span class=line>        <span class=comment>//5、创建连接</span></span><br><span class=line>        Connection connection=factory.newConnection();</span><br><span class=line>        <span class=comment>//6、获取信道</span></span><br><span class=line>        Channel channel=connection.createChannel();</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     *    7、产生一个队列（因为只是一个小demo，所以省略了交换机）</span></span><br><span class=line><span class=comment>     *      1.queue_name:队列名称</span></span><br><span class=line><span class=comment>     *      2.队列里面的消息是否持久化 也就是是否用完就删除</span></span><br><span class=line><span class=comment>     *      3.该队列是否只供一个消费者进行消费 是否进行共享; true 可以多个消费者消费</span></span><br><span class=line><span class=comment>     *      4.是否自动删除 最后一个消费者端开连接以后 该队列是否自动删除 true 自动删除</span></span><br><span class=line><span class=comment>     *      5.其他参数</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>        channel.queueDeclare(queue_name,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>null</span>);</span><br><span class=line>        <span class=comment>//8、发送的消息内容</span></span><br><span class=line>        String message=<span class=string>&quot;Hello,world!&quot;</span>;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment> *        9、发送一个消息</span></span><br><span class=line><span class=comment>     *      1.发送到那个交换机；所以省略了交换机</span></span><br><span class=line><span class=comment>     *      2.路由的 key 是哪个 routingKey</span></span><br><span class=line><span class=comment>     *      3.其他的参数信息</span></span><br><span class=line><span class=comment>     *      4.发送消息的消息体</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>        channel.basicPublish(<span class=string>&quot;&quot;</span>, queue_name, <span class=literal>null</span>, message.getBytes());</span><br><span class=line></span><br><span class=line>        System.out.println(<span class=string>&quot;消息发送完毕&quot;</span>);</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>拓展：</p><p>（1）channel.queueDeclare中各参数</p><ul><li>queue：队列名字，用于指定要创建的队列名称。</li><li>durable：是否持久化。如果设置为 true，则表示队列是一个持久化队列，即使 RabbitMQ 服务器重启或者崩溃，该队列也不会丢失。如果设置为 false，则表示队列是一个非持久化队列，在 RabbitMQ 服务器重新启动或崩溃时会丢失。</li><li>exclusive：是否为私有队列。如果设置为 true，则表示该队列只能被当前连接使用，其他连接无法访问该队列。如果设置为 false，则表示允许多个连接共享该队列。</li><li>autoDelete：是否自动删除。如果设置为 true，则表示当队列没有被任何消费者使用时，该队列会自动被删除。如果设置为 false，则表示队列不会自动删除，除非调用了相关 API 进行删除操作。</li><li>arguments：一些额外的参数配置。例如，可以设置队列消息的 TTL、队列的最大长度等参数来影响队列的行为。</li></ul><p>（2）channel.basicPublish中各参数</p><ul><li>exchange：交换机名称，用于将消息路由到不同的队列中。如果使用默认的交换机，则可以将该值设置为空字符串（””）。</li><li>routingKey：路由键，表示消息被发送到哪一个队列中。如果 exchange 不为空，那么这个值就是和 exchange 绑定的 queue 的 binding key。如果 exchange 为空，则实际上使用的是默认的 exchange，路由键就代表具体的队列名称。</li><li>mandatory：如果为 true，则表示消息无法通过路由规则找到对应的情况下，会发送给 Basic.Return 方法。如果为 false，则表示如果找不到匹配的队列，则直接丢弃消息。</li><li>immediate：如果为 true，则表示消息需要立即发送给匹配的队列，而不能存储到未被匹配的队列缓存中。如果为 false，则表示消息会进入到相应的队列等待消费者来处理。</li><li>props：消息属性，用于设置 AMQP.BasicProperties 类对象相关的参数。具体包括 content_type、content_encoding、delivery_mode、priority、correlation_id、reply_to、expiration、message_id、timestamp 和 type 等属性参数。</li><li>body：消息正文，用于存储需要传递的数据信息。例如，JSON 格式的字符串或二进制格式的字节流都可以作为 body 参数进行传递。</li></ul><p><strong>测试:</strong></p><p>（1）启动发送消息的main方法，可以在控制台中看到打印消息</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/21-12-50-8a80d78d9f9d246cdb6103ee7db7abbe-image-20230509211250322-c466c7.png alt=image-20230509211250322></p><p>（2）切换到浏览器RabbitMQ后台界面中，在”Queue”中可以看见”Hello”队列</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/21-17-29-14ea98475f7d9d39577031b7fcf11de5-image-20230509211729070-26653c.png alt=image-20230509211729070></p><p>(4) 点进队列中，可以看见一个消息在准备被消费，总共只有一个消息。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/21-19-17-720383887a920703ad7cae3159319e42-image-20230509211917192-7904e8.png alt=image-20230509211917192></p><p>问题：报错 Caused by: com.rabbitmq.client.ShutdownSignalException: connection error; protocol method: #method&lt;connection.close&gt;(reply-code&#x3D;530, reply-text&#x3D;NOT_ALLOWED - access to vhost ‘&#x2F;‘ refused for user ‘yu’, class-id&#x3D;10, method-id&#x3D;40)</p><p><a target=_blank rel=noopener href="https://blog.csdn.net/qq_45309297/article/details/106769303?ops_request_misc=&request_id=&biz_id=102&utm_term=Caused%20by:%20com.rabbitmq.client&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-106769303.142%5Ev86%5Einsert_down1,239%5Ev2%5Einsert_chatgpt&spm=1018.2226.3001.4187">解决方法</a></p><h3 id=4-Consumer消息消费者><a href=#4-Consumer消息消费者 class=headerlink title="4. Consumer消息消费者"></a>4. Consumer消息消费者</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br></pre></td><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@Author</span> yu</span></span><br><span class=line><span class=comment> * <span class=doctag>@Date</span> 2023/5/9 21:23</span></span><br><span class=line><span class=comment> * <span class=doctag>@Description</span>: 消费者：接收消息</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class=line>    <span class=comment>//队列</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String queue_name=<span class=string>&quot;Hello&quot;</span>;</span><br><span class=line>    <span class=comment>//接收消息</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> IOException, TimeoutException &#123;</span><br><span class=line>        <span class=type>ConnectionFactory</span> <span class=variable>factory</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class=line>        factory.setHost(<span class=string>&quot;19.168.32.128&quot;</span>);</span><br><span class=line>        factory.setUsername(<span class=string>&quot;yu&quot;</span>);</span><br><span class=line>        factory.setPassword(<span class=string>&quot;yu0804&quot;</span>);</span><br><span class=line></span><br><span class=line>        <span class=type>Connection</span> <span class=variable>connection</span> <span class=operator>=</span> factory.newConnection();</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> connection.createChannel();</span><br><span class=line></span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息.......&quot;</span>);</span><br><span class=line></span><br><span class=line>        <span class=comment>//推送的消息如何进行消费的接口回调</span></span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class=line>            System.out.println(message);</span><br><span class=line>        &#125;;</span><br><span class=line>        <span class=comment>//取消消费的一个回调接口 如在消费的时候队列被删除掉了</span></span><br><span class=line>        <span class=type>CancelCallback</span> <span class=variable>cancelCallback</span> <span class=operator>=</span> (consumerTag) -&gt; &#123;</span><br><span class=line>            System.out.println(<span class=string>&quot;消息消费被中断&quot;</span>);</span><br><span class=line>        &#125;;</span><br><span class=line></span><br><span class=line>        <span class=comment>/**</span></span><br><span class=line><span class=comment>         * 消费者消费消息 - 接受消息</span></span><br><span class=line><span class=comment>         * 1.消费哪个队列</span></span><br><span class=line><span class=comment>         * 2.消费成功之后是否要自动应答 true 代表自动应答 false 手动应答</span></span><br><span class=line><span class=comment>         * 3.消费者未成功消费的回调</span></span><br><span class=line><span class=comment>         * 4.消息被取消时的回调</span></span><br><span class=line><span class=comment>         */</span></span><br><span class=line>        channel.basicConsume(queue_name, <span class=literal>true</span>, deliverCallback, cancelCallback);</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>拓展：channel.basicConsume中各参数</p><ul><li>queue：队列名字，用于指定要订阅的队列名称。</li><li>autoAck：是否自动确认消息。如果设置为 true，则表示一旦收到该消息，RabbitMQ 服务器就会立即将该消息标记为已经被消费（从队列中删除）。如果设置为 false，则表示需要手动调用 channel.basicAck 方法来确认该消息。</li><li>consumerTag：用于标识该消费者，在取消订阅时需要使用到。</li><li>noLocal：不支持同一个连接中发送者和接收者使用同一个queueName；</li><li>exclusive：是否为私有队列。如果设置为 true，则表示该队列只能被当前连接使用，其他连接无法访问该队列。如果设置为 false，则表示允许多个连接共享该队列。</li><li>arguments：一些额外的参数配置。例如，可以设置队列消息的 TTL、队列的最大长度等参数来影响队列的行为。</li></ul><p>（1） DeliverCallback 是一个用于处理队列中投递的消息的回调函数。具体来说，当消费者成功的订阅了一个队列并准备接收其中的消息时，会通过 deliverCallback 回调函数返回收到的消息内容。通常可以将这个消息进行一些后续处理，例如保存到数据库或向特定的目的地址转发等。DeliverCallback 接口包含下面这个函数：</p><p>​ void handle(String consumerTag, Delivery message) throws IOException;</p><p>其中，consumerTag 表示管道和消费者之间的标识 id，而 Delivery 对象则表示 RabbitMQ 返回给消费者的消息。使用 Delivery 对象可以获取到消息的内容、元数据以及重要的 header 信息。 而在 deliveryCallback 中实现的处理方式，可以与具体的应用场景密切相关。</p><p>（2）cancelCallback 是一个取消消费的回调函数，用于在 driven 模式下实现将消费者取消订阅特定队列的操作。当消费者通过调用 channel.basicCancel() 取消订阅时（或者发生一些其他错误导致消费者被强制关闭），RabbitMQ 就会执行 cancelCallback 函数来通知消费端已经取消订阅该队列。cancelCallback 接口包含如下方法：</p><p>​ void handle(String consumerTag) throws IOException;</p><p>其中，consumerTag 表示管道和消费者之间的标识 id。在 handle 方法中可以实现对应的逻辑，例如释放相应资源、更新状态信息等。需要注意的是，如果消费者在处理消息时抛出异常，也会触发 cancelCallback 回调函数。</p><p><strong>测试：</strong></p><p>（1）启动接收消息的main方法，可以在控制台中看到打印消息。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/21-40-35-5b023f72d1d2d50760af3ec4e880463b-image-20230509214035027-ee5f37.png alt=image-20230509214035027></p><p>（2）在RabbitMQ后台界面的Queue中可以看到消息被消费。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/21-41-54-f51530fbe3023ea89f7263a9d48b6b09-image-20230509214154427-586e53.png alt=image-20230509214154427></p><h2 id=六、Work-Queue><a href=#六、Work-Queue class=headerlink title="六、Work Queue"></a>六、Work Queue</h2><p>Work Queue——工作队列(又称任务队列)，主要思想是避免立即执行资源密集型任务，而不得不等待他完成。相反我们安排任务在之后执行。我们把任务封装为消息并将其发送到队列。在后台执行的工作进程弹出任务并执行作业。当有多个工作线程时，这些工作线程将一起处理这些任务。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/21-57-30-fbb08a333df2db9f45598bdd24fdb51a-image-20230509215730457-5f01d2.png alt=image-20230509215730457></p><h3 id=1-轮训分发消息><a href=#1-轮训分发消息 class=headerlink title="1. 轮训分发消息"></a>1. 轮训分发消息</h3><p>在这个案例中我们会启动两个工作线程，一个消息发送线程，我们来看看他们两个工作线程是如何工作的。</p><h4 id=1-1-抽取工具类（代码demo2）><a href=#1-1-抽取工具类（代码demo2） class=headerlink title="1.1 抽取工具类（代码demo2）"></a>1.1 抽取工具类（代码demo2）</h4><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre></td><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@Author</span> yu</span></span><br><span class=line><span class=comment> * <span class=doctag>@Date</span> 2023/5/9 22:00</span></span><br><span class=line><span class=comment> * <span class=doctag>@Description</span>: 连接工厂创建信道的工具类</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">RabbitMQUtil</span> &#123;</span><br><span class=line>    <span class=comment>//得到一个连接的Channel</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> Channel <span class="title function_">getChannel</span><span class=params>()</span> <span class=keyword>throws</span> Exception&#123;</span><br><span class=line>        <span class=comment>//1、创建一个连接工厂</span></span><br><span class=line>        ConnectionFactory factory=<span class=keyword>new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class=line>        <span class=comment>//2、设置工厂ip,连接rabbitMQ队列</span></span><br><span class=line>        factory.setHost(<span class=string>&quot;192.168.32.128&quot;</span>);</span><br><span class=line>        <span class=comment>//3、设置用户名</span></span><br><span class=line>        factory.setUsername(<span class=string>&quot;yu&quot;</span>);</span><br><span class=line>        <span class=comment>//4、设置密码</span></span><br><span class=line>        factory.setPassword(<span class=string>&quot;yu0804&quot;</span>);</span><br><span class=line>        <span class=comment>//5、创建连接</span></span><br><span class=line>        Connection connection=factory.newConnection();</span><br><span class=line>        <span class=comment>//6、获取信道</span></span><br><span class=line>        Channel channel=connection.createChannel();</span><br><span class=line></span><br><span class=line>        <span class=keyword>return</span> channel;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h4 id=1-2-启动两个工作线程来接受消息><a href=#1-2-启动两个工作线程来接受消息 class=headerlink title="1.2 启动两个工作线程来接受消息"></a>1.2 启动两个工作线程来接受消息</h4><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre></td><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@Author</span> yu</span></span><br><span class=line><span class=comment> * <span class=doctag>@Date</span> 2023/5/9 22:05</span></span><br><span class=line><span class=comment> * <span class=doctag>@Description</span>: 这是一个工作线程，是相当于一个消费者</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Worker01</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>QUEUE_NAME</span> <span class=operator>=</span> <span class=string>&quot;hello&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line></span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line></span><br><span class=line>        <span class=comment>//消息接受</span></span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>receivedMessage</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class=line>            System.out.println(<span class=string>&quot;接收到消息:&quot;</span> + receivedMessage);</span><br><span class=line>        &#125;;</span><br><span class=line>        <span class=comment>//消息被取消</span></span><br><span class=line>        <span class=type>CancelCallback</span> <span class=variable>cancelCallback</span> <span class=operator>=</span> (consumerTag) -&gt; &#123;</span><br><span class=line>            System.out.println(consumerTag + <span class=string>&quot;消费者取消消费接口回调逻辑&quot;</span>);</span><br><span class=line></span><br><span class=line>        &#125;;</span><br><span class=line></span><br><span class=line>        System.out.println(<span class=string>&quot;C1 消费者启动等待消费.................. &quot;</span>);</span><br><span class=line>        channel.basicConsume(QUEUE_NAME, <span class=literal>true</span>, deliverCallback, cancelCallback);</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>为了达到预期效果，我们必须要准备两个以上的工作线程，来体现每个线程之间是竞争关系，一个消息只能被消费一次。</p><p>(1) 先启动C1线程，在idea配置中勾选如下</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/22-22-09-8dfa2ebe9f42d39b20abf31d1c57992e-image-20230509222209782-7b84ef.png alt=image-20230509222209782></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/22-24-01-d24c45b86784638637cb3e2fb75354fb-image-20230509222401677-881f14.png alt=image-20230509222401677></p><p>(2) 将C1改为C2，再次启动，此时就有两个线程了</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/22-25-11-65df7ce771731977e14c212f13c83786-image-20230509222511696-2e56c6.png alt=image-20230509222511696></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/22-26-40-1ad2308ceda3cafcc1d30cbc49665881-image-20230509222640740-8d40c3.png alt=image-20230509222640740></p><p>（3）接着就是写一个生产者来发送大量发送消息，C1和C2轮询接收消息。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre></td><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@Author</span> yu</span></span><br><span class=line><span class=comment> * <span class=doctag>@Date</span> 2023/5/9 20:33</span></span><br><span class=line><span class=comment> * <span class=doctag>@Description</span>: 生产者：发送消息</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">ProducerTask</span> &#123;</span><br><span class=line>    <span class=comment>//队列</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String QUEUE_NAME=<span class=string>&quot;Hello&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=comment>//发消息：参考rabbitMQ工作原理图</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        Channel channel= RabbitMQUtil.getChannel();</span><br><span class=line>        channel.queueDeclare(QUEUE_NAME,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>null</span>);</span><br><span class=line></span><br><span class=line>        <span class=comment>//8、发送的消息内容</span></span><br><span class=line>        <span class=type>Scanner</span> <span class=variable>scanner</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class=line>        <span class=keyword>while</span> ((scanner.hasNext()))&#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> scanner.next();</span><br><span class=line>            <span class=comment>//发送消息</span></span><br><span class=line>            channel.basicPublish(<span class=string>&quot;&quot;</span>, QUEUE_NAME, <span class=literal>null</span>, message.getBytes());</span><br><span class=line>            System.out.println(<span class=string>&quot;消息发送完毕&quot;</span>+message);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>(4) 启动消息生产者发送消息，在控制台依次发送消息。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/22-43-45-937e39e47b6eaa542b4c23330668c0ff-image-20230509224345773-461d4d.png alt=image-20230509224345773></p><p>观察C1线程和C2线程</p><p>C1：</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/22-44-01-39541030b40e364e0e538b2432935b55-image-20230509224401289-4a56ec.png alt=image-20230509224401289></p><p>C2：</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/09/22-44-14-47e7d91ebe9142a57d71750ac30b5f42-image-20230509224414733-c5ec8c.png alt=image-20230509224414733></p><p>通过程序执行发现生产者总共发送 4 个消息，消费者 1 和消费者 2 分别分得两个消息，并且是按照有序的一个接收一次消息</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/10/10-30-50-80010347b319b6e66ba99a99ad8e0230-image-20230510103042964-e3bb12.png alt=image-20230510103042964></p><h2 id=七、消息应答><a href=#七、消息应答 class=headerlink title=七、消息应答></a>七、消息应答</h2><h3 id=1-概念><a href=#1-概念 class=headerlink title="1. 概念"></a>1. 概念</h3><p>消费者完成一个任务可能需要一段时间，如果其中一个消费者处理一个长的任务并仅只完成了一部分，突然挂掉，会发生什么情况。RabbitMQ一旦向消费者传递了一条消息，便立即将该消息标记为删除。在这种情况下，突然有一个消费者挂掉了，我们将丢失正在处理的消息。以及后续发送给该消费者的消息，因为他无法接收到。</p><p>为了保证消息在发送过程中不丢失，引入消息应答机制，消息应答就是：<strong>消费者在接收到消息处理该消息之后，告诉rabbitMQ 他已经处理了，rabbitMQ就可以把该消息删除了。</strong></p><h3 id=2-自动应答><a href=#2-自动应答 class=headerlink title="2. 自动应答"></a>2. 自动应答</h3><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/10/11-00-04-8f2a11dae0f0a30bb20514432eae93f3-10-59-57-8f2a11dae0f0a30bb20514432eae93f3-10-57-50-8f2a11dae0f0a30bb20514432eae93f3-image-20230510105749960-73a6c3-ea9f65-ec23e2.png></p><p>在上述案例中，我们在消费中使用的是自动应答模式，在使用自动应答过程中会出现一些问题：</p><p>消息发送成功后立即被认为已经传送成功，这种模式需要在<strong>高吞吐量和数据传输安全性方面做到权衡</strong>。因为这种模式如果消息在接收到之前，消费者那边出现连接或者channel关闭，那么消息就丢失了。当然另一方面这种模式消费者那边可以传递过载消息，<strong>没有对传递者的消息数量进行限制</strong>，当然这样有可能使得消费者这边由于接收太多还来不及处理的消息，导致这些消息的积压，最终使得内存耗尽，这些消费者线程被操作系统杀死，<strong>所以这种模式仅适用在消费者可以高效并以某种速率能够处理这些消息的情况下使用。</strong></p><p>(很少使用，需要在良好环境的前提下使用。)</p><h3 id=3-手动应答的方式><a href=#3-手动应答的方式 class=headerlink title="3. 手动应答的方式"></a>3. 手动应答的方式</h3><ul><li><p>Channel.basicAck(用于肯定确认)</p><p>RabbitMQ 已知道该消息并且成功的处理消息，可以将其丢弃了</p></li><li><p>Channel.basicNack(用于否定确认)</p></li><li><p>Channel.basicReject(用于否定确认)</p><p>与 Channel.basicNack 相比少一个参数，不处理该消息了直接拒绝，可以将其丢弃了</p></li></ul><p><strong>Multiple 的解释：</strong></p><p>手动应答的好处是可以批量应答并且减少网络拥堵</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/10/10-53-43-1f8f0da6e8b3c4e957a4fe09c8dfa4a4-image-20230510105343856-f2761b.png alt=image-20230510105343856></p><p>multiple 的 true 和 false 代表的不同含义：</p><ul><li>true 代表批量应答 channel 上未应答的消息。比如 channel 上传输有 tag 的消息 5,6,7,8。当前 tag 是 8 那么此时 5-8 的这些还未应答的消息都会被确认收到消息应答</li><li>false 同上面相比。只会应答 tag &#x3D; 8 的消息，5,6,7 这三个消息依然不会被确认收到消息应答。</li></ul><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/19-42-31-8c358b33ce1f78612f0a1c8ac37e5673-image-20230515194231687-480d15.png alt=image-20230515194231687></p><h3 id=4-消息自动重新入队><a href=#4-消息自动重新入队 class=headerlink title="4. 消息自动重新入队"></a>4. 消息自动重新入队</h3><p>如果消费者由于某些原因失去连接（其通道已经关闭，连接关闭或者TCP连接丢失），导致消息未发送ACK确认，RabbitMQj将了解到消息未完全处理，并将对其重新排队。如果此时其他消费者可以处理，他讲很快重新分发给另一个消费者。这样，即使某个消费者偶尔死亡，也可以确保不会丢失任何消息。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/19-47-37-0c408491c2b828381991ec688e71ea53-image-20230515194737737-dd7354.png alt=image-20230515194737737></p><h3 id=5-消息手动应答代码（代码demo3）><a href=#5-消息手动应答代码（代码demo3） class=headerlink title="5. 消息手动应答代码（代码demo3）"></a>5. 消息手动应答代码（代码demo3）</h3><p>默认采用的是自动应答，所以我们要想实现消息消费过程中不丢失，需要把自动应答改为手动应答</p><blockquote><p>代码预期效果：一个生产者，两个工作线程。模拟场景：将一个工作线程关闭(该线程并未执行完)，确保消息不能丢失，将消息放回对队列，被另外一个工作线程处理(重新消费）。</p></blockquote><p>生产者：</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Producer3</span> &#123;</span><br><span class=line>    <span class=comment>//队列</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String TASK_QUEUE_NAME=<span class=string>&quot;ACK_QUEUE&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=comment>//发消息：参考rabbitMQ工作原理图</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=comment>//连接</span></span><br><span class=line>        Channel channel= RabbitMQUtil.getChannel();</span><br><span class=line></span><br><span class=line>        <span class=comment>//创建队列</span></span><br><span class=line>        channel.queueDeclare(TASK_QUEUE_NAME,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>null</span>);</span><br><span class=line></span><br><span class=line>        <span class=comment>//控制台输入消息</span></span><br><span class=line>        <span class=type>Scanner</span> <span class=variable>scanner</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class=line>        <span class=keyword>while</span> ((scanner.hasNext()))&#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> scanner.next();</span><br><span class=line>            <span class=comment>//发布消息</span></span><br><span class=line>            channel.basicPublish(<span class=string>&quot;&quot;</span>, TASK_QUEUE_NAME, <span class=literal>null</span>, message.getBytes(<span class=string>&quot;UTF-8&quot;</span>));</span><br><span class=line>            System.out.println(<span class=string>&quot;消息发送完毕&quot;</span>+message);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>工作线程C1(消费者C1)：</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Demo3Worker01</span> &#123;</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String TASK_QUEUE_NAME=<span class=string>&quot;ACK_QUEUE&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line></span><br><span class=line>        <span class=comment>//连接</span></span><br><span class=line>        Channel channel= RabbitMQUtil.getChannel();</span><br><span class=line></span><br><span class=line>        System.out.println(<span class=string>&quot;C1等待消息处理时间较短&quot;</span>);</span><br><span class=line></span><br><span class=line>        <span class=comment>//消息接受</span></span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=comment>//沉睡1秒</span></span><br><span class=line>            SleepUtil.Sleep(<span class=number>1</span>);</span><br><span class=line>            <span class=type>String</span> <span class=variable>receivedMessage</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(),<span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot;接收到消息:&quot;</span> + receivedMessage);</span><br><span class=line>            <span class=comment>//手动应答</span></span><br><span class=line>            <span class=comment>/**</span></span><br><span class=line><span class=comment>             * 1.消息标记 tag</span></span><br><span class=line><span class=comment>             * 2.是否批量应答未应答消息 false:表示不批量处理(批量应答可能出现消息丢失，最好是对消息处理一次应答一次)</span></span><br><span class=line><span class=comment>             */</span></span><br><span class=line>            channel.basicAck(delivery.getEnvelope().getDeliveryTag(),<span class=literal>false</span>);</span><br><span class=line>        &#125;;</span><br><span class=line>        <span class=comment>//消息被取消</span></span><br><span class=line>        <span class=type>CancelCallback</span> <span class=variable>cancelCallback</span> <span class=operator>=</span> (consumerTag) -&gt; &#123;</span><br><span class=line>            System.out.println(consumerTag + <span class=string>&quot;消费者取消消费接口回调逻辑&quot;</span>);</span><br><span class=line></span><br><span class=line>        &#125;;</span><br><span class=line></span><br><span class=line>        <span class=comment>//采用手动应答</span></span><br><span class=line>        <span class=type>boolean</span> <span class=variable>autoAck</span> <span class=operator>=</span> <span class=literal>false</span>;</span><br><span class=line>        System.out.println(<span class=string>&quot;C2 消费者启动等待消费.................. &quot;</span>);</span><br><span class=line>        channel.basicConsume(TASK_QUEUE_NAME, autoAck, deliverCallback, cancelCallback);</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>工作线程C2(消费者C2)：</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Demo3Worker02</span> &#123;</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String TASK_QUEUE_NAME=<span class=string>&quot;ACK_QUEUE&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line></span><br><span class=line>        <span class=comment>//连接</span></span><br><span class=line>        Channel channel= RabbitMQUtil.getChannel();</span><br><span class=line></span><br><span class=line>        System.out.println(<span class=string>&quot;C2等待消息处理时间较长&quot;</span>);</span><br><span class=line></span><br><span class=line>        <span class=comment>//消息接受</span></span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=comment>//沉睡30 秒</span></span><br><span class=line>            SleepUtil.Sleep(<span class=number>10</span>);</span><br><span class=line>            <span class=type>String</span> <span class=variable>receivedMessage</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(),<span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot;接收到消息:&quot;</span> + receivedMessage);</span><br><span class=line>            <span class=comment>//手动应答</span></span><br><span class=line>            <span class=comment>/**</span></span><br><span class=line><span class=comment>             * 1.消息标记 tag</span></span><br><span class=line><span class=comment>             * 2.是否批量应答未应答消息 false:表示不批量处理(批量应答可能出现消息丢失，最好是对消息处理一次应答一次)</span></span><br><span class=line><span class=comment>             */</span></span><br><span class=line>            channel.basicAck(delivery.getEnvelope().getDeliveryTag(),<span class=literal>false</span>);</span><br><span class=line>        &#125;;</span><br><span class=line>        <span class=comment>//消息被取消</span></span><br><span class=line>        <span class=type>CancelCallback</span> <span class=variable>cancelCallback</span> <span class=operator>=</span> (consumerTag) -&gt; &#123;</span><br><span class=line>            System.out.println(consumerTag + <span class=string>&quot;消费者取消消费接口回调逻辑&quot;</span>);</span><br><span class=line></span><br><span class=line>        &#125;;</span><br><span class=line></span><br><span class=line>        <span class=comment>//采用手动应答</span></span><br><span class=line>        <span class=type>boolean</span> <span class=variable>autoAck</span> <span class=operator>=</span> <span class=literal>false</span>;</span><br><span class=line>        System.out.println(<span class=string>&quot;C2 消费者启动等待消费.................. &quot;</span>);</span><br><span class=line>        channel.basicConsume(TASK_QUEUE_NAME, autoAck, deliverCallback, cancelCallback);</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>从代码中我们可以看出C1处理消息是比较快的(SleepUtil.Sleep(1))，C2处理消息很慢(SleepUtil.Sleep(10))，我们希望看到的是：C2处理过程中出现问题(比如宕机)，C1能继续处理C2未处理成功的消息(消息未被成功处理后被放回队列)。</p><p>测试：分别启动生产者和两个线程，生产者一次发出消息aa、bb、cc、dd；正常情况是C1和C2两个线程轮询处理消息，即：C1收到消息 aa、cc；C2收到消息 bb、dd。为了达到预期效果，我们在生产者发送第四次消息后关闭C2线程（10S内完成），这时mq将C2未处理的消息dd放回队列，让C1线程来处理，即：1收到消息 aa、cc、dd；C2只收到消息 bb。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/21-13-00-054f579d58fe53ea9564c7f354c39efe-image-20230515211300771-4feaa8.png alt=image-20230515211300771></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/21-14-12-ecf94d800945870296f5cc9c10e9c724-image-20230515211412802-ecfa9c.png alt=image-20230515211412802></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/15/21-15-32-76c13feeb9930af2b546198842ea9196-image-20230515211532374-2a1534.png alt=image-20230515211532374></p><h2 id=八、RabbitMQ-持久化><a href=#八、RabbitMQ-持久化 class=headerlink title="八、RabbitMQ 持久化"></a>八、RabbitMQ 持久化</h2><blockquote><p>当 RabbitMQ 服务停掉以后，消息生产者发送过来的消息不丢失要如何保障？默认情况下 RabbitMQ 退出或由于某种原因崩溃时，它忽视队列和消息，除非告知它不要这样做。确保消息不会丢失需要做两件事：<strong>我们需要将队列和消息都标记为持久化。</strong></p></blockquote><h3 id=1-队列持久化><a href=#1-队列持久化 class=headerlink title="1. 队列持久化"></a>1. 队列持久化</h3><p>之前我们创建的队列都是非持久化的，rabbitmq 如果重启的话，该队列就会被删除掉，如果要队列实现持久化需要在声明队列的时候把 durable 参数设置为持久化。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment>//让队列持久化</span></span><br><span class=line><span class=type>boolean</span> <span class=variable>durable</span> <span class=operator>=</span> <span class=literal>true</span>;</span><br><span class=line><span class=comment>//声明队列</span></span><br><span class=line>channel.queueDeclare(TASK_QUEUE_NAME, durable, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>null</span>);</span><br></pre></td></tr></table></figure><blockquote><p>注意：如果之前声明的队列不是持久化的，需要把原先队列先删除，或者重新创建一个持久化的队列，不然就会出现错误</p></blockquote><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-08-33-b50627728f8f2b7393ed73a700a06409-image-20230517200833594-827c0c.png alt=image-20230517200833594></p><p>以下为控制台中持久化与非持久化队列的 UI 显示区、</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-08-48-50fb885a372f45e084d966093aa1ed40-image-20230517200848161-61ea1c.png alt=image-20230517200848161></p><h3 id=2-消息实现持久化><a href=#2-消息实现持久化 class=headerlink title="2. 消息实现持久化"></a>2. 消息实现持久化</h3><p>需要在消息<strong>生产者</strong>修改代码，<code>MessageProperties.PERSISTENT_TEXT_PLAIN</code> 添加这个属性。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-09-47-8772f8dce8f08d6298623405ca0044fc-image-20230517200947912-911231.png alt=image-20230517200947912></p><p>将消息标记为持久化并不能<strong>完全保证不会丢失消息</strong>。尽管它告诉 RabbitMQ 将消息保存到磁盘，但是这里依然存在当消息刚准备存储在磁盘的时候 但是还没有存储完，消息还在缓存的一个间隔点。此时并没 有真正写入磁盘。持久性保证并不强，但是对于我们的简单任务队列而言，这已经绰绰有余了。</p><p>如果需要更强有力的持久化策略，参考后边课件发布确认章节。</p><h2 id=九、不公平分发><a href=#九、不公平分发 class=headerlink title=九、不公平分发></a>九、不公平分发</h2><p>在最开始的时候我们学习到 RabbitMQ 分发消息采用的轮训分发，但是在某种场景下这种策略并不是很好，比方说有两个消费者在处理任务，其中有个<strong>消费者 1</strong> 处理任务的速度非常快，而另外一个<strong>消费者 2</strong> 处理速度却很慢，这个时候我们还是采用轮训分发的化就会到这处理速度快的这个消费者很大一部分时间处于空闲状态，而处理慢的那个消费者一直在干活，这种分配方式在这种情况下其实就不太好，但是 RabbitMQ 并不知道这种情况它依然很公平的进行分发。</p><p>为了避免这种情况，<strong>在消费者中消费之前</strong>，我们可以设置参数 <code>channel.basicQos(1);</code></p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line><span class=comment>//不公平分发</span></span><br><span class=line><span class=type>int</span> <span class=variable>prefetchCount</span> <span class=operator>=</span> <span class=number>1</span>;</span><br><span class=line>channel.basicQos(prefetchCount);</span><br><span class=line><span class=comment>//采用手动应答</span></span><br><span class=line><span class=type>boolean</span> <span class=variable>autoAck</span> <span class=operator>=</span> <span class=literal>false</span>;</span><br><span class=line>channel.basicConsume(TASK_QUEUE_NAME, autoAck, deliverCallback, cancelCallback);</span><br></pre></td></tr></table></figure><p>效果<img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-43-35-2168d84ee4e04b5d6e3eef042967c0c5-image-20230517204335332-66b833.png alt=image-20230517204335332><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-43-52-ec9693f511cc4dd9dc810c19d29d55f0-image-20230517204351927-534190.png alt=image-20230517204351927><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-44-02-b2bc8a4546dc6a345c395884ee894ca3-image-20230517204402145-f98064.png alt=image-20230517204402145></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-12-13-d58a510084b6bba5bce900bc77eac2fe-image-20230517201212925-283f5e.png alt=image-20230517201212925></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-12-37-39a74d4d9bc13a4f6b68cde344e7560f-20-12-31-39a74d4d9bc13a4f6b68cde344e7560f-image-20230517201231861-9e1d45-5e92ac.png></p><p>意思就是如果这个任务我还没有处理完或者我还没有应答你，你先别分配给我，我目前只能处理一个 任务，然后 rabbitmq 就会把该任务分配给没有那么忙的那个空闲消费者，当然如果所有的消费者都没有完 成手上任务，队列还在不停的添加新任务，队列有可能就会遇到队列被撑满的情况，这个时候就只能添加 新的 worker 或者改变其他存储任务的策略。</p><h2 id=十、预取值分发><a href=#十、预取值分发 class=headerlink title=十、预取值分发></a>十、预取值分发</h2><p>带权的消息分发，如下图：生产者发送7条消息，我们希望消费者C1只接收2条，消费者C2接收5条。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-49-29-fdc3fdc69927978c59985088e35cb7b6-image-20230517204929339-7f10b1.png alt=image-20230517204929339></p><p>本身消息的发送就是异步发送的，所以在任何时候，channel 上肯定不止只有一个消息另外来自消费 者的手动确认本质上也是异步的。因此这里就存在一个未确认的消息缓冲区，因此希望开发人员能<strong>限制此缓冲区的大小</strong>，<strong>以避免缓冲区里面无限制的未确认消息问题</strong>。这个时候就可以通过使用 basic.qos 方法设 置“预取计数”值来完成的。</p><p>该值定义通道上允许的未确认消息的最大数量。一旦数量达到配置的数量， RabbitMQ 将停止在通道上传递更多消息，除非至少有一个未处理的消息被确认，例如，假设在通道上有未确认的消息 5、6、7，8，并且通道的预取计数设置为 4，此时RabbitMQ 将不会在该通道上再传递任何消息，除非至少有一个未应答的消息被 ack。比方说 tag&#x3D;6 这个消息刚刚被确认 ACK，RabbitMQ 将会感知 这个情况到并再发送一条消息。消息应答和 QoS 预取值对用户吞吐量有重大影响。</p><p>通常，增加预取将提高 向消费者传递消息的速度。<strong>虽然自动应答传输消息速率是最佳的，但是，在这种情况下已传递但尚未处理的消息的数量也会增加，从而增加了消费者的 RAM 消耗</strong>(随机存取存储器)应该小心使用具有无限预处理的自动确认模式或手动确认模式，消费者消费了大量的消息如果没有确认的话，会导致消费者连接节点的 内存消耗变大，所以找到合适的预取值是一个反复试验的过程，不同的负载该值取值也不同 100 到 300 范 围内的值通常可提供最佳的吞吐量，并且不会给消费者带来太大的风险。</p><p>预取值为 1 是最保守的。当然这将使吞吐量变得很低，特别是消费者连接延迟很严重的情况下，特别是在消费者连接等待时间较长的环境 中。对于大多数应用来说，稍微高一点的值将是最佳的。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/17/20-13-53-b21de99e7f9cb0c2bc9c2fdbe1b16bde-image-20230517201353182-df4fda.png alt=image-20230517201353182></p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=comment>//不公平分发 prefetchCount=1</span></span><br><span class=line><span class=comment>//预取值为2 prefetchCount=2</span></span><br><span class=line><span class=comment>//预取值为5 prefetchCount=5</span></span><br><span class=line><span class=type>int</span> <span class=variable>prefetchCount</span> <span class=operator>=</span> <span class=number>5</span>;</span><br><span class=line>channel.basicQos(prefetchCount);</span><br><span class=line><span class=comment>//采用手动应答</span></span><br><span class=line><span class=type>boolean</span> <span class=variable>autoAck</span> <span class=operator>=</span> <span class=literal>false</span>;</span><br><span class=line>channel.basicConsume(TASK_QUEUE_NAME, autoAck, deliverCallback, cancelCallback);</span><br></pre></td></tr></table></figure></article><div class=post-copyright><div class=post-copyright__title><span class=post-copyright-info><h>RabbtMQ教程一</h></span></div><div class=post-copyright__type><span class=post-copyright-info><a href="https://yuydot.gitee.io/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/">https://yuydot.gitee.io/2023/05/09/RabbtMQ教程一/</a></span></div><div class=post-copyright-m><div class=post-copyright-m-info><div class=post-copyright-a><h>作者</h><div class=post-copyright-cc-info><h>yuydot</h></div></div><div class=post-copyright-c><h>发布于</h><div class=post-copyright-cc-info><h>2023-05-09</h></div></div><div class=post-copyright-u><h>更新于</h><div class=post-copyright-cc-info><h>2023-05-21</h></div></div><div class=post-copyright-c><h>许可协议</h><div class=post-copyright-cc-info><a class=icon rel=noopener target=_blank title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel=noopener target=_blank title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href="/tags/RabbitMQ/">RabbitMQ</a></div><div class=post_share><div class=social-share data-image=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css media=print onload="this.media='all'"><script src=https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js defer></script></div></div><nav class=pagination-post id=pagination><div class="prev-post pull-left"><a href="/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/" title=RabbtMQ教程二><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-zygeko_2560x1601.png onerror="onerror=null;src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt="cover of previous post"><div class=pagination-info><div class=label>上一篇</div><div class=prev_info>RabbtMQ教程二</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/06/MySQL%E8%BF%9B%E9%98%B6/" title=MySQL进阶><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png onerror="onerror=null;src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt="cover of next post"><div class=pagination-info><div class=label>下一篇</div><div class=next_info>MySQL进阶</div></div></a></div></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class=relatedPosts-list><div><a href="/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/" title=RabbtMQ教程二><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-zygeko_2560x1601.png alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2023-05-17</div><div class=title>RabbtMQ教程二</div></div></a></div></div></div><hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span>评论</span></div></div><div class=comment-wrap><div><div class=vcomment id=vcomment></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info"><div class=is-center><div class=avatar-img><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wang.jpg onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/friend_404.gif'" alt=avatar></div><div class=author-info__name>yuydot</div><div class=author-info__description>好像稍不努力，连快乐都养不起</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class=headline>文章</div><div class=length-num>19</div></a><a href="/tags/"><div class=headline>标签</div><div class=length-num>10</div></a><a href="/categories/"><div class=headline>分类</div><div class=length-num>5</div></a></div><a id=card-info-btn target=_blank rel=noopener href=https://github.com/Yuydot><i class="fab fa-github"></i><span>Follow Me</span><i class="faa-passing animated" style=padding-left:20px;display:inline-block;vertical-align:middle;><svg class=icon style=height:28px;width:28px;fill:currentColor;position:relative;top:5px><use xlink:href=#icon-xiaoqiche></use></svg></i></a><div class="card-info-social-icons is-center"><a class=social-icon href=https://github.com/Yuydot target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:1586488524@qq.com target=_blank title=Email><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class=announcement_content>This is my Blog <img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C.gif height=200 width=236></div><div id=welcome-info></div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>目录</span><span class=toc-percentage></span></div><div class=toc-content><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%80%E3%80%81MQ-%E7%9A%84%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5><span class=toc-number>1.</span> <span class=toc-text>一、MQ 的相关概念</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-%E4%BB%80%E4%B9%88%E6%98%AFMQ><span class=toc-number>1.1.</span> <span class=toc-text>1. 什么是MQ</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8MQ><span class=toc-number>1.2.</span> <span class=toc-text>2. 为什么要用MQ</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#3-MQ-%E7%9A%84%E5%88%86%E7%B1%BB><span class=toc-number>1.3.</span> <span class=toc-text>3. MQ 的分类</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#4-MQ-%E7%9A%84%E9%80%89%E6%8B%A9><span class=toc-number>1.4.</span> <span class=toc-text>4. MQ 的选择</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%BA%8C%E3%80%81RabbitMQ><span class=toc-number>2.</span> <span class=toc-text>二、RabbitMQ</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-RabbitMQ-%E7%9A%84%E6%A6%82%E5%BF%B5><span class=toc-number>2.1.</span> <span class=toc-text>1. RabbitMQ 的概念</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#2-%E5%9B%9B%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5><span class=toc-number>2.2.</span> <span class=toc-text>2. 四大核心概念</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#3-RabbitMQ%E7%9A%84%E6%A0%B8%E5%BF%83%E9%83%A8%E5%88%86><span class=toc-number>2.3.</span> <span class=toc-text>3. RabbitMQ的核心部分</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#4-%E5%90%84%E4%B8%AA%E5%90%8D%E8%AF%8D%E4%BB%8B%E7%BB%8D><span class=toc-number>2.4.</span> <span class=toc-text>4. 各个名词介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%89%E3%80%81RabbitMQ%E5%AE%89%E8%A3%85><span class=toc-number>3.</span> <span class=toc-text>三、RabbitMQ安装</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-Linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%AE%89%E8%A3%85RabbitMQ><span class=toc-number>3.1.</span> <span class=toc-text>1. Linux环境下安装RabbitMQ</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#1-1-%E4%B8%8B%E8%BD%BD><span class=toc-number>3.1.1.</span> <span class=toc-text>1.1 下载</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#1-2-%E5%AE%89%E8%A3%85><span class=toc-number>3.1.2.</span> <span class=toc-text>1.2 安装</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#1-3-%E5%90%AF%E5%8A%A8><span class=toc-number>3.1.3.</span> <span class=toc-text>1.3 启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#2-Web%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2%E5%8F%8A%E6%8E%88%E6%9D%83%E6%93%8D%E4%BD%9C><span class=toc-number>3.2.</span> <span class=toc-text>2. Web管理界面及授权操作</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#2-1-%E5%AE%89%E8%A3%85><span class=toc-number>3.2.1.</span> <span class=toc-text>2.1 安装</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#2-2-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7><span class=toc-number>3.2.2.</span> <span class=toc-text>2.2 添加用户</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%9B%9B%E3%80%81Docker-%E5%AE%89%E8%A3%85><span class=toc-number>4.</span> <span class=toc-text>四、Docker 安装</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%BA%94%E3%80%81HelloWorld><span class=toc-number>5.</span> <span class=toc-text>五、HelloWorld</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-%E5%87%86%E5%A4%87%EF%BC%88%E4%BB%A3%E7%A0%81demo1%EF%BC%89><span class=toc-number>5.1.</span> <span class=toc-text>1. 准备（代码demo1）</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#2-%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96><span class=toc-number>5.2.</span> <span class=toc-text>2. 新建项目导入依赖</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#3-Producer%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85><span class=toc-number>5.3.</span> <span class=toc-text>3. Producer消息生产者</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#4-Consumer%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%80%85><span class=toc-number>5.4.</span> <span class=toc-text>4. Consumer消息消费者</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%85%AD%E3%80%81Work-Queue><span class=toc-number>6.</span> <span class=toc-text>六、Work Queue</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-%E8%BD%AE%E8%AE%AD%E5%88%86%E5%8F%91%E6%B6%88%E6%81%AF><span class=toc-number>6.1.</span> <span class=toc-text>1. 轮训分发消息</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#1-1-%E6%8A%BD%E5%8F%96%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%88%E4%BB%A3%E7%A0%81demo2%EF%BC%89><span class=toc-number>6.1.1.</span> <span class=toc-text>1.1 抽取工具类（代码demo2）</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#1-2-%E5%90%AF%E5%8A%A8%E4%B8%A4%E4%B8%AA%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B%E6%9D%A5%E6%8E%A5%E5%8F%97%E6%B6%88%E6%81%AF><span class=toc-number>6.1.2.</span> <span class=toc-text>1.2 启动两个工作线程来接受消息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%83%E3%80%81%E6%B6%88%E6%81%AF%E5%BA%94%E7%AD%94><span class=toc-number>7.</span> <span class=toc-text>七、消息应答</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-%E6%A6%82%E5%BF%B5><span class=toc-number>7.1.</span> <span class=toc-text>1. 概念</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#2-%E8%87%AA%E5%8A%A8%E5%BA%94%E7%AD%94><span class=toc-number>7.2.</span> <span class=toc-text>2. 自动应答</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#3-%E6%89%8B%E5%8A%A8%E5%BA%94%E7%AD%94%E7%9A%84%E6%96%B9%E5%BC%8F><span class=toc-number>7.3.</span> <span class=toc-text>3. 手动应答的方式</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#4-%E6%B6%88%E6%81%AF%E8%87%AA%E5%8A%A8%E9%87%8D%E6%96%B0%E5%85%A5%E9%98%9F><span class=toc-number>7.4.</span> <span class=toc-text>4. 消息自动重新入队</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#5-%E6%B6%88%E6%81%AF%E6%89%8B%E5%8A%A8%E5%BA%94%E7%AD%94%E4%BB%A3%E7%A0%81%EF%BC%88%E4%BB%A3%E7%A0%81demo3%EF%BC%89><span class=toc-number>7.5.</span> <span class=toc-text>5. 消息手动应答代码（代码demo3）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%85%AB%E3%80%81RabbitMQ-%E6%8C%81%E4%B9%85%E5%8C%96><span class=toc-number>8.</span> <span class=toc-text>八、RabbitMQ 持久化</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-%E9%98%9F%E5%88%97%E6%8C%81%E4%B9%85%E5%8C%96><span class=toc-number>8.1.</span> <span class=toc-text>1. 队列持久化</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#2-%E6%B6%88%E6%81%AF%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96><span class=toc-number>8.2.</span> <span class=toc-text>2. 消息实现持久化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B9%9D%E3%80%81%E4%B8%8D%E5%85%AC%E5%B9%B3%E5%88%86%E5%8F%91><span class=toc-number>9.</span> <span class=toc-text>九、不公平分发</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%8D%81%E3%80%81%E9%A2%84%E5%8F%96%E5%80%BC%E5%88%86%E5%8F%91><span class=toc-number>10.</span> <span class=toc-text>十、预取值分发</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>最新文章</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href="/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/" title=RabbtMQ教程二><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-zygeko_2560x1601.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=RabbtMQ教程二></a><div class=content><a class=title href="/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/" title=RabbtMQ教程二>RabbtMQ教程二</a><time datetime=2023-05-17T13:04:40.000Z title="发表于 2023-05-17 21:04:40">2023-05-17</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/" title=RabbtMQ教程一><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=RabbtMQ教程一></a><div class=content><a class=title href="/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/" title=RabbtMQ教程一>RabbtMQ教程一</a><time datetime=2023-05-09T11:51:28.000Z title="发表于 2023-05-09 19:51:28">2023-05-09</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/05/06/MySQL%E8%BF%9B%E9%98%B6/" title=MySQL进阶><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=MySQL进阶></a><div class=content><a class=title href="/2023/05/06/MySQL%E8%BF%9B%E9%98%B6/" title=MySQL进阶>MySQL进阶</a><time datetime=2023-05-06T02:23:18.000Z title="发表于 2023-05-06 10:23:18">2023-05-06</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/05/04/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/" title=Redis分布式缓存><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-73e7me_2560x1600.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=Redis分布式缓存></a><div class=content><a class=title href="/2023/05/04/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/" title=Redis分布式缓存>Redis分布式缓存</a><time datetime=2023-05-04T08:58:45.000Z title="发表于 2023-05-04 16:58:45">2023-05-04</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/04/19/Mapstruct%E5%B7%A5%E5%85%B7/" title=Mapstruct工具><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/502997c6c932d8f8028954ee7fb88d2c.jpg onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=Mapstruct工具></a><div class=content><a class=title href="/2023/04/19/Mapstruct%E5%B7%A5%E5%85%B7/" title=Mapstruct工具>Mapstruct工具</a><time datetime=2023-04-19T12:30:42.000Z title="发表于 2023-04-19 20:30:42">2023-04-19</time></div></div></div></div></div></div></main><footer id=footer><div id=footer-wrap><div id=ft><div class=ft-item-1><div class=t-top><div class=t-t-l><p class="ft-t t-l-t">格言🧬</p><div class=bg-ad><div>我不再装模作样地拥有很多朋友，而是回到了孤单之中，以真正的我开始了独自的生活。有时我也会因为寂寞而难以忍受空虚的折磨，但我宁愿以这样的方式来维护自己的自尊，也不愿以耻辱为代价去换取那种表面的朋友。✨</div><div class=btn-xz-box><a class=btn-xz target=_blank rel=noopener href="https://stellarium.org/">点击开启星辰之旅</a></div></div></div><div class=t-t-r><p class="ft-t t-l-t">猜你想看💡</p><ul class=ft-links><li><a href="/shuoshuo/">分享生活</a><a href="/box/nav/">网址导航</a></li><li><a href="/social/links/">我的朋友</a><a href="/messageboard/">留点什么</a></li><li><a href="/personal/about/">关于作者</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li><li><a href="/box/Gallery/">我的画廊</a><a href="/personal/bb/">我的唠叨</a></li><li><a href="/site/time/">建设进程</a><a href="/site/census/">网站统计</a></li></ul></div></div></div><div class=ft-item-2><p class=ft-t>推荐友链⌛</p><div class=ft-img-group><div class=img-group-item><a target=_blank rel=noopener href="https://www.fomal.cc/" title=Fomalhaut🥝><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224623.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://tzy1997.com/" title=唐志远の博客><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224801.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://akilar.top/" title=Akilarの糖果屋><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224820.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://butterfly.js.org/" title=Butterfly><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224710.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://anzhiy.cn/" title=安知鱼><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224841.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://www.acozycotage.net/" title=Acozycotage><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224859.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://cdn.netdun.net/" title=网盾星球><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224948.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://blog.leonus.cn/" title=Leonus><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224927.png></a></div></div></div></div><div class=copyright><span><b>&copy;2023</b></span><span><b>&nbsp;&nbsp;By yuydot</b></span></div><div id=workboard></div><p id=ghbdages></p></div></footer></div><div id=rightside><div id=rightside-config-hide><button id=readmode type=button title=阅读模式><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick=switchNightMode() title=浅色和深色模式转换><svg width=25 height=25 viewbox="0 0 1024 1024"><use id=modeicon xlink:href=#icon-moon></use></svg></a><button id=hide-aside-btn type=button title=单栏和双栏切换><i class="fas fa-arrows-alt-h"></i></button></div><div id=rightside-config-show><button id=rightside_config type=button title=设置><i class="fas fa-cog fa-spin"></i></button><button class=close id=mobile-toc-button type=button title=目录><i class="fas fa-list-ul"></i></button><button id=chat_btn type=button title=聊天><i class="fas fa-sms"></i></button><a id=to_comment href=#post-comment title=直达评论><i class="fas fa-comments"></i></a><button id=go-up type=button title=回到顶部><span class=scroll-percent></span><i class="fas fa-arrow-up"><span id=percent>0<span>%</span></span></i></button><button id=go-down type=button title=直达底部 onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src=/js/utils.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/4.0.31/fancybox.umd.min.js></script><script src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js></script><div class=js-pjax><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'AQGZMCqJVLEhHK6FvPAjGaz9-gzGzoHsz',
      appKey: 'OG699oy4JvBM9mTDwTovhlTO',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.16/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src=/js/jquery-3.6.0.min.js></script><script src=/js/weather.js></script><script src=/js/footer.js></script><script defer data-pjax src=/js/readPercent.js></script><div class="aplayer no-destroy" data-id=148314925 data-server=netease data-type=playlist data-fixed=true data-autoplay=false data-mini=true></div><script async src=/js/fps.js></script><canvas id=snow></canvas><script async src=/js/snow.js></script><script async src=/js/title.js></script><script defer src=/js/runtime.js></script><script src=/js/sun_moon.js async></script><script async data-pjax src=/js/txmap.js></script><script type=text/javascript src=/js/rightmenu.js></script><script async src=https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js></script><script async src=https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js></script><script defer data-pjax src=/js/cat.js></script><script>(function(d, w, c) {
    w.ChatraID = 'rTwLAKp9sD8gKkYZS';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (true) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><link rel=stylesheet href=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css media=print onload="this.media='all'"><script src=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js></script><script src=https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js></script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div><div class=js-pjax id=rightMenu><div class="rightMenu-group rightMenu-small"><a class=rightMenu-item href=javascript:window.history.back();><i class="fa fa-arrow-left"></i></a><a class=rightMenu-item href=javascript:window.history.forward();><i class="fa fa-arrow-right"></i></a><a class=rightMenu-item href=javascript:window.location.reload();><i class="fa fa-refresh"></i></a><a class=rightMenu-item href=javascript:rmf.scrollToTop();><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-text><a class=rightMenu-item href=javascript:rmf.copySelect();><i class="fa fa-copy"></i><span>复制</span></a><a class=rightMenu-item href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-too><a class=rightMenu-item href=javascript:window.open(window.getSelection().toString());window.location.reload();><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-paste><a class=rightMenu-item href=javascript:rmf.paste()><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-post><a class=rightMenu-item href=#post-comment><i class="fas fa-comment"></i><span>空降评论</span></a><a class=rightMenu-item href=javascript:rmf.copyWordsLink()><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-to><a class=rightMenu-item href=javascript:rmf.openWithNewTab()><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class=rightMenu-item id=menu-too href=javascript:rmf.open()><i class="fa fa-link"></i><span>转到链接</span></a><a class=rightMenu-item href=javascript:rmf.copyLink()><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-img><a class=rightMenu-item href=javascript:rmf.saveAs()><i class="fa fa-download"></i><span>保存图片</span></a><a class=rightMenu-item href=javascript:rmf.openWithNewTab()><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class=rightMenu-item href=javascript:rmf.copyLink()><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class=rightMenu-item href=javascript:randomPost()><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class=rightMenu-item href=javascript:switchNightMode();><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class=rightMenu-item href=javascript:rmf.switchReadMode();><i class="fa fa-book"></i><span>阅读模式</span></a><a class=rightMenu-item href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class=rightMenu-item href=javascript:toggleWinbox();><i class="fas fa-cog"></i><span>美化设置</span></a><a class=rightMenu-item href=javascript:rmf.fullScreen();><i class="fas fa-expand"></i><span>切换全屏</span></a><a class=rightMenu-item href=javascript:window.print();><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://yuydot.gitee.io/categories/Spring/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 Spring (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yuydot.gitee.io/categories/Git/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱‍👓 Git (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yuydot.gitee.io/categories/数据库/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 数据库 (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://yuydot.gitee.io/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style><style></style><div class=js-pjax><script async>var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async>var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src=https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js></script><script defer src=https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js></script><style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body></html>