<!DOCTYPE html><html lang=[&quot;zh-CN&quot;,&quot;zh-TW&quot;,&quot;en&quot;,&quot;default&quot;] data-theme=light><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>RabbtMQ教程二 | YuydotのBlog</title><meta name=author content=yuydot><meta name=copyright content=yuydot><meta name=format-detection content="telephone=no"><meta name=theme-color content=#3eb8be;><meta name=description content="一、发布确认​ 在前面我们通过将队列和消息持久化化操作，让消息保存在磁盘上。但是可能存在还没有保存磁盘上就出现宕机的情况。所以，我们需要继续第三步 发布确认 ​ 发布确认：生产者将消息发送给消费者，将消息保存在磁盘上后 ，MQ向生产者确认消息已经保存在磁盘上。 只有发布确认了后，才能保证消息的持久化。 1. 发布确认逻辑​ 生产者将信道设置成 confirm 模式，一旦信道进入 confirm"><meta property=og:type content=article><meta property=og:title content=RabbtMQ教程二><meta property=og:url content=https://yuydot.gitee.io/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/index.html><meta property=og:site_name content=YuydotのBlog><meta property=og:description content="一、发布确认​ 在前面我们通过将队列和消息持久化化操作，让消息保存在磁盘上。但是可能存在还没有保存磁盘上就出现宕机的情况。所以，我们需要继续第三步 发布确认 ​ 发布确认：生产者将消息发送给消费者，将消息保存在磁盘上后 ，MQ向生产者确认消息已经保存在磁盘上。 只有发布确认了后，才能保证消息的持久化。 1. 发布确认逻辑​ 生产者将信道设置成 confirm 模式，一旦信道进入 confirm"><meta property=og:locale content=zh_CN><meta property=og:image content=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-y8622k_2560x1600.png><meta property=article:published_time content=2023-05-17T13:04:40.000Z><meta property=article:modified_time content=2023-05-21T14:42:46.955Z><meta property=article:author content=yuydot><meta property=article:tag content=RabbitMQ><meta name=twitter:card content=summary><meta name=twitter:image content=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-y8622k_2560x1600.png><link rel="shortcut icon" href=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/logo1.png><link rel=canonical href=https://yuydot.gitee.io/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css media=print onload="this.media='all'"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/4.0.31/fancybox.min.css media=print onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"距离上次更新已经过去","messageNext":"天了，文章内容可能已经过时。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id=config-diff>var GLOBAL_CONFIG_SITE = {
  title: 'RabbtMQ教程二',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-21 22:42:46'
}</script><noscript><style type=text/css>
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#3eb8be;')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel=stylesheet href=/css/background.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/readPercent.css><link rel=stylesheet href=/css/footer.css><link rel=stylesheet href=/css/loading_css.css><span id=fps></span><link rel=stylesheet href=https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css><svg aria-hidden=true style="position:absolute; overflow:hidden; width:0; height:0"><symbol id=icon-sun viewbox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill=#FFD878 p-id=8420></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill=#FFE4A9 p-id=8421></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill=#4D5152 p-id=8422></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill=#4D5152 p-id=8423></path></symbol><symbol id=icon-moon viewbox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill=#FFB531 p-id=11345></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill=#030835 p-id=11346></path></symbol></svg><div id=myscoll></div><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css media=print onload="this.media='screen'"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css><style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style><meta name=generator content="Hexo 6.3.0"></head><body><div id=loading-box onclick=document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)><div class=loading-bg><div class=loading-img></div><div class=loading-image-dot></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel=stylesheet href=/css/progress_bar.css><script src=https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js></script><div id=web_bg></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img is-center"><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wang.jpg onerror="onerror=null;src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/friend_404.gif'" alt=avatar></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class=headline>文章</div><div class=length-num>19</div></a><a href="/tags/"><div class=headline>标签</div><div class=length-num>10</div></a><a href="/categories/"><div class=headline>分类</div><div class=length-num>5</div></a></div><hr><div class=menus_items><div class=menus_item><a class=site-page href="/"><i class="fa-fw fas fa-home"></i><span>主页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fa fa-graduation-cap"></i><span>博文</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span>标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span>归档</span></a></li></ul></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fas fa-list"></i><span>生活</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span>分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span>影视</span></a></li></ul></div><div class=menus_item><a class=site-page href="/links/"><i class="fa-fw fa fa-link"></i><span>友链</span></a></div><div class=menus_item><a class=site-page href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span>留言板</span></a></div><div class=menus_item><a class=site-page href="/about/"><i class="fa-fw fas fa-heart"></i><span>关于笔者</span></a></div></div></div></div><div class=post id=body-wrap><header class=post-bg id=page-header style="background-image: url('https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png')"><nav id=nav><span id=blog-info><a href="/" title=YuydotのBlog><span class=site-name>YuydotのBlog</span></a></span><div id=weather><div id=tp-weather-widget></div></div><div id=menus><div class=menus_items><div class=menus_item><a class=site-page href="/"><i class="fa-fw fas fa-home"></i><span>主页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fa fa-graduation-cap"></i><span>博文</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span>标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span>归档</span></a></li></ul></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fas fa-list"></i><span>生活</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span>分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span>影视</span></a></li></ul></div><div class=menus_item><a class=site-page href="/links/"><i class="fa-fw fa fa-link"></i><span>友链</span></a></div><div class=menus_item><a class=site-page href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span>留言板</span></a></div><div class=menus_item><a class=site-page href="/about/"><i class="fa-fw fas fa-heart"></i><span>关于笔者</span></a></div></div><div id=toggle-menu><a class=site-page href=javascript:void(0);><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id=post-info><h1 class=post-title>RabbtMQ教程二</h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class=post-meta-label>发表于</span><time class=post-meta-date-created datetime=2023-05-17T13:04:40.000Z title="发表于 2023-05-17 21:04:40">2023-05-17</time><span class=post-meta-separator>|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class=post-meta-label>更新于</span><time class=post-meta-date-updated datetime=2023-05-21T14:42:46.955Z title="更新于 2023-05-21 22:42:46">2023-05-21</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href="/categories/Springboot/">Springboot</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>字数总计:</span><span class=word-count>10.3k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>阅读时长:</span><span>38分钟</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv data-flag-title=RabbtMQ教程二><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>阅读量:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class=waves-svg xmlns=http://www.w3.org/2000/svg xlink=http://www.w3.org/1999/xlink viewbox="0 24 150 28" preserveaspectratio=none shape-rendering=auto><defs><path id=gentle-wave d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class=parallax><use href=#gentle-wave x=48 y=0></use><use href=#gentle-wave x=48 y=3></use><use href=#gentle-wave x=48 y=5></use><use href=#gentle-wave x=48 y=7></use></g></svg></section></header><main class=layout id=content-inner><div id=post><article class=post-content id=article-container><h2 id=一、发布确认><a href=#一、发布确认 class=headerlink title=一、发布确认></a>一、发布确认</h2><p>​ 在前面我们通过将<strong>队列</strong>和<strong>消息</strong>持久化化操作，让消息保存在磁盘上。但是可能存在还没有保存磁盘上就出现宕机的情况。所以，我们需要继续第三步 <strong>发布确认</strong></p><p>​ 发布确认：生产者将消息发送给消费者，将消息保存在磁盘上后 ，MQ向生产者确认消息已经保存在磁盘上。 只有<strong>发布确认</strong>了后，才能保证消息的持久化。</p><h3 id=1-发布确认逻辑><a href=#1-发布确认逻辑 class=headerlink title="1. 发布确认逻辑"></a>1. 发布确认逻辑</h3><p>​ 生产者将信道设置成 confirm 模式，一旦信道进入 confirm 模式，所有在该信道上面发布的消息都将会被指派一个唯一的 ID(从 1 开始)，一旦消息被投递到所有匹配的队列之后，broker 就会发送一个确认给生产者(包含消息的唯一 ID)，这就使得生产者知道消息已经正确到达目的队列了，如果消息和队列是可持久化的，那么确认消息会在将消息写入磁盘之后发出，broker 回传给生产者的确认消息中 delivery-tag 域包含了确认消息的序列号，此外 broker 也可以设置basic.ack 的 multiple 域，表示到这个序列号之前的所有消息都已经得到了处理。</p><p>​ confirm 模式最大的好处在于他是异步的，一旦发布一条消息，生产者应用程序就可以在等信道返回确认的同时继续发送下一条消息，当消息最终得到确认之后，生产者应用便可以通过回调方法来处理该确认消息，如果RabbitMQ 因为自身内部错误导致消息丢失，就会发送一条 nack 消息， 生产者应用程序同样可以在回调方法中处理该 nack 消息。</p><h3 id=2-发布确认的策略（代码demo4）><a href=#2-发布确认的策略（代码demo4） class=headerlink title="2. 发布确认的策略（代码demo4）"></a>2. 发布确认的策略（代码demo4）</h3><h4 id=2-1-开启发布确认的方法><a href=#2-1-开启发布确认的方法 class=headerlink title="2.1 开启发布确认的方法:"></a>2.1 开启发布确认的方法:</h4><p>​ 发布确认默认是没有开启的，如果要开启需要调用方法 confirmSelect，每当你要想使用发布确认，都需要在 channel 上调用该方法 (在信道建立之后，消息发送之前，都可开启发布确认)</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=comment>//开启发布确认</span></span><br><span class=line>channel.confirmSelect();</span><br></pre></td></tr></table></figure><h4 id=2-2-单个确认发布><a href=#2-2-单个确认发布 class=headerlink title="2.2 单个确认发布"></a>2.2 单个确认发布</h4><p>​ 这是一种简单的确认方式，它是一种<strong>同步确认发布</strong>的方式，也就是发布一个消息之后只有它被确认发布，后续的消息才能继续发布，<code>waitForConfirmsOrDie(long)</code> 这个方法只有在消息被确认的时候才返回，如果在指定时间范围内这个消息没有被确认那么它将抛出异常。</p><p>​ 这种确认方式有一个最大的缺点就是：<strong>发布速度特别的慢</strong>，因为如果没有确认发布的消息就会阻塞所有后续消息的发布，这种方式最多提供每秒不超过数百条发布消息的吞吐量。当然对于某些应用程序来说这可能已经足够了。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line><span class=comment>//1.单个确认发布</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">publishMessageIndividually</span><span class=params>()</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>    <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>    <span class=comment>//队列声明</span></span><br><span class=line>    <span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> UUID.randomUUID().toString();</span><br><span class=line>    channel.queueDeclare(queueName, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>null</span>);</span><br><span class=line>    <span class=comment>//开启发布确认</span></span><br><span class=line>    channel.confirmSelect();</span><br><span class=line>    <span class=type>long</span> <span class=variable>begin</span> <span class=operator>=</span> System.currentTimeMillis();</span><br><span class=line>    <span class=keyword>for</span> (<span class=type>int</span> <span class=variable>i</span> <span class=operator>=</span> <span class=number>0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class=line>        <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> i + <span class=string>&quot;&quot;</span>;</span><br><span class=line>        channel.basicPublish(<span class=string>&quot;&quot;</span>, queueName, <span class=literal>null</span>, message.getBytes());</span><br><span class=line>        <span class=comment>//服务端返回 false 或超时时间内未返回，生产者可以消息重发</span></span><br><span class=line>        <span class=type>boolean</span> <span class=variable>flag</span> <span class=operator>=</span> channel.waitForConfirms();</span><br><span class=line>        <span class=keyword>if</span>(flag)&#123;</span><br><span class=line>            System.out.println(<span class=string>&quot;消息发送成功&quot;</span>);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=type>long</span> <span class=variable>end</span> <span class=operator>=</span> System.currentTimeMillis();</span><br><span class=line>    System.out.println(<span class=string>&quot;发布&quot;</span> + MESSAGE_COUNT + <span class=string>&quot;个单独确认消息,耗时&quot;</span> + (end - begin) + <span class=string>&quot;ms&quot;</span>);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h4 id=2-3-批量确认发布><a href=#2-3-批量确认发布 class=headerlink title="2.3 批量确认发布"></a>2.3 批量确认发布</h4><p>​ 上面那种方式非常慢，与单个等待确认消息相比，先发布一批消息然后一起确认可以极大地提高吞吐量，当然这种方式的缺点就是：当发生故障导致发布出现问题时，不知道是哪个消息出 问题了，我们必须将整个批处理保存在内存中，以记录重要的信息而后重新发布消息。当然这种方案仍然是同步的，也一样阻塞消息的发布。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre></td><td class=code><pre><span class=line><span class=comment>//2.批量确认发布</span></span><br><span class=line>   <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">publishMessageBatch</span><span class=params>()</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>       <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>       <span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> UUID.randomUUID().toString();</span><br><span class=line>       channel.queueDeclare(queueName, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>null</span>);</span><br><span class=line>       <span class=comment>//开启发布确认</span></span><br><span class=line>       channel.confirmSelect();</span><br><span class=line>       <span class=comment>//批量确认消息大小,每100次确认一次</span></span><br><span class=line>       <span class=type>int</span> <span class=variable>batchSize</span> <span class=operator>=</span> <span class=number>100</span>;</span><br><span class=line>       <span class=comment>//未确认消息个数</span></span><br><span class=line>       <span class=type>int</span> <span class=variable>outstandingMessageCount</span> <span class=operator>=</span> <span class=number>0</span>;</span><br><span class=line>       <span class=type>long</span> <span class=variable>begin</span> <span class=operator>=</span> System.currentTimeMillis();</span><br><span class=line>       <span class=keyword>for</span> (<span class=type>int</span> <span class=variable>i</span> <span class=operator>=</span> <span class=number>0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class=line>           <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> i + <span class=string>&quot;&quot;</span>;</span><br><span class=line>           channel.basicPublish(<span class=string>&quot;&quot;</span>, queueName, <span class=literal>null</span>, message.getBytes());</span><br><span class=line>           outstandingMessageCount++;</span><br><span class=line>           <span class=keyword>if</span> (outstandingMessageCount == batchSize) &#123;</span><br><span class=line>               channel.waitForConfirms();</span><br><span class=line>               outstandingMessageCount = <span class=number>0</span>;</span><br><span class=line>           &#125;</span><br><span class=line>       &#125;</span><br><span class=line>       <span class=comment>//为了确保还有剩余没有确认消息 再次确认</span></span><br><span class=line>       <span class=keyword>if</span> (outstandingMessageCount &gt; <span class=number>0</span>) &#123;</span><br><span class=line>           channel.waitForConfirms();</span><br><span class=line>       &#125;</span><br><span class=line>       <span class=type>long</span> <span class=variable>end</span> <span class=operator>=</span> System.currentTimeMillis();</span><br><span class=line>       System.out.println(<span class=string>&quot;发布&quot;</span> + MESSAGE_COUNT + <span class=string>&quot;个批量确认消息,耗时&quot;</span> + (end - begin) + <span class=string>&quot;ms&quot;</span>);</span><br><span class=line>   &#125;</span><br></pre></td></tr></table></figure><h4 id=2-4-异步确认发布><a href=#2-4-异步确认发布 class=headerlink title="2.4 异步确认发布"></a>2.4 异步确认发布</h4><p>​ 异步确认虽然编程逻辑比上两个要复杂，但是性价比最高，无论是可靠性还是效率都没得说， 他是利用回调函数来达到消息可靠性传递的，这个中间件也是通过函数回调来保证是否投递成功， 下面就让我们来详细讲解异步确认是怎么实现的。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/18/14-40-39-5c3ff1cf0b6cd613b6d970152b261778-image-20230518144039536-8f5e12.png alt=image-20230518144039536></p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br></pre></td><td class=code><pre><span class=line> <span class=comment>//3. 异步确认发布</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">publishMessageAsync</span><span class=params>()</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>    <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>    <span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> UUID.randomUUID().toString();</span><br><span class=line>    channel.queueDeclare(queueName, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>null</span>);</span><br><span class=line>    <span class=comment>//开启发布确认</span></span><br><span class=line>    channel.confirmSelect();</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>         * 线程安全有序的一个哈希表，适用于高并发的情况</span></span><br><span class=line><span class=comment>         * 1.轻松的将序号与消息进行关联</span></span><br><span class=line><span class=comment>         * 2.轻松批量删除条目 只要给到序列号</span></span><br><span class=line><span class=comment>         * 3.支持并发访问</span></span><br><span class=line><span class=comment>         */</span></span><br><span class=line>    ConcurrentSkipListMap&lt;Long, String&gt; outstandingConfirms = <span class=keyword>new</span> <span class="title class_">ConcurrentSkipListMap</span>&lt;&gt;();</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>         * 确认收到消息的一个回调</span></span><br><span class=line><span class=comment>         * 1.消息序列号</span></span><br><span class=line><span class=comment>         * 2.是否为批量确认  true  可以确认小于等于当前序列号的消息</span></span><br><span class=line><span class=comment>         *                  false 确认当前序列号消息</span></span><br><span class=line><span class=comment>         */</span></span><br><span class=line>    <span class=type>ConfirmCallback</span> <span class=variable>ackCallback</span> <span class=operator>=</span> (sequenceNumber, multiple) -&gt; &#123;</span><br><span class=line>        <span class=keyword>if</span> (multiple) &#123;</span><br><span class=line>            <span class=comment>//返回的是小于等于当前序列号的未确认消息 是一个 map</span></span><br><span class=line>            ConcurrentNavigableMap&lt;Long, String&gt; confirmed = outstandingConfirms.headMap(sequenceNumber, <span class=literal>true</span>);</span><br><span class=line>            <span class=comment>//清除该部分未确认消息</span></span><br><span class=line>            confirmed.clear();</span><br><span class=line>        &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>            <span class=comment>//只清除当前序列号的消息</span></span><br><span class=line>            outstandingConfirms.remove(sequenceNumber);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;;</span><br><span class=line>    <span class=comment>//消息确认失败 回调函数</span></span><br><span class=line>    <span class=type>ConfirmCallback</span> <span class=variable>nackCallback</span> <span class=operator>=</span> (sequenceNumber, multiple) -&gt; &#123;</span><br><span class=line>        <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> outstandingConfirms.get(sequenceNumber);</span><br><span class=line>        System.out.println(<span class=string>&quot;发布的消息&quot;</span> + message + <span class=string>&quot;未被确认，序列号&quot;</span> + sequenceNumber);</span><br><span class=line>    &#125;;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>         * 添加一个异步确认的监听器</span></span><br><span class=line><span class=comment>         * 1.确认收到消息的回调（监听那些消息成功了）</span></span><br><span class=line><span class=comment>         * 2.未收到消息的回调（监听那些消息失败了）</span></span><br><span class=line><span class=comment>         */</span></span><br><span class=line>    channel.addConfirmListener(ackCallback, nackCallback);<span class=comment>//异步通知</span></span><br><span class=line>    <span class=type>long</span> <span class=variable>begin</span> <span class=operator>=</span> System.currentTimeMillis();</span><br><span class=line>    <span class=keyword>for</span> (<span class=type>int</span> <span class=variable>i</span> <span class=operator>=</span> <span class=number>0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class=line>        <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=string>&quot;消息&quot;</span> + i;</span><br><span class=line>        <span class=comment>/**</span></span><br><span class=line><span class=comment>             * channel.getNextPublishSeqNo()获取下一个消息的序列号</span></span><br><span class=line><span class=comment>             * 通过序列号与消息体进行一个关联</span></span><br><span class=line><span class=comment>             * 全部都是未确认的消息体</span></span><br><span class=line><span class=comment>             */</span></span><br><span class=line>        outstandingConfirms.put(channel.getNextPublishSeqNo(), message);</span><br><span class=line>        channel.basicPublish(<span class=string>&quot;&quot;</span>, queueName, <span class=literal>null</span>, message.getBytes());</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=type>long</span> <span class=variable>end</span> <span class=operator>=</span> System.currentTimeMillis();</span><br><span class=line>    System.out.println(<span class=string>&quot;发布&quot;</span> + MESSAGE_COUNT + <span class=string>&quot;个异步确认消息,耗时&quot;</span> + (end - begin) + <span class=string>&quot;ms&quot;</span>);</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h4 id=2-5-测试三种发布确认方式><a href=#2-5-测试三种发布确认方式 class=headerlink title="2.5 测试三种发布确认方式"></a>2.5 测试三种发布确认方式</h4><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> Exception&#123;</span><br><span class=line>      <span class=comment>//1.单个确认发布</span></span><br><span class=line>      ConfirmMessage.publishMessageIndividually(); <span class=comment>//发布1000个单独确认消息,耗时1172ms</span></span><br><span class=line>      <span class=comment>//2.批量确认发布</span></span><br><span class=line>      ConfirmMessage.publishMessageBatch();   <span class=comment>//发布1000个批量确认消息,耗时119ms</span></span><br><span class=line>      <span class=comment>//3.异步确认发布</span></span><br><span class=line>      ConfirmMessage.publishMessageAsync();   <span class=comment>//发布1000个异步确认消息,耗时49ms</span></span><br><span class=line>  &#125;</span><br></pre></td></tr></table></figure><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/18/14-38-44-0bc04a4acdfd902b4dadde5fdb18f910-image-20230518143844157-cedf3d.png alt=image-20230518143844157></p><p><strong>以上 3 种发布确认速度对比 :</strong></p><ul><li><p>单独发布消息：同步等待确认，简单，但吞吐量非常有限。</p></li><li><p>批量发布消息：批量同步等待确认，简单，合理的吞吐量，一旦出现问题但很难推断出是那条消息出现了问题。</p></li><li><p>异步处理：最佳性能和资源使用，在出现错误的情况下可以很好地控制，但是实现起来稍微难些</p></li></ul><p>到此，我们就学习了RabbitMQ的 <strong>简单模式</strong> 和 <strong>工作模式</strong> 。在交换机的学习中会学习到 <strong>发布、订阅模式</strong> 。</p><h2 id=二、交换机><a href=#二、交换机 class=headerlink title=二、交换机></a>二、交换机</h2><p>​ 在之前的学习中，我们创建了一个工作队列。我们假设的是工作队列背后，每个任务都恰好交付给一个消费者(工作进程)。在这一部分的学习中，我们将做一些完全不同的事情-我们将消息传达给多个消费者。这种模式 称为 ”发布&#x2F;订阅”。什么意思？ 就是我们通过将消息发送给交换机，然后交换机通过RoutingKey可以绑定多个队列，那每个队列都可以消费一次同一个消息（只是在同一个队列中同一消息不能被多次消费，但是在不同队列中可以）。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/18/15-09-54-0d5e0e86aab962e58ed047a90b78748f-image-20230518150954791-db4624.png alt=image-20230518150954791></p><h3 id=1-Exchanges><a href=#1-Exchanges class=headerlink title="1. Exchanges"></a>1. Exchanges</h3><h4 id=1-1-Exchanges概念><a href=#1-1-Exchanges概念 class=headerlink title="1.1 Exchanges概念"></a>1.1 Exchanges概念</h4><blockquote><p>注意：在之前的学习中，我们并不是直接将消息发送给队列，二十使用了默认的交换机。</p></blockquote><p>​ RabbitMQ 消息传递模型的核心思想是: <strong>生产者生产的消息从不会直接发送到队列</strong>。实际上，通常生产者甚至都不知道这些消息传递传递到了哪些队列中。</p><p>​ 相反，**生产者只能将消息发送到交换机(exchange)**，交换机工作的内容非常简单，一方面它接收来自生产者的消息，另一方面将它们推入队列。交换机必须确切知道如何处理收到的消息。是应该把这些消息放到特定队列还是说把他们到许多队列中还是说应该丢弃它们。这就的由交换机的类型来决定。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/18/15-18-15-4cf2bc006c5a9bdf3b049f4ab4437780-image-20230518151815403-1156f2.png alt=image-20230518151815403></p><h4 id=1-2-Exchanges类型><a href=#1-2-Exchanges类型 class=headerlink title="1.2 Exchanges类型"></a>1.2 Exchanges类型</h4><ul><li>直接(direct)</li><li>主题(topic)</li><li>标题(headers)</li><li>扇出(fanout)</li></ul><h4 id=1-3-无名exchange（默认交换机）><a href=#1-3-无名exchange（默认交换机） class=headerlink title="1.3 无名exchange（默认交换机）"></a>1.3 无名exchange（默认交换机）</h4><p>​ 在前面部分我们对 exchange 一无所知，但仍然能够将消息发送到队列。之前能实现的 原因是因为我们使用的是<strong>默认交换机</strong>，我们通过空字符串(“”)进行标识。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/18/15-19-59-5aeeecab8a2b788df691c49eadeda9ce-RabbitMQ-00000036-44a981.png alt=RabbitMQ-00000036></p><p>​ 第一个参数是交换机的名称。空字符串表示默认或无名称交换机：消息能路由发送到队列中其实是由 routingKey(bindingkey)绑定 key 指定的，如果它存在的话。</p><h3 id=2-临时队列><a href=#2-临时队列 class=headerlink title="2. 临时队列"></a>2. 临时队列</h3><p>​ 之前的章节学习中使用的是具有特定名称的队列(还记得 hello 和 ack_queue 吗？)。队列的名称我们来说至关重要，我们需要指定我们的消费者去消费哪个队列的消息。</p><p>​ 每当我们连接到 Rabbit 时，我们都需要一个全新的空队列，为此我们可以创建一个具有<strong>随机名称的队列</strong>，或者能让服务器为我们选择一个随机队列名称那就更好了。其次一旦我们断开了消费者的连接，队列将被自动删除。</p><p>创建临时队列的方式如下:</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line><span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> channel.queueDeclare().getQueue();</span><br></pre></td></tr></table></figure><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/18/15-29-18-f006c7bce4dc1eec2d88ba0823540fa5-image-20230518152917945-4fdaf4.png alt=image-20230518152917945></p><h3 id=3-绑定-bindings><a href=#3-绑定-bindings class=headerlink title="3. 绑定 bindings"></a>3. 绑定 bindings</h3><p>​ 什么是 bingding 呢，binding 其实是 exchange 和 queue 之间的桥梁，它告诉我们 exchange 和那个队列进行了绑定关系。比如说下面这张图告诉我们的就是 X 与 Q1 和 Q2 进行了绑定。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/18/15-30-35-221398f233a5e41e1e27fa339f156d9b-image-20230518153035165-0beb4d.png alt=image-20230518153035165></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/18/15-30-45-0882e242e2061a7c8571056e3464134f-image-20230518153045695-7089fd.png alt=image-20230518153045695></p><h3 id=4-Fanout-exchange><a href=#4-Fanout-exchange class=headerlink title="4. Fanout exchange"></a>4. Fanout exchange</h3><h4 id=4-1-Fanout-exchange（扇形交换机）介绍><a href=#4-1-Fanout-exchange（扇形交换机）介绍 class=headerlink title="4.1. Fanout exchange（扇形交换机）介绍"></a>4.1. Fanout exchange（扇形交换机）介绍</h4><blockquote><p>​ 在Fanout模式中，Exchange并不需要使用Routing Key。因为Fanout交换机将收到的消息广播到所有绑定到它的队列，而不管它们的Routing Key是什么。</p><p>​ 因此，在使用Fanout模式时，您只需创建一个Fanout Exchange，并将多个队列与此Exchange进行绑定即可。当发送消息时，它将通过Fanout交换机直接广播到所有已注册的队列上，而不会涉及关于消息路由的具体逻辑。这种设计使得Fanout模式的实现非常简单，而且能够高效地处理大量数据广播应用程序。</p></blockquote><p>​ Fanout 这种类型非常简单。正如从名称中猜到的那样，它是将接收到的所有消息广播到它知道的 所有队列中。系统中默认有些 exchange 类型。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/19/17-13-11-60a3139a09a5012589c33e1a599173cf-image-20230519171311488-dab791.png alt=image-20230519171311488></p><h4 id=4-2-Fanout使用场景><a href=#4-2-Fanout使用场景 class=headerlink title="4.2 Fanout使用场景"></a>4.2 Fanout使用场景</h4><ul><li>在实时聊天应用程序中，当用户发送消息时，使用Fanout在订阅该频道的所有客户端之间广播该消息。</li><li>在多人协同编辑文档或平面设计的应用程序中，使用Fanout在编辑用户之间共享即时更新，并保持应用程序跟踪所有更改。</li><li>在在线多人游戏中，使用Fanout在玩家之间同步数据和当前状态。</li><li>在物联网应用中，从传感器设备获取数据后，使用Fanout将其广播到已注册该设备的所有相关应用程序及服务。</li><li>在大规模的分布式事件处理系统中，当发生事件时，使用Fanout在所有感兴趣的应用程序之间进行有效的发布和交换。</li></ul><h4 id=4-3-Fanout-实战-（代码demo5）><a href=#4-3-Fanout-实战-（代码demo5） class=headerlink title="4.3 Fanout 实战 （代码demo5）"></a>4.3 Fanout 实战 （代码demo5）</h4><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/19/17-14-22-52d324472ebcbcf80b9cfcf77c637a41-image-20230519171422015-622314.png alt=image-20230519171422015></p><p>Logs 和临时队列的绑定关系如下图</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/19/17-15-39-04600ed2a0313cbe7284042b569e6a4e-image-20230519171539476-88e472.png alt=image-20230519171539476></p><p>​ 为了说明这种模式，我们将构建一个简单的日志系统。它将由两个程序组成:第一个程序将发出日志消 息，第二个程序是消费者。其中我们会启动两个消费者，其中一个消费者接收到消息后把日志存储在磁盘。</p><p>（1）EmitLog 发送消息给两个消费者接收</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">EmitLog</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>EXCHANGE_NAME</span> <span class=operator>=</span> <span class=string>&quot;logs&quot;</span>;</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=keyword>try</span> (<span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitUtils.getChannel()) &#123;</span><br><span class=line>            <span class=comment>/**</span></span><br><span class=line><span class=comment>            * 声明一个 exchange</span></span><br><span class=line><span class=comment>            * 1.exchange 的名称</span></span><br><span class=line><span class=comment>            * 2.exchange 的类型</span></span><br><span class=line><span class=comment>            */</span></span><br><span class=line>            channel.exchangeDeclare(EXCHANGE_NAME, <span class=string>&quot;fanout&quot;</span>);</span><br><span class=line>            <span class=type>Scanner</span> <span class=variable>sc</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class=line>            System.out.println(<span class=string>&quot;请输入信息&quot;</span>);</span><br><span class=line>            <span class=keyword>while</span> (sc.hasNext()) &#123;</span><br><span class=line>                <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> sc.nextLine();</span><br><span class=line>                channel.basicPublish(EXCHANGE_NAME, <span class=string>&quot;&quot;</span>, <span class=literal>null</span>, message.getBytes(<span class=string>&quot;UTF-8&quot;</span>));</span><br><span class=line>                System.out.println(<span class=string>&quot;生产者发出消息&quot;</span> + message);</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>（2）ReceiveLogs01 将接收到的消息打印在控制台</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">ReceiveLogs01</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>EXCHANGE_NAME</span> <span class=operator>=</span> <span class=string>&quot;logs&quot;</span>;</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitUtils.getChannel();</span><br><span class=line>        channel.exchangeDeclare(EXCHANGE_NAME, <span class=string>&quot;fanout&quot;</span>);</span><br><span class=line>        <span class=comment>/**</span></span><br><span class=line><span class=comment>        * 生成一个临时的队列 队列的名称是随机的</span></span><br><span class=line><span class=comment>        * 当消费者断开和该队列的连接时 队列自动删除</span></span><br><span class=line><span class=comment>        */</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> channel.queueDeclare().getQueue();</span><br><span class=line>        <span class=comment>//把该临时队列绑定我们的 exchange 其中 routingkey(也称之为 binding key)为空字符串</span></span><br><span class=line>        channel.queueBind(queueName, EXCHANGE_NAME, <span class=string>&quot;&quot;</span>);</span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息,把接收到的消息打印在屏幕.....&quot;</span>);</span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(), <span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot;控制台打印接收到的消息&quot;</span>+message);</span><br><span class=line>        &#125;;</span><br><span class=line>        channel.basicConsume(queueName, <span class=literal>true</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>（3）ReceiveLogs02 将接收到的消息存储在磁盘</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">ReceiveLogs02</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>EXCHANGE_NAME</span> <span class=operator>=</span> <span class=string>&quot;logs&quot;</span>;</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitUtils.getChannel();</span><br><span class=line>        channel.exchangeDeclare(EXCHANGE_NAME, <span class=string>&quot;fanout&quot;</span>);</span><br><span class=line>        <span class=comment>/**</span></span><br><span class=line><span class=comment>        * 生成一个临时的队列 队列的名称是随机的</span></span><br><span class=line><span class=comment>        * 当消费者断开和该队列的连接时 队列自动删除</span></span><br><span class=line><span class=comment>        */</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> channel.queueDeclare().getQueue();</span><br><span class=line>        <span class=comment>//把该临时队列绑定我们的 exchange 其中 routingkey(也称之为 binding key)为空字符串</span></span><br><span class=line>        channel.queueBind(queueName, EXCHANGE_NAME, <span class=string>&quot;&quot;</span>);</span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息,把接收到的消息写到文件.....&quot;</span>);</span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(), <span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            <span class=type>File</span> <span class=variable>file</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">File</span>(<span class=string>&quot;C:\\work\\rabbitmq_info.txt&quot;</span>);</span><br><span class=line>            FileUtils.writeStringToFile(file,message,<span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot;数据写入文件成功&quot;</span>);</span><br><span class=line>        &#125;;</span><br><span class=line>        channel.basicConsume(queueName, <span class=literal>true</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p>（1）生产者发出信息</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/20-28-37-c17c80220ffd926456755f684f405aec-image-20230520202837693-1cda4e.png alt=image-20230520202837693></p><p>（2）消费者1接收到消息，打印在控制台</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/20-29-21-ceefe51464a2a3e545c86eb2700fd5ce-image-20230520202921216-fdfe55.png alt=image-20230520202921216></p><p>（3）消费者2接收到消息，将消息写入文件</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/20-30-01-5d4e2a064896fd65aaf559e477520d1e-image-20230520203001458-82c5fd.png alt=image-20230520203001458></p><h3 id=5-Direct-exchange><a href=#5-Direct-exchange class=headerlink title="5. Direct exchange"></a>5. Direct exchange</h3><h4 id=5-1-回顾><a href=#5-1-回顾 class=headerlink title="5.1 回顾"></a>5.1 回顾</h4><p>​ 在上一节中，我们构建了一个简单的日志记录系统。我们能够向许多接收者广播日志消息。在本节我们将向其中添加一些特别的功能——让某个消费者订阅发布的部分消息。例如我们只把严重错误消息定向存储到日志文件(以节省磁盘空间)，同时仍然能够在控制台上打印所有日志消息。</p><p>​ 我们再次来回顾一下什么是 bindings，绑定是交换机和队列之间的桥梁关系。也可以这么理解： <strong>队列只对它绑定的交换机的消息感兴趣</strong>。绑定用参数：routingKey 来表示也可称该参数为 binding key， 创建绑定我们用代码:channel.queueBind(queueName, EXCHANGE_NAME, “routingKey”);</p><p>绑定之后的意义由其交换类型决定。</p><h4 id=5-2-Direct-exchange-（直连交换机）介绍><a href=#5-2-Direct-exchange-（直连交换机）介绍 class=headerlink title="5.2 Direct exchange （直连交换机）介绍"></a>5.2 Direct exchange （直连交换机）介绍</h4><p>​ 上一节中的我们的日志系统将所有消息广播给所有消费者，对此我们想做一些改变，例如我们希望将日志消息写入磁盘的程序仅接收严重错误(errros)，而不存储哪些警告(warning)或信息(info)日志消息避免浪费磁盘空间。 Fanout 这种交换类型并不能给我们带来很大的灵活性-它只能进行无意识的广播，在这里我们将使用 direct 这种类型来进行替换，这种类型的工作方式是，消息只去到它绑定的routingKey 队列中去。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/20-54-41-b076b54f0f41698cb765af44ca857827-image-20230520205441472-7ca41f.png alt=image-20230520205441472></p><p>​ 在上面这张图中，我们可以看到 X 绑定了两个队列，绑定类型是 direct。队列Q1 绑定键为 orange， 队列 Q2 绑定键有两个:一个绑定键为 black，另一个绑定键为 green.</p><p>​ 在这种绑定情况下，生产者发布消息到 exchange 上，绑定键为 orange 的消息会被发布到队列 Q1。绑定键为 black green 和的消息会被发布到队列 Q2，其他消息类型的消息将被丢弃。</p><h4 id=5-3-Direct-Exchange使用场景><a href=#5-3-Direct-Exchange使用场景 class=headerlink title="5.3 Direct Exchange使用场景"></a>5.3 Direct Exchange使用场景</h4><p>​ Direct Exchange（直连交换）是 RabbitMQ 提供的常用 Exchange 机制之一。它与其他类型的 Exchange 不同之处在于，Direct Exchange 会根据消息 routing key 直接将消息传递给 Binding key 匹配的队列，而不是通过特定的规则进行路由和过滤。</p><p>因此，当应用场景中需要精确指定消息的目标队列时，可以使用 Direct Exchange。例如：</p><ul><li>任务分发：系统中有多个任务消费者同盟，每个任务只能被一个消费者处理。这种情况下就可以使用 Direct Exchange 来指定任务对应的处理队列；</li><li>日志分类：将日志按照不同程度、类型或优先级分类存储到不同的队列中，可以使用Direct Exchange 将日志根据类型或关键字路由到不同的队列中去。这样既方便了后续的分析和监控，同时也有助于减少无关日志占用的存储资源。</li></ul><p>总之，如果需要按照固定的规则将消息路由到指定的队列中，可以选择使用 Direct Exchange。</p><h4 id=5-4-多重绑定><a href=#5-4-多重绑定 class=headerlink title="5.4 多重绑定"></a>5.4 多重绑定</h4><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/21-03-41-abf184ace221f86a6ca0aeda4a39d124-image-20230520210341278-995505.png alt=image-20230520210341278></p><p>​ 当然如果 exchange 的绑定类型是direct，<strong>但是它绑定的多个队列的 key 如果都相同</strong>，在这种情况下虽然绑定类型是 direct <strong>但是它表现的就和 fanout 有点类似了</strong>，就跟广播差不多，如上图所示。</p><h4 id=5-5-Direct和Fanout的区别><a href=#5-5-Direct和Fanout的区别 class=headerlink title="5.5 Direct和Fanout的区别"></a>5.5 Direct和Fanout的区别</h4><p>Direct Exchange和Fanout Exchange是AMQP消息中间件中的两种常见Exchange类型，它们之间最显著的区别在于路由消息的方式。</p><p>​ Direct Exchange是一种按照Routing Key精确匹配进行消息路由的Exchange类型。它通常会将通过Exchange发送到Queue的消息根据Routing Key值与绑定了该Routing Key的Queue进行匹配，并将消息路由到对应的Queue上。</p><p>​ 而Fanout Exchange是一种无条件广播所有消息到所有绑定队列的Exchange类型，不需要像Direct Exchange那样依赖Routing Key进行消息路由选择，只需要将消息“广播”到它所知道的所有队列上即可，每个队列都将接收到完全相同的消息。</p><p>​ 因此，两者的差异不仅在于Routing Key的使用，还在于Fanout Exchange更适用于广播发送给大量消费者的通信场景，而Direct Exchange则适合有选择性地将消息路由到一个或多个Queue的场景。</p><h4 id=5-5-Direct-实战（代码demo6）><a href=#5-5-Direct-实战（代码demo6） class=headerlink title="5.5 Direct 实战（代码demo6）"></a>5.5 Direct 实战（代码demo6）</h4><p>关系：</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/21-04-35-afb7d9b202b725e158736399a45715ec-image-20230520210435038-a4ea0e.png alt=image-20230520210435038></p><p>交换机：</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/21-06-03-44f4b597e8eef55498d040ee62508912-image-20230520210603615-88fa55.png alt=image-20230520210603615></p><p>（1）消费者c1：绑定disk，routingKey为error</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">ReceiveLogsDirect01</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>EXCHANGE_NAME</span> <span class=operator>=</span> <span class=string>&quot;direct_logs&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>        <span class=comment>//声明一个交换机</span></span><br><span class=line>        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class=line></span><br><span class=line>        <span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> <span class=string>&quot;disk&quot;</span>;</span><br><span class=line>        <span class=comment>//声明一个队列</span></span><br><span class=line>        channel.queueDeclare(queueName, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>null</span>);</span><br><span class=line>        <span class=comment>/**将交换机与队列绑定</span></span><br><span class=line><span class=comment>         *  参数1：队列名称</span></span><br><span class=line><span class=comment>         *  参数2：交换机名称</span></span><br><span class=line><span class=comment>         *  参数3：RoutingKey名称</span></span><br><span class=line><span class=comment>         */</span></span><br><span class=line>        channel.queueBind(queueName, EXCHANGE_NAME, <span class=string>&quot;error&quot;</span>);</span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息.....&quot;</span>);</span><br><span class=line>        <span class=comment>//消息接收后回调</span></span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(), <span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            message=<span class=string>&quot;接收绑定键:&quot;</span>+delivery.getEnvelope().getRoutingKey()+<span class=string>&quot;,消息:&quot;</span>+message;</span><br><span class=line>            <span class=type>File</span> <span class=variable>file</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">File</span>(<span class=string>&quot;D:\\2023.02\\work\\rabbitmq_info.txt&quot;</span>);</span><br><span class=line>            FileUtils.writeStringToFile(file,message,<span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot;错误日志已经接收&quot;</span>);</span><br><span class=line>        &#125;;</span><br><span class=line>        <span class=comment>//消息消费</span></span><br><span class=line>        channel.basicConsume(queueName, <span class=literal>true</span>, deliverCallback, consumerTag -&gt; &#123;</span><br><span class=line>        &#125;);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>（2）消费者c2：绑定console，routingKey为info、warning</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">ReceiveLogsDirect02</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>EXCHANGE_NAME</span> <span class=operator>=</span> <span class=string>&quot;direct_logs&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=comment>//信道连接</span></span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>        <span class=comment>//声明交换机</span></span><br><span class=line>        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class=line>        <span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> <span class=string>&quot;console&quot;</span>;</span><br><span class=line>        <span class=comment>//声明队列</span></span><br><span class=line>        channel.queueDeclare(queueName, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>null</span>);</span><br><span class=line>        <span class=comment>//交换机与队列绑定，但是绑定的RoutingKey有两个</span></span><br><span class=line>        channel.queueBind(queueName, EXCHANGE_NAME, <span class=string>&quot;info&quot;</span>);</span><br><span class=line>        channel.queueBind(queueName, EXCHANGE_NAME, <span class=string>&quot;warning&quot;</span>);</span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息.....&quot;</span>);</span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(), <span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot; 接 收 绑 定 键 :&quot;</span> + delivery.getEnvelope().getRoutingKey() + <span class=string>&quot;, 消息:&quot;</span> + message);</span><br><span class=line>        &#125;;</span><br><span class=line>        channel.basicConsume(queueName, <span class=literal>true</span>, deliverCallback, consumerTag -&gt; &#123;</span><br><span class=line>        &#125;);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>（3）生产者：通过map来遍历得到routingKey和message</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">EmitLogDirect</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>EXCHANGE_NAME</span> <span class=operator>=</span> <span class=string>&quot;direct_logs&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class=line>        <span class=comment>//创建多个 bindingKey</span></span><br><span class=line>        Map&lt;String, String&gt; bindingKeyMap = <span class=keyword>new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;info&quot;</span>, <span class=string>&quot;普通 info 信息&quot;</span>);</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;warning&quot;</span>, <span class=string>&quot;警告 warning 信息&quot;</span>);</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;error&quot;</span>, <span class=string>&quot;错误 error 信息&quot;</span>);</span><br><span class=line>        <span class=comment>//debug 没有消费这接收这个消息 所有就丢失了</span></span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;debug&quot;</span>, <span class=string>&quot;调试 debug 信息&quot;</span>);</span><br><span class=line>        <span class=keyword>for</span> (Map.Entry&lt;String, String&gt; bindingKeyEntry : bindingKeyMap.entrySet()) &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>bindingKey</span> <span class=operator>=</span> bindingKeyEntry.getKey();</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> bindingKeyEntry.getValue();</span><br><span class=line>            channel.basicPublish(EXCHANGE_NAME, bindingKey, <span class=literal>null</span>, message.getBytes(<span class=string>&quot;UTF-8&quot;</span>));</span><br><span class=line>            System.out.println(<span class=string>&quot;生产者发出消息:&quot;</span> + message);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p>（1）生产者：发出四种类型的消息</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/21-55-03-1afea1f38a8f223c31c555c29003045d-image-20230520215503476-1b70e8.png alt=image-20230520215503476></p><p>（2）消费者c1：绑定disk，routingKey为error</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/21-56-02-1c16aef2781581f49709648100b38e10-image-20230520215602823-689936.png alt=image-20230520215602823></p><p>（3）消费者c2：绑定console，routingKey为info、warning</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/21-56-21-a1234e7fac25214483f16c0dbf1cd98d-image-20230520215621570-bbce03.png alt=image-20230520215621570></p><p>​ 因为没有消费这接收debug消息 所以debug消息就丢失了。</p><h3 id=6-Topics-Exchange><a href=#6-Topics-Exchange class=headerlink title="6. Topics Exchange"></a>6. Topics Exchange</h3><h4 id=6-1-回顾><a href=#6-1-回顾 class=headerlink title="6.1 回顾"></a>6.1 回顾</h4><p>​ 在上一个小节中，我们改进了日志记录系统。我们没有使用只能进行随意广播的 fanout 交换机，而是使用了 direct 交换机，从而有能实现有选择性地接收日志。</p><p>​ 尽管使用 direct 交换机改进了我们的系统，但是它仍然存在局限性-比方说我们想接收的日志类型有info.base 和 info.advantage，某个队列只想 info.base 的消息，那这个时候 direct 就办不到了。这个时候就只能使用 topic 类型</p><h4 id=6-2-Topic-exchange（主题交换机）介绍><a href=#6-2-Topic-exchange（主题交换机）介绍 class=headerlink title="6.2 Topic exchange（主题交换机）介绍"></a>6.2 Topic exchange（主题交换机）介绍</h4><p>​ Topic Exchange 根据通配符匹配规则将消息路由到一个或多个匹配的队列中去。初学新手一般都会用比较多的就是 Topic Exchange。这种类型的 Exchange 往往比较灵活，可以实现消息路由的更加细致和精准</p><h4 id=6-3-Topic的使用场景><a href=#6-3-Topic的使用场景 class=headerlink title="6.3 Topic的使用场景"></a>6.3 Topic的使用场景</h4><p>Topic Exchange（主题交换机）是 RabbitMQ 中非常常用的一种交换机类型，它根据自定义的 routing key 规则将消息路由到一个或多个匹配的队列中去，因此适合于以下场景：</p><ul><li>多级订阅者：Topic Exchange 允许使用模糊通配符来匹配 routing key。因此在实际应用中可以将前缀或后缀作为 routing key 的一部分，在订阅端采用通配符进行匹配，从而实现同一个 topic 下对不同层级、不同范围的消费者进行订阅。</li><li>发布与订阅：经过 Topic Exchange 再将消息发往相关的队列，通过这种方式实现了订阅系统的案例推送功能，而且可以灵活的定制订阅规则和过滤条件，从而能够更加方便地进行个性化推荐。</li><li>日志管理：例如针对日志系统收集各种类型、级别的日志信息，使用不同的 routing key 对应不同的 severity level 或应用程序名字，并绑定到各自的队列中，方便后续分类、存储和处理。</li></ul><p>​ 总之，当需要灵活地按照自定义的 routing key 匹配规则将消息路由到指定的队列中时，可以选择使用 Topic Exchange。</p><h4 id=6-3-Topic-的要求><a href=#6-3-Topic-的要求 class=headerlink title="6.3 Topic 的要求"></a>6.3 Topic 的要求</h4><p>​ 发送到类型是 topic 交换机的消息的 routing_key 不能随意写，必须满足一定的要求，它必须是一个单词列表，以点号分隔开。这些单词可以是任意单词，比如说： “stock.usd.nyse”,，”nyse.vmw”，”quick.orange.rabbit”.这种类型的。当然这个单词列表最多不能超过 255 个字节。</p><p>在这个规则列表中，其中有两个替换符是大家需要注意的</p><ul><li>*(星号)可以代替一个单词</li><li>#(井号)可以替代零个或多个单词</li></ul><h4 id=6-4-Topic-匹配案例><a href=#6-4-Topic-匹配案例 class=headerlink title="6.4 Topic 匹配案例"></a>6.4 Topic 匹配案例</h4><p>下图绑定关系如下</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/22-09-44-5b25c8b22136d32b2051d8dcb0f27910-image-20230520220943921-61d71a.png alt=image-20230520220943921></p><ul><li>Q1—&gt;绑定的是<ul><li>中间带 orange 带 3 个单词的字符串(<code>*.orange.*</code>)</li></ul></li><li>Q2—&gt;绑定的是<ul><li>最后一个单词是 rabbit 的 3 个单词(<code>*.*.rabbit</code>)</li><li>第一个单词是 lazy 的多个单词(lazy.#)</li></ul></li></ul><p>上图是一个队列绑定关系图，我们来看看他们之间数据接收情况是怎么样的</p><table><thead><tr><th>例子</th><th>说明</th></tr></thead><tbody><tr><td>quick.orange.rabbit</td><td>被队列 Q1Q2 接收到</td></tr><tr><td>azy.orange.elephant</td><td>被队列 Q1Q2 接收到</td></tr><tr><td>quick.orange.fox</td><td>被队列 Q1 接收到</td></tr><tr><td>lazy.brown.fox</td><td>被队列 Q2 接收到</td></tr><tr><td>lazy.pink.rabbit</td><td>虽然满足两个绑定但只被队列 Q2 接收一次</td></tr><tr><td>quick.brown.fox</td><td>不匹配任何绑定不会被任何队列接收到会被丢弃</td></tr><tr><td>quick.orange.male.rabbit</td><td>是四个单词不匹配任何绑定会被丢弃</td></tr><tr><td>lazy.orange.male.rabbit</td><td>是四个单词但匹配 Q2</td></tr></tbody></table><blockquote><p>注意：</p><ul><li>当一个队列绑定键是#，那么这个队列将接收所有数据，就有点像 fanout 了</li><li>如果队列绑定键当中没有#和*出现，那么该队列绑定类型就是 direct 了</li></ul></blockquote><h4 id=6-5-Topic实战（代码demo7）><a href=#6-5-Topic实战（代码demo7） class=headerlink title="6.5 Topic实战（代码demo7）"></a>6.5 Topic实战（代码demo7）</h4><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/22-13-02-ad63a0226268ec66950122df2fdfa883-image-20230520221302590-e7af1d.png alt=image-20230520221302590></p><p>（1）生产者：</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">EmitLogTopic</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>EXCHANGE_NAME</span> <span class=operator>=</span> <span class=string>&quot;topic_logs&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>        channel.exchangeDeclare(EXCHANGE_NAME, <span class=string>&quot;topic&quot;</span>);</span><br><span class=line>        <span class=comment>/**</span></span><br><span class=line><span class=comment>         * Q1--&gt;绑定的是</span></span><br><span class=line><span class=comment>         * 中间带 orange 带 3 个单词的字符串(*.orange.*)</span></span><br><span class=line><span class=comment>         * Q2--&gt;绑定的是</span></span><br><span class=line><span class=comment>         * 最后一个单词是 rabbit 的 3 个单词(*.*.rabbit)</span></span><br><span class=line><span class=comment>         * 第一个单词是 lazy 的多个单词(lazy.#)</span></span><br><span class=line><span class=comment>         *</span></span><br><span class=line><span class=comment>         */</span></span><br><span class=line>        Map&lt;String, String&gt; bindingKeyMap = <span class=keyword>new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;quick.orange.rabbit&quot;</span>, <span class=string>&quot;被队列 Q1Q2 接收到&quot;</span>);</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;lazy.orange.elephant&quot;</span>, <span class=string>&quot;被队列 Q1Q2 接收到&quot;</span>);</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;quick.orange.fox&quot;</span>, <span class=string>&quot;被队列 Q1 接收到&quot;</span>);</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;lazy.brown.fox&quot;</span>, <span class=string>&quot;被队列 Q2 接收到&quot;</span>);</span><br><span class=line></span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;lazy.pink.rabbit&quot;</span>, <span class=string>&quot;虽然满足两个绑定但只被队列 Q2 接收一次&quot;</span>);</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;quick.brown.fox&quot;</span>, <span class=string>&quot;不匹配任何绑定不会被任何队列接收到会被丢弃&quot;</span>);</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;quick.orange.male.rabbit&quot;</span>, <span class=string>&quot;是四个单词不匹配任何绑定会被丢弃&quot;</span>);</span><br><span class=line>        bindingKeyMap.put(<span class=string>&quot;lazy.orange.male.rabbit&quot;</span>, <span class=string>&quot;是四个单词但匹配 Q2&quot;</span>);</span><br><span class=line>        <span class=keyword>for</span> (Map.Entry&lt;String, String&gt; bindingKeyEntry : bindingKeyMap.entrySet()) &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>bindingKey</span> <span class=operator>=</span> bindingKeyEntry.getKey();</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> bindingKeyEntry.getValue();</span><br><span class=line>            channel.basicPublish(EXCHANGE_NAME, bindingKey, <span class=literal>null</span>, message.getBytes(<span class=string>&quot;UTF-8&quot;</span>));</span><br><span class=line>            System.out.println(<span class=string>&quot;生产者发出消息&quot;</span> + message);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>（2）消费者C1：中间带 orange 带 3 个单词的字符串(<code>*.orange.*</code>)</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">ReceiveLogsTopic01</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>EXCHANGE_NAME</span> <span class=operator>=</span> <span class=string>&quot;topic_logs&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>        channel.exchangeDeclare(EXCHANGE_NAME, <span class=string>&quot;topic&quot;</span>);</span><br><span class=line>        <span class=comment>//声明 Q1 队列与绑定关系</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> <span class=string>&quot;Q1&quot;</span>;</span><br><span class=line>        channel.queueDeclare(queueName, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>null</span>);</span><br><span class=line>        channel.queueBind(queueName, EXCHANGE_NAME, <span class=string>&quot;*.orange.*&quot;</span>);</span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息.....&quot;</span>);</span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(), <span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot; 接收队列 :&quot;</span> + queueName + <span class=string>&quot; 绑定 :&quot;</span> + delivery.getEnvelope().getRoutingKey() + <span class=string>&quot;,消息:&quot;</span> + message);</span><br><span class=line>        &#125;;</span><br><span class=line>        channel.basicConsume(queueName, <span class=literal>true</span>, deliverCallback, consumerTag -&gt; &#123;</span><br><span class=line>        &#125;);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>（3）消费者C2：最后一个单词是 rabbit 的 3 个单词(<code>*.*.rabbit</code>)和第一个单词是 lazy 的多个单词(lazy.#)</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">ReceiveLogsTopic02</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>EXCHANGE_NAME</span> <span class=operator>=</span> <span class=string>&quot;topic_logs&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>        channel.exchangeDeclare(EXCHANGE_NAME, <span class=string>&quot;topic&quot;</span>);</span><br><span class=line>        <span class=comment>//声明 Q2 队列与绑定关系</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>queueName</span> <span class=operator>=</span> <span class=string>&quot;Q2&quot;</span>;</span><br><span class=line>        channel.queueDeclare(queueName, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>null</span>);</span><br><span class=line>        channel.queueBind(queueName, EXCHANGE_NAME, <span class=string>&quot;*.*.rabbit&quot;</span>);</span><br><span class=line>        channel.queueBind(queueName, EXCHANGE_NAME, <span class=string>&quot;lazy.#&quot;</span>);</span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息.....&quot;</span>);</span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(), <span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot; 接收队列 :&quot;</span> + queueName + <span class=string>&quot; 绑定键:&quot;</span> + delivery.getEnvelope().getRoutingKey() + <span class=string>&quot;,消息:&quot;</span> + message);</span><br><span class=line>        &#125;;</span><br><span class=line>        channel.basicConsume(queueName, <span class=literal>true</span>, deliverCallback, consumerTag -&gt; &#123;</span><br><span class=line>        &#125;);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p>（1）生产者发送消息</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/22-21-57-e5cc4119c94e99741fbf55687198d1c2-image-20230520222156912-ae0793.png alt=image-20230520222156912></p><p>（2）消费者C1接收 中间带 orange 带 3 个单词的字符串(<code>*.orange.*</code>)</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/22-22-56-7d4bad3f6fabcb85a07a806493f29176-image-20230520222256774-69384b.png alt=image-20230520222256774></p><p>（3）消费者C2接收 最后一个单词是 rabbit 的 3 个单词(<code>*.*.rabbit</code>)和第一个单词是 lazy 的多个单词(lazy.#)</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/20/22-25-06-b8278ed0fa4faeda12c1f0d2a0ade259-image-20230520222505936-0f9f74.png alt=image-20230520222505936></p><h2 id=三、死信队列><a href=#三、死信队列 class=headerlink title=三、死信队列></a>三、死信队列</h2><h3 id=1-死信队列的概念><a href=#1-死信队列的概念 class=headerlink title="1. 死信队列的概念"></a>1. 死信队列的概念</h3><p>​ 先从概念解释上搞清楚这个定义，死信，顾名思义就是<strong>无法被消费的消息</strong>，字面意思可以这样理解，一般来说， producer 将消息投递到 broker 或者直接到 queue 里了， consumer 从 queue 取出消息进行消费，但某些时候由于特定的原因导致 queue 中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信，有死信自然就有了死信队列。</p><h3 id=2-应用场景><a href=#2-应用场景 class=headerlink title="2. 应用场景"></a>2. 应用场景</h3><ul><li>为了保证订单业务的消息数据不丢失，需要使用到 RabbitMQ 的死信队列机制，当消息消费发生异常时，将消息投入死信队列中；还有比如说: 用户在商城下单成功并点击去支付后在指定时间未支付时自动失效。</li><li>消息重试：在 RabbitMQ 中，当一个消息被拒绝或者处理失败时，可以将它发送到死信队列中并重新尝试处理。这种机制可以保证消息不会丢失，并且能够有效地避免因为某个消费者无法处理某些消息而导致整体系统出现问题。</li><li>消息延迟：RabbitMQ 支持对消息队列设置 TTL（Time To Live），当消息超过一定时间没有被消费者处理时，就会自动进入死信队列。这种机制可以实现消息的定时投递、过期删除以及异常处理等操作。</li><li>异常处理：在某些业务场景下，可能存在一些无法被消费者正常处理的消息，例如格式不正确的消息、包含敏感信息的消息等。通过将这些消息转发到死信队列中，可以便于后续进行人工处理和分析。</li></ul><h3 id=3-死信的来源><a href=#3-死信的来源 class=headerlink title="3. 死信的来源"></a>3. 死信的来源</h3><ul><li><p>消息 TTL 过期</p><p>TTL是Time To Live的缩写, 也就是生存时间</p></li><li><p>队列达到最大长度</p><p>队列满了，无法再添加数据到 mq 中</p></li><li><p>消息被拒绝</p><p>(basic.reject 或 basic.nack) 并且 requeue&#x3D;false.</p></li></ul><h3 id=4-死信实战><a href=#4-死信实战 class=headerlink title="4. 死信实战"></a>4. 死信实战</h3><h4 id=4-1-代码架构图><a href=#4-1-代码架构图 class=headerlink title="4.1 代码架构图"></a>4.1 代码架构图</h4><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/19-14-53-4ab76657c91915055615964697f04d6a-image-20230521191453712-e46470.png alt=image-20230521191453712></p><p>思路：生产者发送消息，通过直连交换机将消息发送到正常的队列(normal-queue)。若消息正常，则被消费者C1接收；若消息出现以下情况：</p><ul><li><p>消息 TTL 过期</p><p>TTL是Time To Live的缩写, 也就是生存时间</p></li><li><p>队列达到最大长度</p><p>队列满了，无法再添加数据到 mq 中</p></li><li><p>消息被拒绝</p><p>(basic.reject 或 basic.nack) 并且 requeue&#x3D;false.</p></li></ul><p>消息就会成为死信，然后被放入到死信队列，被消费者C2接收。</p><h4 id=4-2-消息-TTL-过期（代码demo8）><a href=#4-2-消息-TTL-过期（代码demo8） class=headerlink title="4.2 消息 TTL 过期（代码demo8）"></a>4.2 消息 TTL 过期（代码demo8）</h4><h5 id=4-2-1-代码分析><a href=#4-2-1-代码分析 class=headerlink title="4.2.1 代码分析"></a>4.2.1 代码分析</h5><p>（1）在生产者中给消息设置过期时间</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>AMQP.BasicProperties properties=<span class=keyword>new</span> <span class="title class_">AMQP</span>.BasicProperties()</span><br><span class=line>               .builder()</span><br><span class=line>               .expiration(<span class=string>&quot;10000&quot;</span>)</span><br><span class=line>               .build();</span><br></pre></td></tr></table></figure><p>然后通过for循环，模拟往队列中发送十条消息</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>for</span> (<span class=type>int</span> <span class=variable>i</span> <span class=operator>=</span> <span class=number>1</span>; i &lt; <span class=number>11</span>; i++) &#123;</span><br><span class=line>           <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=string>&quot;info&quot;</span> + i;</span><br><span class=line>           channel.basicPublish(NORMAL_EXCHANGE, <span class=string>&quot;zhangsan&quot;</span>, properties, message.getBytes());</span><br><span class=line>           System.out.println(<span class=string>&quot;生产者发送消息:&quot;</span> + message);</span><br><span class=line>       &#125;</span><br></pre></td></tr></table></figure><p>拓展： AMQP.BasicProperties中的所有参数如下</p><ul><li>content_type：消息正文的 MIME 类型。通常可以设置成 JSON、XML、PLAIN_TEXT、BINARY 等格式。</li><li>content_encoding：消息正文编码格式。通常可以设置成 UTF-8、GBK、ISO-8859-1 等编码格式。</li><li>delivery_mode：消息投递模式。可选值包括 1 和 2，其中 1 表示消息非持久化，2 表示消息持久化。如果设置为 2，则消息会被写入磁盘中。</li><li>priority：消息优先级，取值范围为 0~9，值越大优先级越高。默认值为 0。</li><li>correlation_id：关联 ID，用于关联多个消息之间的关系。</li><li>reply_to：回复队列名字，表示需要返回处理结果的队列名称。</li><li>expiration：消息过期时间，单位为毫秒。</li><li>message_id：消息 ID，用于标识消息的唯一性。</li><li>timestamp：消息创建时间戳。</li><li>type：消息类型，用于区分不同类型的消息。例如，订阅主题模式时该值可以指定为 Topic。</li></ul><p>（2）消费者C1：</p><ul><li>首先，我们需要接收正常的消息，所以需要声明正常的队列和正常交换机。</li><li>其次，若消息异常，我们需要将消息发往死信队列，所以需要声明死信队列和死信交换机。</li><li>最后是将正常交换机与正常队列绑定，将死信队列和死信交换机绑定。</li></ul><p>代码的难度在于，如何在正常队列中设置死信交换机。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>queueDeclare(String queue, <span class=type>boolean</span> durable, <span class=type>boolean</span> exclusive, <span class=type>boolean</span> autoDelete, Map&lt;String, Object&gt; arguments)</span><br></pre></td></tr></table></figure><p>可以在声明队列函数的第五个参数里设置</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line>Map&lt;String, Object&gt; arguments=<span class=keyword>new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class=line><span class=comment>//过期时间 10000ms=10s   ,也可以在消费者发送时设置过期时间</span></span><br><span class=line>arguments.put(<span class=string>&quot;x-message-ttl&quot;</span>,<span class=number>10000</span>);</span><br><span class=line><span class=comment>//正常队列设置死信交换机 //////////////////////////</span></span><br><span class=line>arguments.put(<span class=string>&quot;x-dead-letter-exchange&quot;</span>,DEAD_EXCHANGE);</span><br><span class=line><span class=comment>//设置死信交换机的routingKey</span></span><br><span class=line>arguments.put(<span class=string>&quot;x-dead-letter-routing-key&quot;</span>,<span class=string>&quot;lisi&quot;</span>);</span><br><span class=line>channel.queueDeclare(NORMAL_QUEUE,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>false</span>,arguments);</span><br></pre></td></tr></table></figure><h5 id=4-2-2-代码><a href=#4-2-2-代码 class=headerlink title="4.2.2 代码"></a>4.2.2 代码</h5><p>（1）生产者：</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Producer</span> &#123;</span><br><span class=line>    <span class=comment>//普通交换机</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String NORMAL_EXCHANGE=<span class=string>&quot;normal_exchange&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span><span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line></span><br><span class=line>        <span class=comment>//声明普通交换机 类型为 direct</span></span><br><span class=line>        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class=line>        <span class=comment>//设置消息的 TTL 时间</span></span><br><span class=line>        AMQP.BasicProperties properties=<span class=keyword>new</span> <span class="title class_">AMQP</span>.BasicProperties()</span><br><span class=line>                .builder()</span><br><span class=line>                .expiration(<span class=string>&quot;10000&quot;</span>)</span><br><span class=line>                .build();</span><br><span class=line></span><br><span class=line>        <span class=comment>//该信息是用作演示队列个数限制</span></span><br><span class=line>        <span class=keyword>for</span> (<span class=type>int</span> <span class=variable>i</span> <span class=operator>=</span> <span class=number>1</span>; i &lt; <span class=number>11</span>; i++) &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=string>&quot;info&quot;</span> + i;</span><br><span class=line>            channel.basicPublish(NORMAL_EXCHANGE, <span class=string>&quot;zhangsan&quot;</span>, properties, message.getBytes());</span><br><span class=line>            System.out.println(<span class=string>&quot;生产者发送消息:&quot;</span> + message);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>（2）消费者C1：</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Consumer1</span> &#123;</span><br><span class=line>    <span class=comment>//普通交换机的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String NORMAL_EXCHANGE=<span class=string>&quot;normal_exchange&quot;</span>;</span><br><span class=line>    <span class=comment>//死信交换机的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String DEAD_EXCHANGE=<span class=string>&quot;dead_exchange&quot;</span>;</span><br><span class=line>    <span class=comment>//普通队列的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String NORMAL_QUEUE=<span class=string>&quot;normal_queue&quot;</span>;</span><br><span class=line>    <span class=comment>//死信队列的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String DEAD_QUEUE=<span class=string>&quot;dead_queue&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span><span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line></span><br><span class=line>        <span class=comment>//声明死信交换机和普通交换机 类型为direct</span></span><br><span class=line>        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class=line>        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class=line></span><br><span class=line>        <span class=comment>//声明普通队列</span></span><br><span class=line>        Map&lt;String, Object&gt; arguments=<span class=keyword>new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class=line>        <span class=comment>//过期时间 10000ms=10s   ,也可以在消费者发送时设置过期时间</span></span><br><span class=line><span class=comment>//        arguments.put(&quot;x-message-ttl&quot;,10000);</span></span><br><span class=line></span><br><span class=line>        <span class=comment>//正常队列设置死信交换机 //////////////////////////</span></span><br><span class=line>        arguments.put(<span class=string>&quot;x-dead-letter-exchange&quot;</span>,DEAD_EXCHANGE);</span><br><span class=line>        <span class=comment>//设置死信交换机的routingKey</span></span><br><span class=line>        arguments.put(<span class=string>&quot;x-dead-letter-routing-key&quot;</span>,<span class=string>&quot;lisi&quot;</span>);</span><br><span class=line>        channel.queueDeclare(NORMAL_QUEUE,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>false</span>,arguments);</span><br><span class=line></span><br><span class=line>        <span class=comment>//声明死信队列 //////////////////////////</span></span><br><span class=line>        channel.queueDeclare(DEAD_QUEUE,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>null</span>);</span><br><span class=line></span><br><span class=line>        <span class=comment>//将普通的交换机与普通的队列绑定</span></span><br><span class=line>        channel.queueBind(NORMAL_QUEUE,NORMAL_EXCHANGE,<span class=string>&quot;zhansan&quot;</span>);</span><br><span class=line>        <span class=comment>//将死信交换机与死信队列绑定</span></span><br><span class=line>        channel.queueBind(DEAD_QUEUE,DEAD_EXCHANGE,<span class=string>&quot;lisi&quot;</span>);</span><br><span class=line></span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息.......&quot;</span>);</span><br><span class=line></span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(),<span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot;Consumer01 接收到消息:&quot;</span>+message);</span><br><span class=line>        &#125;;</span><br><span class=line></span><br><span class=line>        <span class=comment>//接收消息</span></span><br><span class=line>        channel.basicConsume(NORMAL_QUEUE,<span class=literal>true</span>,deliverCallback,consumerTag -&gt; &#123;&#125;);</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>（3）消费者C2：</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Consumer2</span> &#123;</span><br><span class=line>    <span class=comment>//死信交换机的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String DEAD_EXCHANGE=<span class=string>&quot;dead_exchange&quot;</span>;</span><br><span class=line>    <span class=comment>//死信队列的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String DEAD_QUEUE=<span class=string>&quot;dead_queue&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line>        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class=line>        <span class=comment>//声明队列与绑定关系</span></span><br><span class=line>        channel.queueDeclare(DEAD_QUEUE, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>false</span>, <span class=literal>null</span>);</span><br><span class=line>        channel.queueBind(DEAD_QUEUE, DEAD_EXCHANGE, <span class=string>&quot;lisi&quot;</span>);</span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息.....&quot;</span>);</span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(), <span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            System.out.println(<span class=string>&quot; 接收队列 :&quot;</span> + DEAD_QUEUE + <span class=string>&quot;,消息:&quot;</span> + message);</span><br><span class=line>        &#125;;</span><br><span class=line>        channel.basicConsume(DEAD_QUEUE, <span class=literal>true</span>, deliverCallback, consumerTag -&gt; &#123;</span><br><span class=line>        &#125;);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h5 id=4-2-3-测试><a href=#4-2-3-测试 class=headerlink title="4.2.3 测试"></a>4.2.3 测试</h5><p>（1）预期效果：我们先启动消费者C1，此时会声明正常队列和交换机、死信交换机和队列，然后将消费者C1关闭。启动生产者发送消息，这时没有消费者来接收消息，10S后消息过期，过期的消息将被添加到死信队列中，由消费者C2消费</p><p>（2）运行</p><p>启动消费者C1然后关闭</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/21-05-07-8d0a35fa3d50b131e1e46ebcd2bdc0e4-image-20230521210507130-148ec3.png alt=image-20230521210507130></p><p>此时队列已经声明</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/21-06-11-0ad05a7880f1bd776300130f679b33cc-image-20230521210611173-07981d.png alt=image-20230521210611173></p><p>启动生产者发送消息</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/21-07-00-e25b062a3b19c36b1b269e9a2bbbc57c-image-20230521210700519-8336ff.png alt=image-20230521210700519></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/21-17-24-30cd472ce71f7c8c883992cca41a3e36-image-20230521211724259-a9bc08.png alt=image-20230521211724259></p><p>10S后</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/21-18-29-cce38c5311639586c91ae2848021724a-image-20230521211829314-f38621.png alt=image-20230521211829314></p><p>启动消费者C2</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/21-24-38-ffa11f03e22ce09b86467581b26b30c9-image-20230521212438889-073e79.png alt=image-20230521212438889></p><h4 id=4-3-队列达到最大长度（代码demo9）><a href=#4-3-队列达到最大长度（代码demo9） class=headerlink title="4.3 队列达到最大长度（代码demo9）"></a>4.3 队列达到最大长度（代码demo9）</h4><h5 id=4-3-1-代码更改><a href=#4-3-1-代码更改 class=headerlink title="4.3.1 代码更改"></a>4.3.1 代码更改</h5><p>（1）消息生产者代码去掉 TTL 属性</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Producer</span> &#123;</span><br><span class=line>    <span class=comment>//普通交换机</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String NORMAL_EXCHANGE=<span class=string>&quot;normal_exchange&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span><span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line></span><br><span class=line>        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class=line></span><br><span class=line>        <span class=keyword>for</span> (<span class=type>int</span> <span class=variable>i</span> <span class=operator>=</span> <span class=number>1</span>; i &lt; <span class=number>11</span>; i++) &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=string>&quot;info&quot;</span> + i;</span><br><span class=line>            channel.basicPublish(NORMAL_EXCHANGE, <span class=string>&quot;zhangsan&quot;</span>, <span class=literal>null</span>, message.getBytes());</span><br><span class=line>            System.out.println(<span class=string>&quot;生产者发送消息:&quot;</span> + message);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>（2）C1 消费者修改以下代码(启动之后关闭该消费者 模拟其接收不到消息 )</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/21-58-17-c245f29e18bcec413bddd5a07bf27218-image-20230521215817461-5efa45.png alt=image-20230521215817461></p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=comment>//设置正常队列的长度限制 消息超过6条，超过的条数发送给死信队列</span></span><br><span class=line>arguments.put(<span class=string>&quot;x-max-length&quot;</span>,<span class=number>6</span>);</span><br></pre></td></tr></table></figure><p>（3）C2 消费者代码不变</p><h5 id=4-3-2-测试><a href=#4-3-2-测试 class=headerlink title="4.3.2 测试"></a>4.3.2 测试</h5><p>（1）因为我们在消费者C1中添加了消息的长度设置，所以在测试之前，需要删除之前的队列重新启动消费者C1声明。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/22-03-53-e9a6888d4673499e63216922abbacb6a-image-20230521220353671-efb0b7.png alt=image-20230521220353671></p><p>（2）启动消费C1然后关闭，启动生产者发送消息</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/22-07-21-18b716991acb0aaf2483baf10dfb2c13-image-20230521220721130-1b7c67.png alt=image-20230521220721130></p><p>​ 由于正常队列中设置了最多存6条消息，所以发送的10条消息中，有4条消息在死信队列中。</p><h4 id=4-4-消息被拒绝><a href=#4-4-消息被拒绝 class=headerlink title="4.4 消息被拒绝"></a>4.4 消息被拒绝</h4><h5 id=4-4-1-代码更改（在demo9的基础上更改）><a href=#4-4-1-代码更改（在demo9的基础上更改） class=headerlink title="4.4.1 代码更改（在demo9的基础上更改）"></a>4.4.1 代码更改（在demo9的基础上更改）</h5><p>（1）消息生产者代码同4.3生产者一致</p><p>（2）C3消费者代码(启动之后关闭该消费者 模拟其接收不到消息)</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Consumer3</span> &#123;</span><br><span class=line>    <span class=comment>//普通交换机的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String NORMAL_EXCHANGE=<span class=string>&quot;normal_exchange&quot;</span>;</span><br><span class=line>    <span class=comment>//死信交换机的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String DEAD_EXCHANGE=<span class=string>&quot;dead_exchange&quot;</span>;</span><br><span class=line>    <span class=comment>//普通队列的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String NORMAL_QUEUE=<span class=string>&quot;normal_queue&quot;</span>;</span><br><span class=line>    <span class=comment>//死信队列的名称</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String DEAD_QUEUE=<span class=string>&quot;dead_queue&quot;</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span><span class=keyword>throws</span> Exception &#123;</span><br><span class=line>        <span class=type>Channel</span> <span class=variable>channel</span> <span class=operator>=</span> RabbitMQUtil.getChannel();</span><br><span class=line></span><br><span class=line>        <span class=comment>//声明死信交换机和普通交换机 类型为direct</span></span><br><span class=line>        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class=line>        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class=line></span><br><span class=line>        <span class=comment>//声明普通队列</span></span><br><span class=line>        Map&lt;String, Object&gt; arguments=<span class=keyword>new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class=line>        <span class=comment>//正常队列设置死信交换机</span></span><br><span class=line>        arguments.put(<span class=string>&quot;x-dead-letter-exchange&quot;</span>,DEAD_EXCHANGE);</span><br><span class=line>        <span class=comment>//设置死信交换机的routingKey</span></span><br><span class=line>        arguments.put(<span class=string>&quot;x-dead-letter-routing-key&quot;</span>,<span class=string>&quot;lisi&quot;</span>);</span><br><span class=line></span><br><span class=line>        channel.queueDeclare(NORMAL_QUEUE,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>false</span>,arguments);</span><br><span class=line></span><br><span class=line>        <span class=comment>//声明死信队列</span></span><br><span class=line>        channel.queueDeclare(DEAD_QUEUE,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>false</span>,<span class=literal>null</span>);</span><br><span class=line></span><br><span class=line>        <span class=comment>//将普通的交换机与普通的队列绑定</span></span><br><span class=line>        channel.queueBind(NORMAL_QUEUE,NORMAL_EXCHANGE,<span class=string>&quot;zhangsan&quot;</span>);</span><br><span class=line>        <span class=comment>//将死信交换机与死信队列绑定</span></span><br><span class=line>        channel.queueBind(DEAD_QUEUE,DEAD_EXCHANGE,<span class=string>&quot;lisi&quot;</span>);</span><br><span class=line></span><br><span class=line>        System.out.println(<span class=string>&quot;等待接收消息.......&quot;</span>);</span><br><span class=line></span><br><span class=line>        <span class=type>DeliverCallback</span> <span class=variable>deliverCallback</span> <span class=operator>=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class=line>            <span class=type>String</span> <span class=variable>message</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">String</span>(delivery.getBody(),<span class=string>&quot;UTF-8&quot;</span>);</span><br><span class=line>            <span class=keyword>if</span> (message.equals(<span class=string>&quot;info5&quot;</span>)) &#123;</span><br><span class=line>                System.out.println(<span class=string>&quot;Consumer03 接收到消息&quot;</span> + message + <span class=string>&quot;并拒绝签收该消息&quot;</span>);</span><br><span class=line>                <span class=comment>//requeue 设置为 false 代表拒绝重新入队 该队列如果配置了死信交换机将发送到死信队列中</span></span><br><span class=line>                channel.basicReject(delivery.getEnvelope().getDeliveryTag(), <span class=literal>false</span>);</span><br><span class=line>            &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>                System.out.println(<span class=string>&quot;Consumer03 接收到消息&quot;</span> + message);</span><br><span class=line>                channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class=literal>false</span>);</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;;</span><br><span class=line></span><br><span class=line>        <span class=comment>//接收消息,要想拒绝消息，得开启手动应答 也就是  autoAck=false</span></span><br><span class=line>        channel.basicConsume(NORMAL_QUEUE,<span class=literal>false</span>,deliverCallback,consumerTag -&gt; &#123;&#125;);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>拓展：channel.basicReject中各参数</p><ul><li>deliveryTag：标识符，用于表示当前处理的是哪一个消息。</li><li>requeue：是否需要重新入队列。如果为 true，则表示 RabbitMQ 会重新将这条消息放回从它原始队列中出发到此处(consumer)未发生拒绝确认的队尾；如果为 false，则表示直接丢弃掉该消息。</li></ul><p>​ 总之，channel.basicReject 方法用于将消息发送回 RabbitMQ 服务器以进行重新处理，并可通过 requeue 参数控制消息重新入队列还是直接丢弃。由于 requeue 参数可能会引起消息死循环等问题，因此应该慎重使用。通常情况下，我们建议使用 channel.basicNack 方法而非 channel.basicReject 方法来实现消息的拒绝确认功能。</p><h5 id=4-4-2-测试><a href=#4-4-2-测试 class=headerlink title="4.4.2 测试"></a>4.4.2 测试</h5><p>（1）在测试之前，先将之前队列中的数据清除（保持原始状态），因为将正常队列中消息的最大数量删除后，所以删除队列重新声明</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/22-26-29-0902e7a35888ebffda0e877c88da1981-image-20230521222629162-a52496.png alt=image-20230521222629162></p><p>（2）启动生产者发送消息</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/22-32-21-4608a617232dc1334ef66336d7427e20-image-20230521223220930-2750e6.png alt=image-20230521223220930></p><p>（3）启动消费者 C3。<img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/22-33-49-7deb39113ea8d7fff647a4a082fa9f1c-image-20230521223349303-6aff29.png alt=image-20230521223349303></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/22-34-35-4c56bf1d7344aba31d07869005928d8d-image-20230521223435884-37672f.png alt=image-20230521223435884></p><p>消息info5被拒收，被发送给了死信队列，其余消息被正常消费。</p><p>（4）最后启动消费者C2，将死信队列中的info5消息消费。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/yuydot/Picture/2023/05/21/22-36-55-ae7e2db7299e6448707c5504859104ca-image-20230521223655765-a13151.png alt=image-20230521223655765></p></article><div class=post-copyright><div class=post-copyright__title><span class=post-copyright-info><h>RabbtMQ教程二</h></span></div><div class=post-copyright__type><span class=post-copyright-info><a href="https://yuydot.gitee.io/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/">https://yuydot.gitee.io/2023/05/17/RabbtMQ教程二/</a></span></div><div class=post-copyright-m><div class=post-copyright-m-info><div class=post-copyright-a><h>作者</h><div class=post-copyright-cc-info><h>yuydot</h></div></div><div class=post-copyright-c><h>发布于</h><div class=post-copyright-cc-info><h>2023-05-17</h></div></div><div class=post-copyright-u><h>更新于</h><div class=post-copyright-cc-info><h>2023-05-21</h></div></div><div class=post-copyright-c><h>许可协议</h><div class=post-copyright-cc-info><a class=icon rel=noopener target=_blank title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel=noopener target=_blank title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href="/tags/RabbitMQ/">RabbitMQ</a></div><div class=post_share><div class=social-share data-image=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-y8622k_2560x1600.png data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css media=print onload="this.media='all'"><script src=https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js defer></script></div></div><nav class=pagination-post id=pagination><div class="next-post pull-full"><a href="/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/" title=RabbtMQ教程一><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-9mjoy1_2560x1600.png onerror="onerror=null;src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt="cover of next post"><div class=pagination-info><div class=label>下一篇</div><div class=next_info>RabbtMQ教程一</div></div></a></div></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class=relatedPosts-list><div><a href="/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/" title=RabbtMQ教程一><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-9mjoy1_2560x1600.png alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2023-05-09</div><div class=title>RabbtMQ教程一</div></div></a></div></div></div><hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span>评论</span></div></div><div class=comment-wrap><div><div class=vcomment id=vcomment></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info"><div class=is-center><div class=avatar-img><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wang.jpg onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/friend_404.gif'" alt=avatar></div><div class=author-info__name>yuydot</div><div class=author-info__description>好像稍不努力，连快乐都养不起</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class=headline>文章</div><div class=length-num>19</div></a><a href="/tags/"><div class=headline>标签</div><div class=length-num>10</div></a><a href="/categories/"><div class=headline>分类</div><div class=length-num>5</div></a></div><a id=card-info-btn target=_blank rel=noopener href=https://github.com/Yuydot><i class="fab fa-github"></i><span>Follow Me</span><i class="faa-passing animated" style=padding-left:20px;display:inline-block;vertical-align:middle;><svg class=icon style=height:28px;width:28px;fill:currentColor;position:relative;top:5px><use xlink:href=#icon-xiaoqiche></use></svg></i></a><div class="card-info-social-icons is-center"><a class=social-icon href=https://github.com/Yuydot target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:1586488524@qq.com target=_blank title=Email><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class=announcement_content>This is my Blog <img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C.gif height=200 width=236></div><div id=welcome-info></div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>目录</span><span class=toc-percentage></span></div><div class=toc-content><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%80%E3%80%81%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4><span class=toc-number>1.</span> <span class=toc-text>一、发布确认</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E9%80%BB%E8%BE%91><span class=toc-number>1.1.</span> <span class=toc-text>1. 发布确认逻辑</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#2-%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E7%9A%84%E7%AD%96%E7%95%A5%EF%BC%88%E4%BB%A3%E7%A0%81demo4%EF%BC%89><span class=toc-number>1.2.</span> <span class=toc-text>2. 发布确认的策略（代码demo4）</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#2-1-%E5%BC%80%E5%90%AF%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E7%9A%84%E6%96%B9%E6%B3%95><span class=toc-number>1.2.1.</span> <span class=toc-text>2.1 开启发布确认的方法:</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#2-2-%E5%8D%95%E4%B8%AA%E7%A1%AE%E8%AE%A4%E5%8F%91%E5%B8%83><span class=toc-number>1.2.2.</span> <span class=toc-text>2.2 单个确认发布</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#2-3-%E6%89%B9%E9%87%8F%E7%A1%AE%E8%AE%A4%E5%8F%91%E5%B8%83><span class=toc-number>1.2.3.</span> <span class=toc-text>2.3 批量确认发布</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#2-4-%E5%BC%82%E6%AD%A5%E7%A1%AE%E8%AE%A4%E5%8F%91%E5%B8%83><span class=toc-number>1.2.4.</span> <span class=toc-text>2.4 异步确认发布</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#2-5-%E6%B5%8B%E8%AF%95%E4%B8%89%E7%A7%8D%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E6%96%B9%E5%BC%8F><span class=toc-number>1.2.5.</span> <span class=toc-text>2.5 测试三种发布确认方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%BA%8C%E3%80%81%E4%BA%A4%E6%8D%A2%E6%9C%BA><span class=toc-number>2.</span> <span class=toc-text>二、交换机</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-Exchanges><span class=toc-number>2.1.</span> <span class=toc-text>1. Exchanges</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#1-1-Exchanges%E6%A6%82%E5%BF%B5><span class=toc-number>2.1.1.</span> <span class=toc-text>1.1 Exchanges概念</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#1-2-Exchanges%E7%B1%BB%E5%9E%8B><span class=toc-number>2.1.2.</span> <span class=toc-text>1.2 Exchanges类型</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#1-3-%E6%97%A0%E5%90%8Dexchange%EF%BC%88%E9%BB%98%E8%AE%A4%E4%BA%A4%E6%8D%A2%E6%9C%BA%EF%BC%89><span class=toc-number>2.1.3.</span> <span class=toc-text>1.3 无名exchange（默认交换机）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#2-%E4%B8%B4%E6%97%B6%E9%98%9F%E5%88%97><span class=toc-number>2.2.</span> <span class=toc-text>2. 临时队列</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#3-%E7%BB%91%E5%AE%9A-bindings><span class=toc-number>2.3.</span> <span class=toc-text>3. 绑定 bindings</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#4-Fanout-exchange><span class=toc-number>2.4.</span> <span class=toc-text>4. Fanout exchange</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#4-1-Fanout-exchange%EF%BC%88%E6%89%87%E5%BD%A2%E4%BA%A4%E6%8D%A2%E6%9C%BA%EF%BC%89%E4%BB%8B%E7%BB%8D><span class=toc-number>2.4.1.</span> <span class=toc-text>4.1. Fanout exchange（扇形交换机）介绍</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#4-2-Fanout%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF><span class=toc-number>2.4.2.</span> <span class=toc-text>4.2 Fanout使用场景</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#4-3-Fanout-%E5%AE%9E%E6%88%98-%EF%BC%88%E4%BB%A3%E7%A0%81demo5%EF%BC%89><span class=toc-number>2.4.3.</span> <span class=toc-text>4.3 Fanout 实战 （代码demo5）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#5-Direct-exchange><span class=toc-number>2.5.</span> <span class=toc-text>5. Direct exchange</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#5-1-%E5%9B%9E%E9%A1%BE><span class=toc-number>2.5.1.</span> <span class=toc-text>5.1 回顾</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-2-Direct-exchange-%EF%BC%88%E7%9B%B4%E8%BF%9E%E4%BA%A4%E6%8D%A2%E6%9C%BA%EF%BC%89%E4%BB%8B%E7%BB%8D><span class=toc-number>2.5.2.</span> <span class=toc-text>5.2 Direct exchange （直连交换机）介绍</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-3-Direct-Exchange%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF><span class=toc-number>2.5.3.</span> <span class=toc-text>5.3 Direct Exchange使用场景</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-4-%E5%A4%9A%E9%87%8D%E7%BB%91%E5%AE%9A><span class=toc-number>2.5.4.</span> <span class=toc-text>5.4 多重绑定</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-5-Direct%E5%92%8CFanout%E7%9A%84%E5%8C%BA%E5%88%AB><span class=toc-number>2.5.5.</span> <span class=toc-text>5.5 Direct和Fanout的区别</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-5-Direct-%E5%AE%9E%E6%88%98%EF%BC%88%E4%BB%A3%E7%A0%81demo6%EF%BC%89><span class=toc-number>2.5.6.</span> <span class=toc-text>5.5 Direct 实战（代码demo6）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#6-Topics-Exchange><span class=toc-number>2.6.</span> <span class=toc-text>6. Topics Exchange</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#6-1-%E5%9B%9E%E9%A1%BE><span class=toc-number>2.6.1.</span> <span class=toc-text>6.1 回顾</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#6-2-Topic-exchange%EF%BC%88%E4%B8%BB%E9%A2%98%E4%BA%A4%E6%8D%A2%E6%9C%BA%EF%BC%89%E4%BB%8B%E7%BB%8D><span class=toc-number>2.6.2.</span> <span class=toc-text>6.2 Topic exchange（主题交换机）介绍</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#6-3-Topic%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF><span class=toc-number>2.6.3.</span> <span class=toc-text>6.3 Topic的使用场景</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#6-3-Topic-%E7%9A%84%E8%A6%81%E6%B1%82><span class=toc-number>2.6.4.</span> <span class=toc-text>6.3 Topic 的要求</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#6-4-Topic-%E5%8C%B9%E9%85%8D%E6%A1%88%E4%BE%8B><span class=toc-number>2.6.5.</span> <span class=toc-text>6.4 Topic 匹配案例</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#6-5-Topic%E5%AE%9E%E6%88%98%EF%BC%88%E4%BB%A3%E7%A0%81demo7%EF%BC%89><span class=toc-number>2.6.6.</span> <span class=toc-text>6.5 Topic实战（代码demo7）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%89%E3%80%81%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97><span class=toc-number>3.</span> <span class=toc-text>三、死信队列</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%E7%9A%84%E6%A6%82%E5%BF%B5><span class=toc-number>3.1.</span> <span class=toc-text>1. 死信队列的概念</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#2-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF><span class=toc-number>3.2.</span> <span class=toc-text>2. 应用场景</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#3-%E6%AD%BB%E4%BF%A1%E7%9A%84%E6%9D%A5%E6%BA%90><span class=toc-number>3.3.</span> <span class=toc-text>3. 死信的来源</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#4-%E6%AD%BB%E4%BF%A1%E5%AE%9E%E6%88%98><span class=toc-number>3.4.</span> <span class=toc-text>4. 死信实战</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#4-1-%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84%E5%9B%BE><span class=toc-number>3.4.1.</span> <span class=toc-text>4.1 代码架构图</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#4-2-%E6%B6%88%E6%81%AF-TTL-%E8%BF%87%E6%9C%9F%EF%BC%88%E4%BB%A3%E7%A0%81demo8%EF%BC%89><span class=toc-number>3.4.2.</span> <span class=toc-text>4.2 消息 TTL 过期（代码demo8）</span></a><ol class=toc-child><li class="toc-item toc-level-5"><a class=toc-link href=#4-2-1-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90><span class=toc-number>3.4.2.1.</span> <span class=toc-text>4.2.1 代码分析</span></a></li><li class="toc-item toc-level-5"><a class=toc-link href=#4-2-2-%E4%BB%A3%E7%A0%81><span class=toc-number>3.4.2.2.</span> <span class=toc-text>4.2.2 代码</span></a></li><li class="toc-item toc-level-5"><a class=toc-link href=#4-2-3-%E6%B5%8B%E8%AF%95><span class=toc-number>3.4.2.3.</span> <span class=toc-text>4.2.3 测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class=toc-link href=#4-3-%E9%98%9F%E5%88%97%E8%BE%BE%E5%88%B0%E6%9C%80%E5%A4%A7%E9%95%BF%E5%BA%A6%EF%BC%88%E4%BB%A3%E7%A0%81demo9%EF%BC%89><span class=toc-number>3.4.3.</span> <span class=toc-text>4.3 队列达到最大长度（代码demo9）</span></a><ol class=toc-child><li class="toc-item toc-level-5"><a class=toc-link href=#4-3-1-%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%94%B9><span class=toc-number>3.4.3.1.</span> <span class=toc-text>4.3.1 代码更改</span></a></li><li class="toc-item toc-level-5"><a class=toc-link href=#4-3-2-%E6%B5%8B%E8%AF%95><span class=toc-number>3.4.3.2.</span> <span class=toc-text>4.3.2 测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class=toc-link href=#4-4-%E6%B6%88%E6%81%AF%E8%A2%AB%E6%8B%92%E7%BB%9D><span class=toc-number>3.4.4.</span> <span class=toc-text>4.4 消息被拒绝</span></a><ol class=toc-child><li class="toc-item toc-level-5"><a class=toc-link href=#4-4-1-%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%94%B9%EF%BC%88%E5%9C%A8demo9%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8A%E6%9B%B4%E6%94%B9%EF%BC%89><span class=toc-number>3.4.4.1.</span> <span class=toc-text>4.4.1 代码更改（在demo9的基础上更改）</span></a></li><li class="toc-item toc-level-5"><a class=toc-link href=#4-4-2-%E6%B5%8B%E8%AF%95><span class=toc-number>3.4.4.2.</span> <span class=toc-text>4.4.2 测试</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>最新文章</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href="/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/" title=RabbtMQ教程二><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-y8622k_2560x1600.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=RabbtMQ教程二></a><div class=content><a class=title href="/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/" title=RabbtMQ教程二>RabbtMQ教程二</a><time datetime=2023-05-17T13:04:40.000Z title="发表于 2023-05-17 21:04:40">2023-05-17</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/" title=RabbtMQ教程一><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-9mjoy1_2560x1600.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=RabbtMQ教程一></a><div class=content><a class=title href="/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/" title=RabbtMQ教程一>RabbtMQ教程一</a><time datetime=2023-05-09T11:51:28.000Z title="发表于 2023-05-09 19:51:28">2023-05-09</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/05/06/MySQL%E8%BF%9B%E9%98%B6/" title=MySQL进阶><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-73e7me_2560x1600.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=MySQL进阶></a><div class=content><a class=title href="/2023/05/06/MySQL%E8%BF%9B%E9%98%B6/" title=MySQL进阶>MySQL进阶</a><time datetime=2023-05-06T02:23:18.000Z title="发表于 2023-05-06 10:23:18">2023-05-06</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/05/04/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/" title=Redis分布式缓存><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-zygeko_2560x1601.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=Redis分布式缓存></a><div class=content><a class=title href="/2023/05/04/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/" title=Redis分布式缓存>Redis分布式缓存</a><time datetime=2023-05-04T08:58:45.000Z title="发表于 2023-05-04 16:58:45">2023-05-04</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/04/19/Mapstruct%E5%B7%A5%E5%85%B7/" title=Mapstruct工具><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/502997c6c932d8f8028954ee7fb88d2c.jpg onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=Mapstruct工具></a><div class=content><a class=title href="/2023/04/19/Mapstruct%E5%B7%A5%E5%85%B7/" title=Mapstruct工具>Mapstruct工具</a><time datetime=2023-04-19T12:30:42.000Z title="发表于 2023-04-19 20:30:42">2023-04-19</time></div></div></div></div></div></div></main><footer id=footer><div id=footer-wrap><div id=ft><div class=ft-item-1><div class=t-top><div class=t-t-l><p class="ft-t t-l-t">格言🧬</p><div class=bg-ad><div>我不再装模作样地拥有很多朋友，而是回到了孤单之中，以真正的我开始了独自的生活。有时我也会因为寂寞而难以忍受空虚的折磨，但我宁愿以这样的方式来维护自己的自尊，也不愿以耻辱为代价去换取那种表面的朋友。✨</div><div class=btn-xz-box><a class=btn-xz target=_blank rel=noopener href="https://stellarium.org/">点击开启星辰之旅</a></div></div></div><div class=t-t-r><p class="ft-t t-l-t">猜你想看💡</p><ul class=ft-links><li><a href="/shuoshuo/">分享生活</a><a href="/box/nav/">网址导航</a></li><li><a href="/social/links/">我的朋友</a><a href="/messageboard/">留点什么</a></li><li><a href="/personal/about/">关于作者</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li><li><a href="/box/Gallery/">我的画廊</a><a href="/personal/bb/">我的唠叨</a></li><li><a href="/site/time/">建设进程</a><a href="/site/census/">网站统计</a></li></ul></div></div></div><div class=ft-item-2><p class=ft-t>推荐友链⌛</p><div class=ft-img-group><div class=img-group-item><a target=_blank rel=noopener href="https://www.fomal.cc/" title=Fomalhaut🥝><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224623.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://tzy1997.com/" title=唐志远の博客><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224801.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://akilar.top/" title=Akilarの糖果屋><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224820.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://butterfly.js.org/" title=Butterfly><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224710.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://anzhiy.cn/" title=安知鱼><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224841.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://www.acozycotage.net/" title=Acozycotage><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224859.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://cdn.netdun.net/" title=网盾星球><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224948.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://blog.leonus.cn/" title=Leonus><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224927.png></a></div></div></div></div><div class=copyright><span><b>&copy;2023</b></span><span><b>&nbsp;&nbsp;By yuydot</b></span></div><div id=workboard></div><p id=ghbdages></p></div></footer></div><div id=rightside><div id=rightside-config-hide><button id=readmode type=button title=阅读模式><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick=switchNightMode() title=浅色和深色模式转换><svg width=25 height=25 viewbox="0 0 1024 1024"><use id=modeicon xlink:href=#icon-moon></use></svg></a><button id=hide-aside-btn type=button title=单栏和双栏切换><i class="fas fa-arrows-alt-h"></i></button></div><div id=rightside-config-show><button id=rightside_config type=button title=设置><i class="fas fa-cog fa-spin"></i></button><button class=close id=mobile-toc-button type=button title=目录><i class="fas fa-list-ul"></i></button><button id=chat_btn type=button title=聊天><i class="fas fa-sms"></i></button><a id=to_comment href=#post-comment title=直达评论><i class="fas fa-comments"></i></a><button id=go-up type=button title=回到顶部><span class=scroll-percent></span><i class="fas fa-arrow-up"><span id=percent>0<span>%</span></span></i></button><button id=go-down type=button title=直达底部 onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src=/js/utils.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/4.0.31/fancybox.umd.min.js></script><script src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js></script><div class=js-pjax><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'AQGZMCqJVLEhHK6FvPAjGaz9-gzGzoHsz',
      appKey: 'OG699oy4JvBM9mTDwTovhlTO',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.16/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src=/js/jquery-3.6.0.min.js></script><script src=/js/weather.js></script><script src=/js/footer.js></script><script defer data-pjax src=/js/readPercent.js></script><div class="aplayer no-destroy" data-id=148314925 data-server=netease data-type=playlist data-fixed=true data-autoplay=false data-mini=true></div><script async src=/js/fps.js></script><canvas id=snow></canvas><script async src=/js/snow.js></script><script async src=/js/title.js></script><script defer src=/js/runtime.js></script><script src=/js/sun_moon.js async></script><script async data-pjax src=/js/txmap.js></script><script type=text/javascript src=/js/rightmenu.js></script><script async src=https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js></script><script async src=https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js></script><script defer data-pjax src=/js/cat.js></script><script>(function(d, w, c) {
    w.ChatraID = 'rTwLAKp9sD8gKkYZS';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (true) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><link rel=stylesheet href=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css media=print onload="this.media='all'"><script src=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js></script><script src=https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js></script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div><div class=js-pjax id=rightMenu><div class="rightMenu-group rightMenu-small"><a class=rightMenu-item href=javascript:window.history.back();><i class="fa fa-arrow-left"></i></a><a class=rightMenu-item href=javascript:window.history.forward();><i class="fa fa-arrow-right"></i></a><a class=rightMenu-item href=javascript:window.location.reload();><i class="fa fa-refresh"></i></a><a class=rightMenu-item href=javascript:rmf.scrollToTop();><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-text><a class=rightMenu-item href=javascript:rmf.copySelect();><i class="fa fa-copy"></i><span>复制</span></a><a class=rightMenu-item href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-too><a class=rightMenu-item href=javascript:window.open(window.getSelection().toString());window.location.reload();><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-paste><a class=rightMenu-item href=javascript:rmf.paste()><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-post><a class=rightMenu-item href=#post-comment><i class="fas fa-comment"></i><span>空降评论</span></a><a class=rightMenu-item href=javascript:rmf.copyWordsLink()><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-to><a class=rightMenu-item href=javascript:rmf.openWithNewTab()><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class=rightMenu-item id=menu-too href=javascript:rmf.open()><i class="fa fa-link"></i><span>转到链接</span></a><a class=rightMenu-item href=javascript:rmf.copyLink()><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-img><a class=rightMenu-item href=javascript:rmf.saveAs()><i class="fa fa-download"></i><span>保存图片</span></a><a class=rightMenu-item href=javascript:rmf.openWithNewTab()><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class=rightMenu-item href=javascript:rmf.copyLink()><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class=rightMenu-item href=javascript:randomPost()><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class=rightMenu-item href=javascript:switchNightMode();><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class=rightMenu-item href=javascript:rmf.switchReadMode();><i class="fa fa-book"></i><span>阅读模式</span></a><a class=rightMenu-item href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class=rightMenu-item href=javascript:toggleWinbox();><i class="fas fa-cog"></i><span>美化设置</span></a><a class=rightMenu-item href=javascript:rmf.fullScreen();><i class="fas fa-expand"></i><span>切换全屏</span></a><a class=rightMenu-item href=javascript:window.print();><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://yuydot.gitee.io/categories/Spring/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 Spring (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yuydot.gitee.io/categories/Git/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱‍👓 Git (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yuydot.gitee.io/categories/数据库/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 数据库 (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://yuydot.gitee.io/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style><style></style><div class=js-pjax><script async>var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async>var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src=https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js></script><script defer src=https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js></script><style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body></html>