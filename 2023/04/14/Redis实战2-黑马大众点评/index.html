<!DOCTYPE html><html lang=[&quot;zh-CN&quot;,&quot;zh-TW&quot;,&quot;en&quot;,&quot;default&quot;] data-theme=light><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Redis实战2 | YuydotのBlog</title><meta name=author content=yuydot><meta name=copyright content=yuydot><meta name=format-detection content="telephone=no"><meta name=theme-color content=#3eb8be;><meta name=description content="1、发布探店笔记1.1 准备探店笔记类似点评网站的评价，往往是图文结合。对应的表有两个：tb_blog：探店笔记表，包含笔记中的标题、文字、图片等tb_blog_comments：其他用户对探店笔记的评价 1234567891011121314DROP TABLE IF EXISTS &#96;tb_blog&#96;;CREATE TABLE &#96;tb_blog&#96; ( &#96;id&#96; bigint(20) UNSI"><meta property=og:type content=article><meta property=og:title content=Redis实战2><meta property=og:url content=https://yuydot.gitee.io/2023/04/14/Redis%E5%AE%9E%E6%88%982-%E9%BB%91%E9%A9%AC%E5%A4%A7%E4%BC%97%E7%82%B9%E8%AF%84/index.html><meta property=og:site_name content=YuydotのBlog><meta property=og:description content="1、发布探店笔记1.1 准备探店笔记类似点评网站的评价，往往是图文结合。对应的表有两个：tb_blog：探店笔记表，包含笔记中的标题、文字、图片等tb_blog_comments：其他用户对探店笔记的评价 1234567891011121314DROP TABLE IF EXISTS &#96;tb_blog&#96;;CREATE TABLE &#96;tb_blog&#96; ( &#96;id&#96; bigint(20) UNSI"><meta property=og:locale content=zh_CN><meta property=og:image content=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png><meta property=article:published_time content=2023-04-14T07:00:32.000Z><meta property=article:modified_time content=2023-05-04T08:38:01.862Z><meta property=article:author content=yuydot><meta property=article:tag content=Redis><meta name=twitter:card content=summary><meta name=twitter:image content=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png><link rel="shortcut icon" href=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/logo1.png><link rel=canonical href=https://yuydot.gitee.io/2023/04/14/Redis%E5%AE%9E%E6%88%982-%E9%BB%91%E9%A9%AC%E5%A4%A7%E4%BC%97%E7%82%B9%E8%AF%84/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css media=print onload="this.media='all'"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/4.0.31/fancybox.min.css media=print onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"距离上次更新已经过去","messageNext":"天了，文章内容可能已经过时。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id=config-diff>var GLOBAL_CONFIG_SITE = {
  title: 'Redis实战2',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-04 16:38:01'
}</script><noscript><style type=text/css>
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#3eb8be;')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel=stylesheet href=/css/background.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/readPercent.css><link rel=stylesheet href=/css/footer.css><link rel=stylesheet href=/css/loading_css.css><span id=fps></span><link rel=stylesheet href=https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css><svg aria-hidden=true style="position:absolute; overflow:hidden; width:0; height:0"><symbol id=icon-sun viewbox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill=#FFD878 p-id=8420></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill=#FFE4A9 p-id=8421></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill=#4D5152 p-id=8422></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill=#4D5152 p-id=8423></path></symbol><symbol id=icon-moon viewbox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill=#FFB531 p-id=11345></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill=#030835 p-id=11346></path></symbol></svg><div id=myscoll></div><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css><style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css media=print onload="this.media='screen'"><meta name=generator content="Hexo 6.3.0"></head><body><div id=loading-box onclick=document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)><div class=loading-bg><div class=loading-img></div><div class=loading-image-dot></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel=stylesheet href=/css/progress_bar.css><script src=https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js></script><div id=web_bg></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img is-center"><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wang.jpg onerror="onerror=null;src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/friend_404.gif'" alt=avatar></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class=headline>文章</div><div class=length-num>19</div></a><a href="/tags/"><div class=headline>标签</div><div class=length-num>10</div></a><a href="/categories/"><div class=headline>分类</div><div class=length-num>5</div></a></div><hr><div class=menus_items><div class=menus_item><a class=site-page href="/"><i class="fa-fw fas fa-home"></i><span>主页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fa fa-graduation-cap"></i><span>博文</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span>标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span>归档</span></a></li></ul></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fas fa-list"></i><span>生活</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span>分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span>影视</span></a></li></ul></div><div class=menus_item><a class=site-page href="/links/"><i class="fa-fw fa fa-link"></i><span>友链</span></a></div><div class=menus_item><a class=site-page href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span>留言板</span></a></div><div class=menus_item><a class=site-page href="/about/"><i class="fa-fw fas fa-heart"></i><span>关于笔者</span></a></div></div></div></div><div class=post id=body-wrap><header class=post-bg id=page-header style="background-image: url('https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png')"><nav id=nav><span id=blog-info><a href="/" title=YuydotのBlog><span class=site-name>YuydotのBlog</span></a></span><div id=weather><div id=tp-weather-widget></div></div><div id=menus><div class=menus_items><div class=menus_item><a class=site-page href="/"><i class="fa-fw fas fa-home"></i><span>主页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fa fa-graduation-cap"></i><span>博文</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span>标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span>归档</span></a></li></ul></div><div class=menus_item><a class="site-page group" href=javascript:void(0);><i class="fa-fw fas fa-list"></i><span>生活</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span>分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span>影视</span></a></li></ul></div><div class=menus_item><a class=site-page href="/links/"><i class="fa-fw fa fa-link"></i><span>友链</span></a></div><div class=menus_item><a class=site-page href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span>留言板</span></a></div><div class=menus_item><a class=site-page href="/about/"><i class="fa-fw fas fa-heart"></i><span>关于笔者</span></a></div></div><div id=toggle-menu><a class=site-page href=javascript:void(0);><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id=post-info><h1 class=post-title>Redis实战2</h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class=post-meta-label>发表于</span><time class=post-meta-date-created datetime=2023-04-14T07:00:32.000Z title="发表于 2023-04-14 15:00:32">2023-04-14</time><span class=post-meta-separator>|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class=post-meta-label>更新于</span><time class=post-meta-date-updated datetime=2023-05-04T08:38:01.862Z title="更新于 2023-05-04 16:38:01">2023-05-04</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href="/categories/Springboot/">Springboot</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>字数总计:</span><span class=word-count>9.7k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>阅读时长:</span><span>38分钟</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv data-flag-title=Redis实战2><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>阅读量:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class=waves-svg xmlns=http://www.w3.org/2000/svg xlink=http://www.w3.org/1999/xlink viewbox="0 24 150 28" preserveaspectratio=none shape-rendering=auto><defs><path id=gentle-wave d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class=parallax><use href=#gentle-wave x=48 y=0></use><use href=#gentle-wave x=48 y=3></use><use href=#gentle-wave x=48 y=5></use><use href=#gentle-wave x=48 y=7></use></g></svg></section></header><main class=layout id=content-inner><div id=post><article class=post-content id=article-container><h2 id=1、发布探店笔记><a href=#1、发布探店笔记 class=headerlink title=1、发布探店笔记></a>1、发布探店笔记</h2><h3 id=1-1-准备><a href=#1-1-准备 class=headerlink title="1.1 准备"></a>1.1 准备</h3><p>探店笔记类似点评网站的评价，往往是图文结合。对应的表有两个：<br>tb_blog：探店笔记表，包含笔记中的标题、文字、图片等<br>tb_blog_comments：其他用户对探店笔记的评价</p><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>DROP</span> <span class=keyword>TABLE</span> IF <span class=keyword>EXISTS</span> `tb_blog`;</span><br><span class=line><span class=keyword>CREATE</span> <span class=keyword>TABLE</span> `tb_blog`  (</span><br><span class=line>  `id` <span class=type>bigint</span>(<span class=number>20</span>) UNSIGNED <span class=keyword>NOT</span> <span class=keyword>NULL</span> AUTO_INCREMENT COMMENT <span class=string>&#x27;主键&#x27;</span>,</span><br><span class=line>  `shop_id` <span class=type>bigint</span>(<span class=number>20</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span> COMMENT <span class=string>&#x27;商户id&#x27;</span>,</span><br><span class=line>  `user_id` <span class=type>bigint</span>(<span class=number>20</span>) UNSIGNED <span class=keyword>NOT</span> <span class=keyword>NULL</span> COMMENT <span class=string>&#x27;用户id&#x27;</span>,</span><br><span class=line>  `title` <span class=type>varchar</span>(<span class=number>255</span>) <span class=type>CHARACTER</span> <span class=keyword>SET</span> utf8mb4 <span class=keyword>COLLATE</span> utf8mb4_unicode_ci <span class=keyword>NOT</span> <span class=keyword>NULL</span> COMMENT <span class=string>&#x27;标题&#x27;</span>,</span><br><span class=line>  `images` <span class=type>varchar</span>(<span class=number>2048</span>) <span class=type>CHARACTER</span> <span class=keyword>SET</span> utf8mb4 <span class=keyword>COLLATE</span> utf8mb4_general_ci <span class=keyword>NOT</span> <span class=keyword>NULL</span> COMMENT <span class=string>&#x27;探店的照片，最多9张，多张以\&quot;,\&quot;隔开&#x27;</span>,</span><br><span class=line>  `content` <span class=type>varchar</span>(<span class=number>2048</span>) <span class=type>CHARACTER</span> <span class=keyword>SET</span> utf8mb4 <span class=keyword>COLLATE</span> utf8mb4_unicode_ci <span class=keyword>NOT</span> <span class=keyword>NULL</span> COMMENT <span class=string>&#x27;探店的文字描述&#x27;</span>,</span><br><span class=line>  `liked` <span class=type>int</span>(<span class=number>8</span>) UNSIGNED <span class=keyword>NULL</span> <span class=keyword>DEFAULT</span> <span class=number>0</span> COMMENT <span class=string>&#x27;点赞数量&#x27;</span>,</span><br><span class=line>  `comments` <span class=type>int</span>(<span class=number>8</span>) UNSIGNED <span class=keyword>NULL</span> <span class=keyword>DEFAULT</span> <span class=keyword>NULL</span> COMMENT <span class=string>&#x27;评论数量&#x27;</span>,</span><br><span class=line>  `create_time` <span class=type>timestamp</span> <span class=keyword>NOT</span> <span class=keyword>NULL</span> <span class=keyword>DEFAULT</span> <span class=built_in>CURRENT_TIMESTAMP</span> COMMENT <span class=string>&#x27;创建时间&#x27;</span>,</span><br><span class=line>  `update_time` <span class=type>timestamp</span> <span class=keyword>NOT</span> <span class=keyword>NULL</span> <span class=keyword>DEFAULT</span> <span class=built_in>CURRENT_TIMESTAMP</span> <span class=keyword>ON</span> <span class=keyword>UPDATE</span> <span class=built_in>CURRENT_TIMESTAMP</span> COMMENT <span class=string>&#x27;更新时间&#x27;</span>,</span><br><span class=line>  <span class=keyword>PRIMARY</span> KEY (`id`) <span class=keyword>USING</span> BTREE</span><br><span class=line>) ENGINE <span class=operator>=</span> InnoDB AUTO_INCREMENT <span class=operator>=</span> <span class=number>23</span> <span class=type>CHARACTER</span> <span class=keyword>SET</span> <span class=operator>=</span> utf8mb4 <span class=keyword>COLLATE</span> <span class=operator>=</span> utf8mb4_general_ci ROW_FORMAT <span class=operator>=</span> Compact;</span><br></pre></td></tr></table></figure><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230414151340782.png></p><h3 id=1-2-具体发布流程><a href=#1-2-具体发布流程 class=headerlink title="1.2 具体发布流程"></a>1.2 具体发布流程</h3><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428131016509.png alt=image-20230428131016509></p><p>上传接口</p><p>为什么单独做一个上传接口？ 接口复用，上传文件功能在其他地方也能用，所以不用写在上传文章的接口里。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Slf4j</span></span><br><span class=line><span class=meta>@RestController</span></span><br><span class=line><span class=meta>@RequestMapping(&quot;upload&quot;)</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class=line></span><br><span class=line>    <span class=meta>@PostMapping(&quot;blog&quot;)</span></span><br><span class=line>    <span class=keyword>public</span> Result <span class="title function_">uploadImage</span><span class=params>(<span class=meta>@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;</span><br><span class=line>        <span class=keyword>try</span> &#123;</span><br><span class=line>            <span class=comment>// 获取原始文件名称</span></span><br><span class=line>            <span class=type>String</span> <span class=variable>originalFilename</span> <span class=operator>=</span> image.getOriginalFilename();</span><br><span class=line>            <span class=comment>// 生成新文件名</span></span><br><span class=line>            <span class=type>String</span> <span class=variable>fileName</span> <span class=operator>=</span> createNewFileName(originalFilename);</span><br><span class=line>            <span class=comment>// 保存文件</span></span><br><span class=line>            image.transferTo(<span class=keyword>new</span> <span class="title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));</span><br><span class=line>            <span class=comment>// 返回结果</span></span><br><span class=line>            log.debug(<span class=string>&quot;文件上传成功，&#123;&#125;&quot;</span>, fileName);</span><br><span class=line>            <span class=keyword>return</span> Result.ok(fileName);</span><br><span class=line>        &#125; <span class=keyword>catch</span> (IOException e) &#123;</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> <span class="title class_">RuntimeException</span>(<span class=string>&quot;文件上传失败&quot;</span>, e);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>     <span class=meta>@GetMapping(&quot;/blog/delete&quot;)</span></span><br><span class=line>    <span class=keyword>public</span> Result <span class="title function_">deleteBlogImg</span><span class=params>(<span class=meta>@RequestParam(&quot;name&quot;)</span> String filename)</span> &#123;</span><br><span class=line>        <span class=type>File</span> <span class=variable>file</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, filename);</span><br><span class=line>        <span class=keyword>if</span> (file.isDirectory()) &#123;</span><br><span class=line>            <span class=keyword>return</span> Result.fail(<span class=string>&quot;错误的文件名称&quot;</span>);</span><br><span class=line>        &#125;</span><br><span class=line>        FileUtil.del(file);</span><br><span class=line>        <span class=keyword>return</span> Result.ok();</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> String <span class="title function_">createNewFileName</span><span class=params>(String originalFilename)</span> &#123;</span><br><span class=line>        <span class=comment>// 获取后缀</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>suffix</span> <span class=operator>=</span> StrUtil.subAfter(originalFilename, <span class=string>&quot;.&quot;</span>, <span class=literal>true</span>);</span><br><span class=line>        <span class=comment>// 生成目录</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>name</span> <span class=operator>=</span> UUID.randomUUID().toString();</span><br><span class=line>        <span class=type>int</span> <span class=variable>hash</span> <span class=operator>=</span> name.hashCode();</span><br><span class=line>        <span class=type>int</span> <span class=variable>d1</span> <span class=operator>=</span> hash &amp; <span class=number>0xF</span>;</span><br><span class=line>        <span class=type>int</span> <span class=variable>d2</span> <span class=operator>=</span> (hash &gt;&gt; <span class=number>4</span>) &amp; <span class=number>0xF</span>;</span><br><span class=line>        <span class=comment>// 判断目录是否存在</span></span><br><span class=line>        <span class=type>File</span> <span class=variable>dir</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, StrUtil.format(<span class=string>&quot;/blogs/&#123;&#125;/&#123;&#125;&quot;</span>, d1, d2));</span><br><span class=line>        <span class=keyword>if</span> (!dir.exists()) &#123;</span><br><span class=line>            dir.mkdirs();</span><br><span class=line>        &#125;</span><br><span class=line>        <span class=comment>// 生成文件名</span></span><br><span class=line>        <span class=keyword>return</span> StrUtil.format(<span class=string>&quot;/blogs/&#123;&#125;/&#123;&#125;/&#123;&#125;.&#123;&#125;&quot;</span>, d1, d2, name, suffix);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>注意：在操作时，需要修改SystemConstants.IMAGE_UPLOAD_DIR 自己图片所在的地址，在实际开发中图片一般会放在nginx上或者是云存储上。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">SystemConstants</span> &#123;</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>IMAGE_UPLOAD_DIR</span> <span class=operator>=</span> <span class=string>&quot;D:\\lesson\\nginx-1.18.0\\html\\hmdp\\imgs\\&quot;</span>;</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>String</span> <span class=variable>USER_NICK_NAME_PREFIX</span> <span class=operator>=</span> <span class=string>&quot;user_&quot;</span>;</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>DEFAULT_PAGE_SIZE</span> <span class=operator>=</span> <span class=number>5</span>;</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=type>int</span> <span class=variable>MAX_PAGE_SIZE</span> <span class=operator>=</span> <span class=number>10</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>BlogController</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><span class=line> <span class=meta>@RestController</span></span><br><span class=line><span class=meta>@RequestMapping(&quot;/blog&quot;)</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Resource</span></span><br><span class=line>    <span class=keyword>private</span> IBlogService blogService;</span><br><span class=line></span><br><span class=line>    <span class=meta>@PostMapping</span></span><br><span class=line>    <span class=keyword>public</span> Result <span class="title function_">saveBlog</span><span class=params>(<span class=meta>@RequestBody</span> Blog blog)</span> &#123;</span><br><span class=line>        <span class=comment>//获取登录用户</span></span><br><span class=line>        <span class=type>UserDTO</span> <span class=variable>user</span> <span class=operator>=</span> UserHolder.getUser();</span><br><span class=line>        blog.setUpdateTime(user.getId());</span><br><span class=line>        <span class=comment>//保存探店博文</span></span><br><span class=line>        blogService.saveBlog(blog);</span><br><span class=line>        <span class=comment>//返回id</span></span><br><span class=line>        <span class=keyword>return</span> Result.ok(blog.getId());</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h2 id=2、查看探店笔记><a href=#2、查看探店笔记 class=headerlink title=2、查看探店笔记></a>2、查看探店笔记</h2><h3 id=2-1-实现查看发布探店笔记的接口><a href=#2-1-实现查看发布探店笔记的接口 class=headerlink title="2.1 实现查看发布探店笔记的接口"></a>2.1 实现查看发布探店笔记的接口</h3><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428132945771.png alt=image-20230428132945771></p><p>实现代码：</p><p>BlogServiceImpl</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryBlogById</span><span class=params>(Long id)</span> &#123;</span><br><span class=line>    <span class=comment>// 1.查询blog</span></span><br><span class=line>    <span class=type>Blog</span> <span class=variable>blog</span> <span class=operator>=</span> getById(id);</span><br><span class=line>    <span class=keyword>if</span> (blog == <span class=literal>null</span>) &#123;</span><br><span class=line>        <span class=keyword>return</span> Result.fail(<span class=string>&quot;笔记不存在！&quot;</span>);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// 2.查询blog有关的用户</span></span><br><span class=line>    <span class=comment>//为什么要这样操作？因为在blog在数据中没有NickName和Icon字段，所以要手动添加</span></span><br><span class=line>    queryBlogUser(blog);</span><br><span class=line>  </span><br><span class=line>    <span class=keyword>return</span> Result.ok(blog);</span><br><span class=line>&#125;</span><br><span class=line><span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">queryBlogUser</span><span class=params>(Blog blog)</span> &#123;</span><br><span class=line>    <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> blog.getUserId();</span><br><span class=line>    <span class=type>User</span> <span class=variable>user</span> <span class=operator>=</span> userService.getById(userId);</span><br><span class=line>    blog.setName(user.getNickName());</span><br><span class=line>    blog.setIcon(user.getIcon());</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h2 id=3、点赞功能><a href=#3、点赞功能 class=headerlink title=3、点赞功能></a>3、点赞功能</h2><h3 id=3-1-实现查看点赞功能的接口><a href=#3-1-实现查看点赞功能的接口 class=headerlink title="3.1 实现查看点赞功能的接口"></a>3.1 实现查看点赞功能的接口</h3><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/761d5b05a2297825ea4034568add4d3a.png alt=image-20221120085007488></p><p>初始代码</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryBlogLikes</span><span class=params>(<span class=meta>@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class=line>    <span class=comment>//修改点赞数量</span></span><br><span class=line>    blogService.update().setSql(<span class=string>&quot;liked = liked +1 &quot;</span>).eq(<span class=string>&quot;id&quot;</span>,id).update();</span><br><span class=line>    <span class=keyword>return</span> Result.ok();</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h3 id=3-2-问题分析><a href=#3-2-问题分析 class=headerlink title="3.2 问题分析"></a>3.2 问题分析</h3><p>这种方式会导致一个用户无限点赞，明显是不合理的。</p><p>造成这个问题的原因是，我们现在的逻辑，发起请求只是给数据库+1，所以才会出现这个问题</p><h3 id=3-3-完善点赞功能><a href=#3-3-完善点赞功能 class=headerlink title="3.3 完善点赞功能"></a>3.3 完善点赞功能</h3><p>需求：</p><ul><li>同一个用户只能点赞一次，再次点击则取消点赞</li><li>如果当前用户已经点赞，则点赞按钮高亮显示（前端已实现，判断字段Blog类的isLike属性）</li></ul><p>实现步骤：</p><ul><li>给Blog类中添加一个isLike字段，标示是否被当前用户点赞</li><li>修改点赞功能，利用Redis的set集合判断是否点赞过，未点赞过则点赞数+1，已点赞过则点赞数-1</li><li>修改根据id查询Blog的业务，判断当前登录用户是否点赞过，赋值给isLike字段</li><li>修改分页查询Blog业务，判断当前登录用户是否点赞过，赋值给isLike字段</li></ul><p>为什么采用set集合：</p><p>因为我们的数据是不能重复的，当用户操作过之后，无论他怎么操作，都是唯一</p><h4 id=具体步骤：><a href=#具体步骤： class=headerlink title=具体步骤：></a>具体步骤：</h4><p>(1) 在Blog 添加一个字段</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@TableField(exist = false)</span></span><br><span class=line><span class=keyword>private</span> Boolean isLike;</span><br></pre></td></tr></table></figure><p>(2) 修改代码</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line>   <span class=keyword>public</span> Result <span class="title function_">likeBlog</span><span class=params>(Long id)</span>&#123;</span><br><span class=line>       <span class=comment>// 1.获取登录用户</span></span><br><span class=line>       <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>       <span class=comment>// 2.判断当前登录用户是否已经点赞  BLOG_LIKED_KEY=&quot;blog:liked:&quot;</span></span><br><span class=line>       <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> BLOG_LIKED_KEY + id;</span><br><span class=line>       <span class=type>Boolean</span> <span class=variable>isMember</span> <span class=operator>=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class=line>       <span class=keyword>if</span>(BooleanUtil.isFalse(isMember))&#123;</span><br><span class=line>            <span class=comment>//3.如果未点赞，可以点赞</span></span><br><span class=line>           <span class=comment>//3.1 数据库点赞数+1</span></span><br><span class=line>           <span class=type>boolean</span> <span class=variable>isSuccess</span> <span class=operator>=</span> update().setSql(<span class=string>&quot;liked = liked + 1&quot;</span>).eq(<span class=string>&quot;id&quot;</span>, id).update();</span><br><span class=line>           <span class=comment>//3.2 保存用户到Redis的set集合</span></span><br><span class=line>           <span class=keyword>if</span>(isSuccess)&#123;</span><br><span class=line>               stringRedisTemplate.opsForSet().add(key,userId.toString());</span><br><span class=line>           &#125;</span><br><span class=line>       &#125;<span class=keyword>else</span>&#123;</span><br><span class=line>            <span class=comment>//4.如果已点赞，取消点赞</span></span><br><span class=line>           <span class=comment>//4.1 数据库点赞数-1</span></span><br><span class=line>           <span class=type>boolean</span> <span class=variable>isSuccess</span> <span class=operator>=</span> update().setSql(<span class=string>&quot;liked = liked - 1&quot;</span>).eq(<span class=string>&quot;id&quot;</span>, id).update();</span><br><span class=line>           <span class=comment>//4.2 把用户从Redis的set集合移除</span></span><br><span class=line>           <span class=keyword>if</span>(isSuccess)&#123;</span><br><span class=line>               stringRedisTemplate.opsForSet().remove(key,userId.toString());</span><br><span class=line>           &#125;</span><br><span class=line>       &#125;</span><br></pre></td></tr></table></figure><p>(3) 当我们点开一篇blog的时候就需要被看到是否点赞过，这就要求我们改一下queryBlogById(id)咯，当然isLikeBlog(blog)也是需要。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryBlogById</span><span class=params>(Long id)</span> &#123;</span><br><span class=line>    <span class=comment>//1.查询blog</span></span><br><span class=line>    <span class=type>Blog</span> <span class=variable>blog</span> <span class=operator>=</span> getById(id);</span><br><span class=line>    <span class=keyword>if</span>(blog==<span class=literal>null</span>)&#123;</span><br><span class=line>        <span class=keyword>return</span> Result.fail(<span class=string>&quot;笔记不存在!&quot;</span>);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>//2.查询blog相关用户</span></span><br><span class=line>    queryBlogUser(blog);</span><br><span class=line>    <span class=comment>//3.查询用户是否点过赞,其实就是给blog的isLike添加值</span></span><br><span class=line>    isLikeBlog(blog);</span><br><span class=line></span><br><span class=line>    <span class=keyword>return</span> Result.ok(blog);</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">isLikeBlog</span><span class=params>(Blog blog)</span> &#123;</span><br><span class=line>    <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>    <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> BLOG_LIKED_KEY + id;</span><br><span class=line>    <span class=type>Boolean</span> <span class=variable>isMember</span> <span class=operator>=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class=line>    blog.setIsLike(BooleanUtil.isTrue(isMember));</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line> <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> Result <span class="title function_">queryHotBlog</span><span class=params>(Integer current)</span> &#123;</span><br><span class=line>        <span class=comment>// 根据用户查询</span></span><br><span class=line>        Page&lt;Blog&gt; page = query()</span><br><span class=line>                .orderByDesc(<span class=string>&quot;liked&quot;</span>)</span><br><span class=line>                .page(<span class=keyword>new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class=line>        <span class=comment>// 获取当前页数据</span></span><br><span class=line>        List&lt;Blog&gt; records = page.getRecords();</span><br><span class=line>        <span class=comment>// 查询用户</span></span><br><span class=line>        records.forEach(blog-&gt;&#123;</span><br><span class=line>            <span class=built_in>this</span>.queryBlogUser(blog);</span><br><span class=line>            <span class=built_in>this</span>.isLikeBlog(blog);</span><br><span class=line>        &#125;);<span class=comment>//就是用blog遍历的</span></span><br><span class=line>        <span class=keyword>return</span> Result.ok(records);</span><br><span class=line>    &#125;</span><br><span class=line></span><br></pre></td></tr></table></figure><h2 id=4、点赞排行榜><a href=#4、点赞排行榜 class=headerlink title=4、点赞排行榜></a>4、点赞排行榜</h2><h3 id=4-1、分析：><a href=#4-1、分析： class=headerlink title=4.1、分析：></a>4.1、分析：</h3><p>在探店笔记的详情页面，应该把给该笔记点赞的人显示出来，比如最早点赞的TOP5，形成点赞排行榜：</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/31c8bee2eae1effd0a1c47ce2200d4fa.png alt=image-20221120110940588></p><p>Redis的set存储的like无序，所以需要用到sortedset</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/86dbee0f5200a2315453f87ab21f6c0c.png alt=image-20221120111044374></p><h3 id=4-2、修改BlogServiceImpl><a href=#4-2、修改BlogServiceImpl class=headerlink title=4.2、修改BlogServiceImpl></a>4.2、修改BlogServiceImpl</h3><p>BlogServiceImpl：点赞逻辑代码</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br></pre></td><td class=code><pre><span class=line>   <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> Result <span class="title function_">likeBlog</span><span class=params>(Long id)</span> &#123;</span><br><span class=line>        <span class=comment>// 1.获取登录用户</span></span><br><span class=line>        <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>        <span class=comment>// 2.判断当前登录用户是否已经点赞</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> BLOG_LIKED_KEY + id;</span><br><span class=line>        <span class=type>Double</span> <span class=variable>score</span> <span class=operator>=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class=line>        <span class=keyword>if</span> (score == <span class=literal>null</span>) &#123;</span><br><span class=line>            <span class=comment>// 3.如果未点赞，可以点赞</span></span><br><span class=line>            <span class=comment>// 3.1.数据库点赞数 + 1</span></span><br><span class=line>            <span class=type>boolean</span> <span class=variable>isSuccess</span> <span class=operator>=</span> update().setSql(<span class=string>&quot;liked = liked + 1&quot;</span>).eq(<span class=string>&quot;id&quot;</span>, id).update();</span><br><span class=line>            <span class=comment>// 3.2.保存用户到Redis的set集合  zadd key value score(时间戳)</span></span><br><span class=line>            <span class=keyword>if</span> (isSuccess) &#123;</span><br><span class=line>                stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class=line>            &#125;</span><br><span class=line>        &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>            <span class=comment>// 4.如果已点赞，取消点赞</span></span><br><span class=line>            <span class=comment>// 4.1.数据库点赞数 -1</span></span><br><span class=line>            <span class=type>boolean</span> <span class=variable>isSuccess</span> <span class=operator>=</span> update().setSql(<span class=string>&quot;liked = liked - 1&quot;</span>).eq(<span class=string>&quot;id&quot;</span>, id).update();</span><br><span class=line>            <span class=comment>// 4.2.把用户从Redis的set集合移除</span></span><br><span class=line>            <span class=keyword>if</span> (isSuccess) &#123;</span><br><span class=line>                stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;</span><br><span class=line>        <span class=keyword>return</span> Result.ok();</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line><span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">isBlogLiked</span><span class=params>(Blog blog)</span> &#123;</span><br><span class=line>    <span class=comment>// 1.获取登录用户</span></span><br><span class=line>    <span class=type>UserDTO</span> <span class=variable>user</span> <span class=operator>=</span> UserHolder.getUser();</span><br><span class=line>    <span class=keyword>if</span> (user == <span class=literal>null</span>) &#123;</span><br><span class=line>        <span class=comment>// 用户未登录，无需查询是否点赞</span></span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> user.getId();</span><br><span class=line>    <span class=comment>// 2.判断当前登录用户是否已经点赞</span></span><br><span class=line>    <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> <span class=string>&quot;blog:liked:&quot;</span> + blog.getId();</span><br><span class=line>    <span class=type>Double</span> <span class=variable>score</span> <span class=operator>=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class=line>    blog.setIsLike(score != <span class=literal>null</span>);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h3 id=4-3、点赞列表查询列表><a href=#4-3、点赞列表查询列表 class=headerlink title=4.3、点赞列表查询列表></a>4.3、点赞列表查询列表</h3><p>BlogController</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryBlogLikes</span><span class=params>(<span class=meta>@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class=line></span><br><span class=line>    <span class=keyword>return</span> blogService.queryBlogLikes(id);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>BlogService</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryBlogLikes</span><span class=params>(Long id)</span> &#123;</span><br><span class=line>    <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> BLOG_LIKED_KEY + id;</span><br><span class=line>    <span class=comment>// 1.查询top5的点赞用户 zrange key 0 4</span></span><br><span class=line>    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class=number>0</span>, <span class=number>4</span>);</span><br><span class=line>    <span class=keyword>if</span> (top5 == <span class=literal>null</span> || top5.isEmpty()) &#123;</span><br><span class=line>        <span class=keyword>return</span> Result.ok(Collections.emptyList());</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// 2.解析出其中的用户id,然后根据UserId查询到user,再转化为UserDto</span></span><br><span class=line>    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class=line>    <span class=type>String</span> <span class=variable>idStr</span> <span class=operator>=</span> StrUtil.join(<span class=string>&quot;,&quot;</span>, ids);</span><br><span class=line>    <span class=comment>// 3.根据用户id查询用户 WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)</span></span><br><span class=line>    List&lt;UserDTO&gt; userDTOS = userService.query()</span><br><span class=line>            .in(<span class=string>&quot;id&quot;</span>, ids).last(<span class=string>&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class=string>&quot;)&quot;</span>).list()</span><br><span class=line>            .stream()</span><br><span class=line>            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class=line>            .collect(Collectors.toList());</span><br><span class=line>    <span class=comment>//看不懂这样写</span></span><br><span class=line>    List&lt;UserDTO&gt; userDTOS  =<span class=keyword>new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class=line>    <span class=keyword>for</span> (User user : users) &#123;</span><br><span class=line>        <span class=type>UserDTO</span> <span class=variable>userDTO</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">UserDTO</span>();</span><br><span class=line>        BeanUtils.copyProperties(user,userDTO);</span><br><span class=line>        userDTOS.add(userDTO);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// 4.返回</span></span><br><span class=line>    <span class=keyword>return</span> Result.ok(userDTOS);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h2 id=5、关注和取关><a href=#5、关注和取关 class=headerlink title=5、关注和取关></a>5、关注和取关</h2><p>针对用户的操作：可以对用户进行关注和取消关注功能。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428141217902.png alt=image-20230428141217902></p><p>实现思路：</p><p>需求：基于该表数据结构，实现两个接口：</p><ul><li>关注和取关接口</li><li>判断是否关注的接口</li></ul><p>关注是User之间的关系，是博主与粉丝的关系，数据库中有一张tb_follow表来标示：</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428141335759.png alt=image-20230428141335759></p><p>注意: 这里需要把主键修改为自增长，简化开发。</p><h3 id=5-1-关注><a href=#5-1-关注 class=headerlink title="5.1 关注"></a>5.1 关注</h3><p>FollowController</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line><span class=comment>//关注</span></span><br><span class=line><span class=meta>@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">follow</span><span class=params>(<span class=meta>@PathVariable(&quot;id&quot;)</span> Long followUserId, <span class=meta>@PathVariable(&quot;isFollow&quot;)</span> Boolean isFollow)</span> &#123;</span><br><span class=line>    <span class=keyword>return</span> followService.follow(followUserId, isFollow);</span><br><span class=line>&#125;</span><br><span class=line><span class=comment>//取消关注(其实是判断当前用户有没有关注)</span></span><br><span class=line><span class=meta>@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">isFollow</span><span class=params>(<span class=meta>@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;</span><br><span class=line>      <span class=keyword>return</span> followService.isFollow(followUserId);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>FollowService</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre></td><td class=code><pre><span class=line><span class=comment>//取消关注service(判断当前用户有没有关注)</span></span><br><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">isFollow</span><span class=params>(Long followUserId)</span> &#123;</span><br><span class=line>        <span class=comment>// 1.获取登录用户</span></span><br><span class=line>        <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>        <span class=comment>// 2.查询是否关注 select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class=line>        <span class=type>Integer</span> <span class=variable>count</span> <span class=operator>=</span> query().eq(<span class=string>&quot;user_id&quot;</span>, userId).eq(<span class=string>&quot;follow_user_id&quot;</span>, followUserId).count();</span><br><span class=line>        <span class=comment>// 3.判断</span></span><br><span class=line>        <span class=keyword>return</span> Result.ok(count &gt; <span class=number>0</span>);</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=comment>//关注servic  isFollow==true 取消关注 &amp;&amp; isFollow==false 关注</span></span><br><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">follow</span><span class=params>(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class=line>    <span class=comment>// 1.获取登录用户</span></span><br><span class=line>    <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>    <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> <span class=string>&quot;follows:&quot;</span> + userId;</span><br><span class=line>    <span class=comment>// 1.判断到底是关注还是取关</span></span><br><span class=line>    <span class=keyword>if</span> (isFollow) &#123;</span><br><span class=line>        <span class=comment>// 2.关注，新增数据</span></span><br><span class=line>        <span class=type>Follow</span> <span class=variable>follow</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">Follow</span>();</span><br><span class=line>        follow.setUserId(userId);</span><br><span class=line>        follow.setFollowUserId(followUserId);</span><br><span class=line>        <span class=type>boolean</span> <span class=variable>isSuccess</span> <span class=operator>=</span> save(follow);</span><br><span class=line></span><br><span class=line>    &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>        <span class=comment>// 3.取关，删除 delete from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class=line>        remove(<span class=keyword>new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class=line>               .eq(<span class=string>&quot;user_id&quot;</span>, userId).eq(<span class=string>&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>return</span> Result.ok();</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h3 id=5-2-共同关注><a href=#5-2-共同关注 class=headerlink title="5.2 共同关注"></a>5.2 共同关注</h3><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428142753350.png alt=image-20230428142753350>想要去看共同关注的好友，需要首先进入到这个页面，这个页面会发起两个请求</p><p>1、去查询用户的详情</p><p>2、去查询用户的笔记</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre></td><td class=code><pre><span class=line><span class=comment>// UserController 根据id查询用户</span></span><br><span class=line><span class=meta>@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryUserById</span><span class=params>(<span class=meta>@PathVariable(&quot;id&quot;)</span> Long userId)</span>&#123;</span><br><span class=line>	<span class=comment>// 查询详情</span></span><br><span class=line>	<span class=type>User</span> <span class=variable>user</span> <span class=operator>=</span> userService.getById(userId);</span><br><span class=line>	<span class=keyword>if</span> (user == <span class=literal>null</span>) &#123;</span><br><span class=line>		<span class=keyword>return</span> Result.ok();</span><br><span class=line>	&#125;</span><br><span class=line>	<span class=type>UserDTO</span> <span class=variable>userDTO</span> <span class=operator>=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class=line>	<span class=comment>// 返回</span></span><br><span class=line>	<span class=keyword>return</span> Result.ok(userDTO);</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=comment>// BlogController  根据id查询博主的探店笔记</span></span><br><span class=line><span class=meta>@GetMapping(&quot;/of/user&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryBlogByUserId</span><span class=params>(</span></span><br><span class=line><span class=params>		<span class=meta>@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class=line><span class=params>		<span class=meta>@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class=line>	<span class=comment>// 根据用户查询</span></span><br><span class=line>	Page&lt;Blog&gt; page = blogService.query()</span><br><span class=line>			.eq(<span class=string>&quot;user_id&quot;</span>, id).page(<span class=keyword>new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class=line>	<span class=comment>// 获取当前页数据</span></span><br><span class=line>	List&lt;Blog&gt; records = page.getRecords();</span><br><span class=line>	<span class=keyword>return</span> Result.ok(records);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>接下来看看共同关注如何实现：</p><p>需求：利用Redis中恰当的数据结构，实现共同关注功能。在博主个人页面展示出当前用户与博主的共同关注呢。</p><p>当然是使用set集合，在set集合中，有交集并集补集的api，我们可以把两人的关注的人分别放入到一个set集合中，然后再通过api去查看这两个set集合中的交集数据。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428143205898.png alt=image-20230428143205898></p><p>先改造当前的关注列表</p><p>改造原因是因为我们需要在用户关注了某位用户后，需要将数据放入到set集合中，方便后续进行共同关注，同时当取消关注时，也需要从set集合中进行删除</p><p>FollowServiceImpl</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">follow</span><span class=params>(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class=line>    <span class=comment>// 1.获取登录用户</span></span><br><span class=line>    <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>    <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> <span class=string>&quot;follows:&quot;</span> + userId;</span><br><span class=line>    <span class=comment>// 1.判断到底是关注还是取关</span></span><br><span class=line>    <span class=keyword>if</span> (isFollow) &#123;</span><br><span class=line>        <span class=comment>// 2.关注，新增数据</span></span><br><span class=line>        <span class=type>Follow</span> <span class=variable>follow</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">Follow</span>();</span><br><span class=line>        follow.setUserId(userId);</span><br><span class=line>        follow.setFollowUserId(followUserId);</span><br><span class=line>        <span class=type>boolean</span> <span class=variable>isSuccess</span> <span class=operator>=</span> save(follow);</span><br><span class=line>        <span class=keyword>if</span> (isSuccess) &#123;</span><br><span class=line>            <span class=comment>// 把关注用户的id，放入redis的set集合 sadd userId followerUserId</span></span><br><span class=line>            stringRedisTemplate.opsForSet().add(key, followUserId.toString());</span><br><span class=line>        &#125;</span><br><span class=line>    &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>        <span class=comment>// 3.取关，删除 delete from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class=line>        <span class=type>boolean</span> <span class=variable>isSuccess</span> <span class=operator>=</span> remove(<span class=keyword>new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class=line>                .eq(<span class=string>&quot;user_id&quot;</span>, userId).eq(<span class=string>&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class=line>        <span class=keyword>if</span> (isSuccess) &#123;</span><br><span class=line>            <span class=comment>// 把关注用户的id从Redis集合中移除</span></span><br><span class=line>            stringRedisTemplate.opsForSet().remove(key, followUserId.toString());</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>return</span> Result.ok();</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p><strong>具体的关注代码：</strong></p><p>FollowServiceImpl</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">followCommons</span><span class=params>(Long id)</span> &#123;</span><br><span class=line>    <span class=comment>// 1.获取当前用户</span></span><br><span class=line>    <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>    <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> <span class=string>&quot;follows:&quot;</span> + userId;</span><br><span class=line>    <span class=comment>// 2.求交集</span></span><br><span class=line>    <span class=type>String</span> <span class=variable>key2</span> <span class=operator>=</span> <span class=string>&quot;follows:&quot;</span> + id;</span><br><span class=line>    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2);</span><br><span class=line>    <span class=keyword>if</span> (intersect == <span class=literal>null</span> || intersect.isEmpty()) &#123;</span><br><span class=line>        <span class=comment>// 无交集</span></span><br><span class=line>        <span class=keyword>return</span> Result.ok(Collections.emptyList());</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// 3.解析id集合</span></span><br><span class=line>    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class=line>    <span class=comment>// 4.查询用户</span></span><br><span class=line>    List&lt;UserDTO&gt; users = userService.listByIds(ids)</span><br><span class=line>            .stream()</span><br><span class=line>            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class=line>            .collect(Collectors.toList());</span><br><span class=line>    <span class=keyword>return</span> Result.ok(users);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>Controller</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@GetMapping(&quot;/common/&#123;id&#125;&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">followCommons</span><span class=params>(<span class=meta>@PathVariable(&quot;id&quot;)</span> Long followUserId)</span>&#123;</span><br><span class=line>    <span class=keyword>return</span> followService.followCommons(followUserId);</span><br><span class=line>&#125;</span><br><span class=line></span><br></pre></td></tr></table></figure><h3 id=5-3-Feed流实现方案><a href=#5-3-Feed流实现方案 class=headerlink title="5.3 Feed流实现方案"></a>5.3 Feed流实现方案</h3><h4 id=5-3-1-什么是Feed流><a href=#5-3-1-什么是Feed流 class=headerlink title="5.3.1 什么是Feed流"></a>5.3.1 什么是Feed流</h4><p>当我们关注了用户后，这个用户发了动态，那么我们应该把这些数据推送给用户，这个需求，其实我们又把他叫做Feed流，关注推送也叫做Feed流，直译为投喂。为用户持续的提供“沉浸式”的体验，通过无限下拉刷新获取新的信息。</p><p>对于传统的模式的内容解锁：我们是需要用户去通过搜索引擎或者是其他的方式去解锁想要看的内容</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428145732900.png alt=image-20230428145732900></p><p>对于新型的Feed流的的效果：不需要我们用户再去推送信息，而是系统分析用户到底想要什么，然后直接把内容推送给用户，从而使用户能够更加的节约时间，不用主动去寻找。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428145748376.png alt=image-20230428145748376></p><h4 id=5-3-2-Feed流实现模式><a href=#5-3-2-Feed流实现模式 class=headerlink title="5.3.2 Feed流实现模式"></a>5.3.2 Feed流实现模式</h4><p>Feed流产品有两种常见模式：<br><strong>Timeline：</strong>不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注。例如朋友圈</p><ul><li>优点：信息全面，不会有缺失。并且实现也相对简单</li><li>缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低</li></ul><p><strong>智能排序：</strong>利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户</p><ul><li><p>优点：投喂用户感兴趣信息，用户粘度很高，容易沉迷</p></li><li><p>缺点：如果算法不精准，可能起到反作用</p><p>本例中的个人页面，是基于关注的好友来做Feed流，因此采用Timeline的模式。该模式的实现方案有三种：</p></li></ul><h4 id=5-3-3-Feed流的Timeline模式><a href=#5-3-3-Feed流的Timeline模式 class=headerlink title="5.3.3 Feed流的Timeline模式"></a>5.3.3 Feed流的Timeline模式</h4><p>我们本次针对好友的操作，采用的就是Timeline的方式，只需要拿到我们关注用户的信息，然后按照时间排序即可，因此采用Timeline的模式。该模式的实现方案有三种：</p><ul><li>拉模式</li><li>推模式</li><li>推拉结合</li></ul><p><strong>拉模式</strong>：也叫做读扩散</p><p>该模式的核心含义就是：当张三和李四和王五发了消息后，都会保存在自己的邮箱中，假设赵六要读取信息，那么他会从读取他自己的收件箱，此时系统会从他关注的人群中，把他关注人的信息全部都进行拉取，然后在进行排序</p><p>优点：比较节约空间，因为赵六在读信息时，并没有重复读取，而且读取完之后可以把他的收件箱进行清楚。</p><p>缺点：比较延迟，当用户读取数据时才去关注的人里边去读取数据，假设用户关注了大量的用户，那么此时就会拉取海量的内容，对服务器压力巨大。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428150145049.png alt=image-20230428150145049></p><p><strong>推模式</strong>：也叫做写扩散。</p><p>推模式是没有写邮箱的，当张三写了一个内容，此时会主动的把张三写的内容发送到他的粉丝收件箱中去，假设此时李四再来读取，就不用再去临时拉取了</p><p>优点：时效快，不用临时拉取</p><p>缺点：内存压力大，假设一个大V写信息，很多人关注他， 就会写很多分数据到粉丝那边去</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428150221619.png alt=image-20230428150221619></p><p><strong>推拉结合模式</strong>：也叫做读写混合，兼具推和拉两种模式的优点。</p><p>推拉模式是一个折中的方案，站在发件人这一段，如果是个普通的人，那么我们采用写扩散的方式，直接把数据写入到他的粉丝中去，因为普通的人他的粉丝关注量比较小，所以这样做没有压力，如果是大V，那么他是直接将数据先写入到一份到发件箱里边去，然后再直接写一份到活跃粉丝收件箱里边去，现在站在收件人这端来看，如果是活跃粉丝，那么大V和普通的人发的都会直接写入到自己收件箱里边来，而如果是普通的粉丝，由于他们上线不是很频繁，所以等他们上线时，再从发件箱里边去拉信息。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428150236928.png alt=image-20230428150236928></p><p>对比</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/07608789a608d54e99c44655868d3ad4.png alt=image-20221120204125760></p><p>用户不多，所以选择推模式即可</p><h3 id=5-4-推送到粉丝收件箱><a href=#5-4-推送到粉丝收件箱 class=headerlink title="5.4 推送到粉丝收件箱"></a>5.4 推送到粉丝收件箱</h3><h4 id=5-4-1-需求><a href=#5-4-1-需求 class=headerlink title="5.4.1 需求"></a>5.4.1 需求</h4><p>需求：</p><ul><li>修改新增探店笔记的业务，在保存blog到数据库的同时，推送到粉丝的收件箱</li><li>收件箱满足可以根据时间戳排序，必须用Redis的数据结构实现</li><li>查询收件箱数据时，可以实现分页查询</li></ul><h4 id=5-4-2-Feed流使用传统分页弊端><a href=#5-4-2-Feed流使用传统分页弊端 class=headerlink title="5.4.2 Feed流使用传统分页弊端"></a>5.4.2 Feed流使用传统分页弊端</h4><p>Feed流中的数据会不断更新，所以数据的角标也在变化，因此不能采用传统的分页模式。</p><p>传统了分页在feed流是不适用的，因为我们的数据会随时发生变化</p><p>假设在t1 时刻，我们去读取第一页，此时page &#x3D; 1 ，size &#x3D; 5 ，那么我们拿到的就是10<del>6 这几条记录，假设现在t2时候又发布了一条记录，此时t3 时刻，我们来读取第二页，读取第二页传入的参数是page&#x3D;2 ，size&#x3D;5 ，那么此时读取到的第二页实际上是从6 开始，然后是6</del>2 ，那么我们就读取到了重复的数据，所以feed流的分页，不能采用原始方案来做。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428152648180.png alt=image-20230428152648180></p><h4 id=5-4-3-Feed流的滚动分页><a href=#5-4-3-Feed流的滚动分页 class=headerlink title="5.4.3 Feed流的滚动分页"></a>5.4.3 Feed流的滚动分页</h4><p>我们需要记录每次操作的最后一条，然后从这个位置开始去读取数据</p><p>举个例子：我们从t1时刻开始，拿第一页数据，拿到了10~6，然后记录下当前最后一次拿取的记录，就是6，t2时刻发布了新的记录，此时这个11放到最顶上，但是不会影响我们之前记录的6，此时t3时刻来拿第二页，第二页这个时候拿数据，还是从6后一点的5去拿，就拿到了5-1的记录。我们这个地方可以采用sortedSet来做，可以进行范围查询，并且还可以记录当前获取数据<strong>时间戳</strong>最小值，就可以实现滚动分页了。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428152945866.png alt=image-20230428152945866></p><p>核心的意思：就是我们在保存完探店笔记后，获得到当前笔记的粉丝，然后把数据推送到粉丝的redis中去。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">saveBlog</span><span class=params>(Blog blog)</span> &#123;</span><br><span class=line>    <span class=comment>// 1.获取登录用户</span></span><br><span class=line>    <span class=type>UserDTO</span> <span class=variable>user</span> <span class=operator>=</span> UserHolder.getUser();</span><br><span class=line>    blog.setUserId(user.getId());</span><br><span class=line>    <span class=comment>// 2.保存探店笔记</span></span><br><span class=line>    <span class=type>boolean</span> <span class=variable>isSuccess</span> <span class=operator>=</span> save(blog);</span><br><span class=line>    <span class=keyword>if</span>(!isSuccess)&#123;</span><br><span class=line>        <span class=keyword>return</span> Result.fail(<span class=string>&quot;新增笔记失败!&quot;</span>);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// 3.查询笔记作者的所有粉丝 select * from tb_follow where follow_user_id = ?</span></span><br><span class=line>    List&lt;Follow&gt; follows = followService.query().eq(<span class=string>&quot;follow_user_id&quot;</span>, user.getId()).list();</span><br><span class=line>    <span class=comment>// 4.推送笔记id给所有粉丝</span></span><br><span class=line>    <span class=keyword>for</span> (Follow follow : follows) &#123;</span><br><span class=line>        <span class=comment>// 4.1.获取粉丝id</span></span><br><span class=line>        <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> follow.getUserId();</span><br><span class=line>        <span class=comment>// 4.2.推送</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> FEED_KEY + userId;</span><br><span class=line>        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// 5.返回id</span></span><br><span class=line>    <span class=keyword>return</span> Result.ok(blog.getId());</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p><strong>测试：</strong></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/fb3eb3da4a741a93ba0b518ab89be6dd.png alt=image-20221120211239118></p><p><strong>发布后：</strong></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/a0f1ea19761a64397b012e9f8a0d5b4b.png alt=image-20221120211755038></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/0360bdea95bac17dde8bd41953601168.png alt=image-20221120212006847></p><p><strong>查看1,1010用户的收件箱：</strong></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/afd423c5c3bc61e5bd32437af844511b.png alt=image-20221120212248681></p><h4 id=5-4-4-滚动分页查询收件箱><a href=#5-4-4-滚动分页查询收件箱 class=headerlink title="5.4.4 滚动分页查询收件箱"></a>5.4.4 滚动分页查询收件箱</h4><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/eb32ef4ef82a6ca9366d402702b88f2a.png alt=image-20221121095730373></p><p>所以不能用角标 只能用score</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/ebd14154925f7e5e934b3597754eace5.png alt=image-20221121100608075></p><p>limit后面的数据就是偏移量，决定取不取得到端点，第一次就要给0，之后的都要给1 (但是不行)</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/42ac032611a15167493213163a9f80eb.png alt=image-20221121100914781></p><p>有相同值的话，用score的话会重复查</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/c9b2a69baa20d7aecd67bd393edf936e.png alt=image-20221121101116497></p><p>把limit后面的数字改为 <strong>上一次查询的最小值的重复数字的个数</strong></p><h3 id=5-5-实现滚动分页查询><a href=#5-5-实现滚动分页查询 class=headerlink title="5.5 实现滚动分页查询"></a>5.5 实现滚动分页查询</h3><h4 id=5-5-1-需求><a href=#5-5-1-需求 class=headerlink title="5.5.1 需求"></a>5.5.1 需求</h4><p>需求：在个人主页的“关注”卡片中，查询并展示推送的Blog信息：</p><p>具体操作如下：</p><p>1、每次查询完成后，我们要分析出查询出数据的最小时间戳，这个值会作为下一次查询的条件</p><p>2、我们需要找到与上一次查询相同的查询个数作为偏移量，下次查询时，跳过这些查询过的数据，拿到我们需要的数据</p><p>综上：我们的请求参数中就需要携带 lastId：上一次查询的最小时间戳 和偏移量这两个参数。</p><p>这两个参数第一次会由前端来指定，以后的查询就根据后台结果作为条件，再次传递到后台。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428153721379.png alt=image-20230428153721379></p><h4 id=5-5-2-定义出来具体的返回值实体类><a href=#5-5-2-定义出来具体的返回值实体类 class=headerlink title="5.5.2 定义出来具体的返回值实体类"></a>5.5.2 定义出来具体的返回值实体类</h4><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Data</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">ScrollResult</span> &#123;</span><br><span class=line>    <span class=keyword>private</span> List&lt;?&gt; list;</span><br><span class=line>    <span class=keyword>private</span> Long minTime;</span><br><span class=line>    <span class=keyword>private</span> Integer offset;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>BlogController</p><blockquote><p>注意：RequestParam 表示接受url地址栏传参的注解，当方法上参数的名称和url地址栏不相同时，可以通过RequestParam 来进行指定。</p></blockquote><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@GetMapping(&quot;/of/follow&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryBlogOfFollow</span><span class=params>(</span></span><br><span class=line><span class=params>    <span class=meta>@RequestParam(&quot;lastId&quot;)</span> Long max, <span class=meta>@RequestParam(value = &quot;offset&quot;, defaultValue = &quot;0&quot;)</span> Integer offset)</span>&#123;</span><br><span class=line>    <span class=keyword>return</span> blogService.queryBlogOfFollow(max, offset);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>BlogServiceImpl</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryBlogOfFollow</span><span class=params>(Long max, Integer offset)</span> &#123;</span><br><span class=line>    <span class=comment>// 1.获取当前用户</span></span><br><span class=line>    <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>    <span class=comment>// 2.查询收件箱 ZREVRANGEBYSCORE key Max Min LIMIT offset count</span></span><br><span class=line>    <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> FEED_KEY + userId;</span><br><span class=line>    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class=line>        .reverseRangeByScoreWithScores(key, <span class=number>0</span>, max, offset, <span class=number>2</span>);</span><br><span class=line>    <span class=comment>// 3.非空判断</span></span><br><span class=line>    <span class=keyword>if</span> (typedTuples == <span class=literal>null</span> || typedTuples.isEmpty()) &#123;</span><br><span class=line>        <span class=keyword>return</span> Result.ok();</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// 4.解析数据：blogId、minTime（时间戳）、offset</span></span><br><span class=line>    List&lt;Long&gt; ids = <span class=keyword>new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class=line>    <span class=type>long</span> <span class=variable>minTime</span> <span class=operator>=</span> <span class=number>0</span>; <span class=comment>// 2</span></span><br><span class=line>    <span class=type>int</span> <span class=variable>os</span> <span class=operator>=</span> <span class=number>1</span>; <span class=comment>// 2</span></span><br><span class=line>    <span class=keyword>for</span> (ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples) &#123; <span class=comment>// 5 4 4 2 2</span></span><br><span class=line>        <span class=comment>// 4.1.获取id</span></span><br><span class=line>        ids.add(Long.valueOf(tuple.getValue()));</span><br><span class=line>        <span class=comment>// 4.2.获取分数(时间戳）</span></span><br><span class=line>        <span class=type>long</span> <span class=variable>time</span> <span class=operator>=</span> tuple.getScore().longValue();</span><br><span class=line>        <span class=keyword>if</span>(time == minTime)&#123;</span><br><span class=line>            os++;</span><br><span class=line>        &#125;<span class=keyword>else</span>&#123;</span><br><span class=line>            minTime = time;</span><br><span class=line>            os = <span class=number>1</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>	os = minTime == max ? os : os + offset;</span><br><span class=line>    <span class=comment>// 5.根据id查询blog</span></span><br><span class=line>    <span class=type>String</span> <span class=variable>idStr</span> <span class=operator>=</span> StrUtil.join(<span class=string>&quot;,&quot;</span>, ids);</span><br><span class=line>    List&lt;Blog&gt; blogs = query().in(<span class=string>&quot;id&quot;</span>, ids).last(<span class=string>&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class=string>&quot;)&quot;</span>).list();</span><br><span class=line></span><br><span class=line>    <span class=keyword>for</span> (Blog blog : blogs) &#123;</span><br><span class=line>        <span class=comment>// 5.1.查询blog有关的用户</span></span><br><span class=line>        queryBlogUser(blog);</span><br><span class=line>        <span class=comment>// 5.2.查询blog是否被点赞</span></span><br><span class=line>        isBlogLiked(blog);</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=comment>// 6.封装并返回</span></span><br><span class=line>    <span class=type>ScrollResult</span> <span class=variable>r</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">ScrollResult</span>();</span><br><span class=line>    r.setList(blogs);</span><br><span class=line>    r.setOffset(os);</span><br><span class=line>    r.setMinTime(minTime);</span><br><span class=line></span><br><span class=line>    <span class=keyword>return</span> Result.ok(r);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h2 id=6、附近商户><a href=#6、附近商户 class=headerlink title=6、附近商户></a>6、附近商户</h2><h3 id=6-1-GEO数据结构的基本用法><a href=#6-1-GEO数据结构的基本用法 class=headerlink title="6.1 GEO数据结构的基本用法"></a>6.1 GEO数据结构的基本用法</h3><p>附近商铺一般Es使用，这里的话还是用Redis</p><p>GEO就是Geolocation的简写形式，代表地理坐标。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。常见的命令有：</p><ul><li>GEOADD：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）</li><li>GEODIST：计算指定的两个点之间的距离并返回</li><li>GEOHASH：将指定member的坐标转为hash字符串形式并返回</li><li>GEOPOS：返回指定member的坐标</li><li>GEORADIUS：指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。6.以后已废弃</li><li>GEOSEARCH：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能</li><li>GEOSEARCHSTORE：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。 6.2.新功能</li></ul><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/13a3ce0054df7a372635f44d333b37ce.png alt=image-20221121150140938></p><p><strong>添加数据</strong></p><p><code>geoadd g1 116.37 39.86 bjn 116.42 39.90 bj 116.32 39.89 bjx</code></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/f3a110e8cc1a77cd4cdcbd707a2a7a74.png alt=image-20221121151033461></p><p><strong>计算两站距离</strong></p><p><code>geodist g1 bjx bj km(默认m)</code></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/a69424302789f3df16d2293f56e7a8c9.png alt=image-20221121151229007></p><p><strong>以某地为圆心搜索某范围的所有火车站</strong></p><p><code>geosearch g1  fromlonlat 116.39 39.90 byradius 10 km (asc|desc) (withdist)</code></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/418ed1e449e55074a93c1e43983fb9df.png alt=image-20221121151854471></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/84213024bfcd37baa9e2733da24893c0.png alt=image-20221121151940620></p><p>可以看出默认是距离升序</p><h3 id=6-2-导入店铺数据到GEO><a href=#6-2-导入店铺数据到GEO class=headerlink title="6.2 导入店铺数据到GEO"></a>6.2 导入店铺数据到GEO</h3><p>具体场景说明：</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428165207770.png alt=image-20230428165207770></p><p>当我们点击美食之后，会出现一系列的商家，商家中可以按照多种排序方式，我们此时关注的是距离，这个地方就需要使用到我们的GEO，向后台传入当前app收集的地址(我们此处是写死的) ，以当前坐标作为圆心，同时绑定相同的店家类型type，以及分页信息，把这几个条件传入后台，后台查询出对应的数据再返回。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428165253142.png alt=image-20230428165253142></p><p>我们要做的事情是：将数据库表中的数据导入到redis中去，redis中的GEO，GEO在redis中就一个menber和一个经纬度，我们把x和y轴传入到redis做的经纬度位置去，但我们不能把所有的数据都放入到menber中去，毕竟作为redis是一个内存级数据库，如果存海量数据，redis还是力不从心，所以我们在这个地方存储他的id即可。</p><p>但是这个时候还有一个问题，就是在redis中并没有存储type，所以我们无法根据type来对数据进行筛选，所以我们可以按照商户类型做分组，类型相同的商户作为同一组，以typeId为key存入同一个GEO集合中即可</p><p>代码：</p><p>HmDianPingApplicationTests</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Test</span></span><br><span class=line><span class=keyword>void</span> <span class="title function_">loadShopData</span><span class=params>()</span> &#123;</span><br><span class=line>    <span class=comment>// 1.查询店铺信息</span></span><br><span class=line>    List&lt;Shop&gt; list = shopService.list();</span><br><span class=line>    <span class=comment>// 2.把店铺分组，按照typeId分组，typeId一致的放到一个集合</span></span><br><span class=line>    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class=line>    <span class=comment>// 3.分批完成写入Redis</span></span><br><span class=line>    <span class=keyword>for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class=line>        <span class=comment>// 3.1.获取类型id</span></span><br><span class=line>        <span class=type>Long</span> <span class=variable>typeId</span> <span class=operator>=</span> entry.getKey();</span><br><span class=line>        <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> SHOP_GEO_KEY + typeId;</span><br><span class=line>        <span class=comment>// 3.2.获取同类型的店铺的集合</span></span><br><span class=line>        List&lt;Shop&gt; value = entry.getValue();</span><br><span class=line>        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class=keyword>new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());</span><br><span class=line>        <span class=comment>// 3.3.写入redis GEOADD key 经度 纬度 member</span></span><br><span class=line>        <span class=keyword>for</span> (Shop shop : value) &#123;</span><br><span class=line>            <span class=comment>// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span></span><br><span class=line>            locations.add(<span class=keyword>new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(</span><br><span class=line>                    shop.getId().toString(),</span><br><span class=line>                    <span class=keyword>new</span> <span class="title class_">Point</span>(shop.getX(), shop.getY())</span><br><span class=line>            ));</span><br><span class=line>        &#125;</span><br><span class=line>        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h3 id=6-3-实现附近商户功能><a href=#6-3-实现附近商户功能 class=headerlink title="6.3 实现附近商户功能"></a>6.3 实现附近商户功能</h3><p>SpringDataRedis的2.3.9版本并不支持Redis 6.2提供的GEOSEARCH命令，因此我们需要提示其版本，修改自己的POM</p><p>第一步：导入pom</p><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre></td><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>exclusions</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>exclusion</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-data-redis<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.data<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>exclusion</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>exclusion</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>lettuce-core<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>io.lettuce<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>exclusion</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>exclusions</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.data<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-data-redis<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>2.6.2<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>io.lettuce<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>lettuce-core<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>6.1.6.RELEASE<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>第二步：</p><p>ShopController</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@GetMapping(&quot;/of/type&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">queryShopByType</span><span class=params>(</span></span><br><span class=line><span class=params>        <span class=meta>@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span></span><br><span class=line><span class=params>        <span class=meta>@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class=line><span class=params>        <span class=meta>@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span></span><br><span class=line><span class=params>        <span class=meta>@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span></span><br><span class=line><span class=params>)</span> &#123;</span><br><span class=line>   <span class=keyword>return</span> shopService.queryShopByType(typeId, current, x, y);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>ShopServiceImpl</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> Result <span class="title function_">queryShopByType</span><span class=params>(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class=line>        <span class=comment>// 1.判断是否需要根据坐标查询</span></span><br><span class=line>        <span class=keyword>if</span> (x == <span class=literal>null</span> || y == <span class=literal>null</span>) &#123;</span><br><span class=line>            <span class=comment>// 不需要坐标查询，按数据库查询</span></span><br><span class=line>            Page&lt;Shop&gt; page = query()</span><br><span class=line>                    .eq(<span class=string>&quot;type_id&quot;</span>, typeId)</span><br><span class=line>                    .page(<span class=keyword>new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class=line>            <span class=comment>// 返回数据</span></span><br><span class=line>            <span class=keyword>return</span> Result.ok(page.getRecords());</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=comment>// 2.计算分页参数</span></span><br><span class=line>        <span class=type>int</span> <span class=variable>from</span> <span class=operator>=</span> (current - <span class=number>1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class=line>        <span class=type>int</span> <span class=variable>end</span> <span class=operator>=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class=line></span><br><span class=line>        <span class=comment>// 3.查询redis、按照距离排序、分页。结果：shopId、distance</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> SHOP_GEO_KEY + typeId;</span><br><span class=line>        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo() <span class=comment>// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE</span></span><br><span class=line>                .search(</span><br><span class=line>                        key,</span><br><span class=line>                        GeoReference.fromCoordinate(x, y),</span><br><span class=line>                        <span class=keyword>new</span> <span class="title class_">Distance</span>(<span class=number>5000</span>),</span><br><span class=line>                        RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end)</span><br><span class=line>                );</span><br><span class=line>        <span class=comment>// 4.解析出id</span></span><br><span class=line>        <span class=keyword>if</span> (results == <span class=literal>null</span>) &#123;</span><br><span class=line>            <span class=keyword>return</span> Result.ok(Collections.emptyList());</span><br><span class=line>        &#125;</span><br><span class=line>        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class=line>        <span class=keyword>if</span> (list.size() &lt;= from) &#123;</span><br><span class=line>            <span class=comment>// 没有下一页了，结束</span></span><br><span class=line>            <span class=keyword>return</span> Result.ok(Collections.emptyList());</span><br><span class=line>        &#125;</span><br><span class=line>        <span class=comment>// 4.1.截取 from ~ end的部分</span></span><br><span class=line>        List&lt;Long&gt; ids = <span class=keyword>new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class=line>        Map&lt;String, Distance&gt; distanceMap = <span class=keyword>new</span> <span class="title class_">HashMap</span>&lt;&gt;(list.size());</span><br><span class=line>        list.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class=line>            <span class=comment>// 4.2.获取店铺id</span></span><br><span class=line>            <span class=type>String</span> <span class=variable>shopIdStr</span> <span class=operator>=</span> result.getContent().getName();</span><br><span class=line>            ids.add(Long.valueOf(shopIdStr));</span><br><span class=line>            <span class=comment>// 4.3.获取距离</span></span><br><span class=line>            <span class=type>Distance</span> <span class=variable>distance</span> <span class=operator>=</span> result.getDistance();</span><br><span class=line>            distanceMap.put(shopIdStr, distance);</span><br><span class=line>        &#125;);</span><br><span class=line>        <span class=comment>// 5.根据id查询Shop</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>idStr</span> <span class=operator>=</span> StrUtil.join(<span class=string>&quot;,&quot;</span>, ids);</span><br><span class=line>        List&lt;Shop&gt; shops = query().in(<span class=string>&quot;id&quot;</span>, ids).last(<span class=string>&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class=string>&quot;)&quot;</span>).list();</span><br><span class=line>        <span class=keyword>for</span> (Shop shop : shops) &#123;</span><br><span class=line>            shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class=line>        &#125;</span><br><span class=line>        <span class=comment>// 6.返回</span></span><br><span class=line>        <span class=keyword>return</span> Result.ok(shops);</span><br><span class=line>    &#125;</span><br></pre></td></tr></table></figure><h2 id=7、用户签到><a href=#7、用户签到 class=headerlink title=7、用户签到></a>7、用户签到</h2><h3 id=7-1-BitMap功能演示><a href=#7-1-BitMap功能演示 class=headerlink title="7.1 BitMap功能演示"></a>7.1 BitMap功能演示</h3><p>我们针对签到功能完全可以通过mysql来完成，比如说以下这张表</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428165646986.png alt=image-20230428165646986></p><p>用户一次签到，就是一条记录，假如有1000万用户，平均每人每年签到次数为10次，则这张表一年的数据量为 1亿条</p><p>每签到一次需要使用（8 + 8 + 1 + 1 + 3 + 1）共22 字节的内存，一个月则最多需要600多字节</p><p>我们如何能够简化一点呢？其实可以考虑小时候一个挺常见的方案，就是小时候，咱们准备一张小小的卡片，你只要签到就打上一个勾，我最后判断你是否签到，其实只需要到小卡片上看一看就知道了</p><p>我们可以采用类似这样的方案来实现我们的签到需求。</p><p>我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.</p><p>把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）。这样我们就用极小的空间，来实现了大量数据的表示</p><p>Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 2^32个bit位。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428165806923.png alt=image-20230428165806923></p><p>BitMap的操作命令有：</p><ul><li>SETBIT：向指定位置（offset）存入一个0或1</li><li>GETBIT ：获取指定位置（offset）的bit值</li><li>BITCOUNT ：统计BitMap中值为1的bit位的数量</li><li>BITFIELD ：操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值</li><li>BITFIELD_RO ：获取BitMap中bit数组，并以十进制形式返回</li><li>BITOP ：将多个BitMap的结果做位运算（与 、或、异或）</li><li>BITPOS ：查找bit数组中指定范围内第一个0或1出现的位置</li></ul><h3 id=7-2-实现签到功能><a href=#7-2-实现签到功能 class=headerlink title="7.2 实现签到功能"></a>7.2 实现签到功能</h3><p>需求：实现签到接口，将当前用户当天签到信息保存到Redis中</p><p>思路：我们可以把年和月作为bitMap的key，然后保存到一个bitMap中，每次签到就到对应的位上把数字从0变成1，只要对应是1，就表明说明这一天已经签到了，反之则没有签到。</p><p>我们通过接口文档发现，此接口并没有传递任何的参数，没有参数怎么确实是哪一天签到呢？这个很容易，可以通过后台代码直接获取即可，然后到对应的地址上去修改bitMap。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230428165955252.png alt=image-20230428165955252></p><p><strong>代码</strong></p><p>UserController</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@PostMapping(&quot;/sign&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">sign</span><span class=params>()</span>&#123;</span><br><span class=line>   <span class=keyword>return</span> userService.sign();</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>UserServiceImpl</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">sign</span><span class=params>()</span> &#123;</span><br><span class=line>    <span class=comment>// 1.获取当前登录用户</span></span><br><span class=line>    <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>    <span class=comment>// 2.获取日期</span></span><br><span class=line>    <span class=type>LocalDateTime</span> <span class=variable>now</span> <span class=operator>=</span> LocalDateTime.now();</span><br><span class=line>    <span class=comment>// 3.拼接key</span></span><br><span class=line>    <span class=type>String</span> <span class=variable>keySuffix</span> <span class=operator>=</span> now.format(DateTimeFormatter.ofPattern(<span class=string>&quot;:yyyyMM&quot;</span>));</span><br><span class=line>    <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class=line>    <span class=comment>// 4.获取今天是本月的第几天</span></span><br><span class=line>    <span class=type>int</span> <span class=variable>dayOfMonth</span> <span class=operator>=</span> now.getDayOfMonth();</span><br><span class=line>    <span class=comment>// 5.写入Redis SETBIT key offset 1</span></span><br><span class=line>    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class=number>1</span>, <span class=literal>true</span>);</span><br><span class=line>    <span class=keyword>return</span> Result.ok();</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20478a52c4ee44e233aaec10ca672921.png alt=image-20221121222942830></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/dd132bf6cc502953718edc970df1d9d3.png alt=image-20221121223022948></p><h3 id=7-3-签到统计><a href=#7-3-签到统计 class=headerlink title="7.3 签到统计"></a>7.3 签到统计</h3><p><strong>问题1：</strong>什么叫做连续签到天数？<br>从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230504155013983.png alt=image-20230504155013983></p><p>Java逻辑代码：获得当前这个月的最后一次签到数据，定义一个计数器，然后不停的向前统计，直到获得第一个非0的数字即可，每得到一个非0的数字计数器+1，直到遍历完所有的数据，就可以获得当前月的签到总天数了</p><p><strong>问题2：</strong>如何得到本月到今天为止的所有签到数据？</p><p>BITFIELD key GET u[dayOfMonth] 0</p><p>假设今天是10号，那么我们就可以从当前月的第一天开始，获得到当前这一天的位数，是10号，那么就是10位，去拿这段时间的数据，就能拿到所有的数据了，那么这10天里边签到了多少次呢？统计有多少个1即可。</p><p><strong>问题3：如何从后向前遍历每个bit位？</strong></p><p>注意：bitMap返回的数据是10进制，哪假如说返回一个数字8，那么我哪儿知道到底哪些是0，哪些是1呢？我们只需要让得到的10进制数字和1做与运算就可以了，因为1只有遇见1 才是1，其他数字都是0 ，我们把签到结果和1进行与操作，每与一次，就把签到结果向右移动一位，依次内推，我们就能完成逐个遍历的效果了。</p><p>需求：实现下面接口，统计当前用户截止当前时间在本月的连续签到天数</p><p>有用户有时间我们就可以组织出对应的key，此时就能找到这个用户截止这天的所有签到记录，再根据这套算法，就能统计出来他连续签到的次数了</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230504155227406.png alt=image-20230504155227406></p><p>代码</p><p><strong>UserController</strong></p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@GetMapping(&quot;/sign/count&quot;)</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">signCount</span><span class=params>()</span>&#123;</span><br><span class=line>    <span class=keyword>return</span> userService.signCount();</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>UserServiceImpl</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> Result <span class="title function_">signCount</span><span class=params>()</span> &#123;</span><br><span class=line>    <span class=comment>// 1.获取当前登录用户</span></span><br><span class=line>    <span class=type>Long</span> <span class=variable>userId</span> <span class=operator>=</span> UserHolder.getUser().getId();</span><br><span class=line>    <span class=comment>// 2.获取日期</span></span><br><span class=line>    <span class=type>LocalDateTime</span> <span class=variable>now</span> <span class=operator>=</span> LocalDateTime.now();</span><br><span class=line>    <span class=comment>// 3.拼接key</span></span><br><span class=line>    <span class=type>String</span> <span class=variable>keySuffix</span> <span class=operator>=</span> now.format(DateTimeFormatter.ofPattern(<span class=string>&quot;:yyyyMM&quot;</span>));</span><br><span class=line>    <span class=type>String</span> <span class=variable>key</span> <span class=operator>=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class=line>    <span class=comment>// 4.获取今天是本月的第几天</span></span><br><span class=line>    <span class=type>int</span> <span class=variable>dayOfMonth</span> <span class=operator>=</span> now.getDayOfMonth();</span><br><span class=line>    <span class=comment>// 5.获取本月截止今天为止的所有的签到记录，返回的是一个十进制的数字 BITFIELD sign:5:202203 GET u14 0</span></span><br><span class=line>    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(</span><br><span class=line>            key,</span><br><span class=line>            BitFieldSubCommands.create()</span><br><span class=line>                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class=number>0</span>)</span><br><span class=line>    );</span><br><span class=line>    <span class=keyword>if</span> (result == <span class=literal>null</span> || result.isEmpty()) &#123;</span><br><span class=line>        <span class=comment>// 没有任何签到结果</span></span><br><span class=line>        <span class=keyword>return</span> Result.ok(<span class=number>0</span>);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=type>Long</span> <span class=variable>num</span> <span class=operator>=</span> result.get(<span class=number>0</span>);</span><br><span class=line>    <span class=keyword>if</span> (num == <span class=literal>null</span> || num == <span class=number>0</span>) &#123;</span><br><span class=line>        <span class=keyword>return</span> Result.ok(<span class=number>0</span>);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// 6.循环遍历</span></span><br><span class=line>    <span class=type>int</span> <span class=variable>count</span> <span class=operator>=</span> <span class=number>0</span>;</span><br><span class=line>    <span class=keyword>while</span> (<span class=literal>true</span>) &#123;</span><br><span class=line>        <span class=comment>// 6.1.让这个数字与1做与运算，得到数字的最后一个bit位  // 判断这个bit位是否为0</span></span><br><span class=line>        <span class=keyword>if</span> ((num &amp; <span class=number>1</span>) == <span class=number>0</span>) &#123;</span><br><span class=line>            <span class=comment>// 如果为0，说明未签到，结束</span></span><br><span class=line>            <span class=keyword>break</span>;</span><br><span class=line>        &#125;<span class=keyword>else</span> &#123;</span><br><span class=line>            <span class=comment>// 如果不为0，说明已签到，计数器+1</span></span><br><span class=line>            count++;</span><br><span class=line>        &#125;</span><br><span class=line>        <span class=comment>// 把数字右移一位，抛弃最后一个bit位，继续下一个bit位</span></span><br><span class=line>        num &gt;&gt;&gt;= <span class=number>1</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>return</span> Result.ok(count);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/b027b277936ae3fee7671be565db48cb.png alt=image-20221122104746525></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/9c5629b88022228a85976b56c1e130ab.png alt=image-20221122104723252></p><h3 id=7-4-关于使用bitmap来解决缓存穿透的方案><a href=#7-4-关于使用bitmap来解决缓存穿透的方案 class=headerlink title="7.4 关于使用bitmap来解决缓存穿透的方案"></a>7.4 关于使用bitmap来解决缓存穿透的方案</h3><p>回顾<strong>缓存穿透</strong>：</p><p>发起了一个数据库不存在的，redis里边也不存在的数据，通常你可以把他看成一个攻击</p><p>解决方案：</p><ul><li><p>判断id&lt;0</p></li><li><p>如果数据库是空，那么就可以直接往redis里边把这个空数据缓存起来</p></li></ul><p>第一种解决方案：遇到的问题是如果用户访问的是id不存在的数据，则此时就无法生效</p><p>第二种解决方案：遇到的问题是：如果是不同的id那就可以防止下次过来直击数据</p><p>所以我们如何解决呢？</p><p>我们可以将数据库的数据，所对应的id写入到一个list集合中，当用户过来访问的时候，我们直接去判断list中是否包含当前的要查询的数据，如果说用户要查询的id数据并不在list集合中，则直接返回，如果list中包含对应查询的id数据，则说明不是一次缓存穿透数据，则直接放行。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230504155753110.png alt=image-20230504155753110></p><p>现在的问题是这个主键其实并没有那么短，而是很长的一个 主键</p><p>哪怕你单独去提取这个主键，但是在11年左右，淘宝的商品总量就已经超过10亿个</p><p>所以如果采用以上方案，这个list也会很大，所以我们可以使用bitmap来减少list的存储空间</p><p>我们可以把list数据抽象成一个非常大的bitmap，我们不再使用list，而是将db中的id数据利用哈希思想，比如：</p><p>id % bitmap.size &#x3D; 算出当前这个id对应应该落在bitmap的哪个索引上，然后将这个值从0变成1，然后当用户来查询数据时，此时已经没有了list，让用户用他查询的id去用相同的哈希算法， 算出来当前这个id应当落在bitmap的哪一位，然后判断这一位是0，还是1，如果是0则表明这一位上的数据一定不存在， 采用这种方式来处理，需要重点考虑一个事情，就是误差率，所谓的误差率就是指当发生哈希冲突的时候，产生的误差。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230504155804723.png alt=image-20230504155804723></p><h2 id=8、UV统计><a href=#8、UV统计 class=headerlink title=8、UV统计></a>8、UV统计</h2><h3 id=8-1-HyperLogLog><a href=#8-1-HyperLogLog class=headerlink title="8.1 HyperLogLog"></a>8.1 HyperLogLog</h3><p>首先我们搞懂两个概念：</p><ul><li>UV：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。</li><li>PV：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。</li></ul><p>通常来说UV会比PV大很多，所以衡量同一个网站的访问量，我们需要综合考虑很多因素，所以我们只是单纯的把这两个值作为一个参考值</p><p>UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖，那怎么处理呢？</p><p>Hyperloglog(HLL)是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。相关算法原理大家可以参考：<a target=_blank rel=noopener href=https://juejin.cn/post/6844903785744056333#heading-0>https://juejin.cn/post/6844903785744056333#heading-0</a><br>Redis中的HLL是基于string结构实现的，单个HLL的内存<strong>永远小于16kb</strong>，<strong>内存占用低</strong>的令人发指！作为代价，其测量结果是概率性的，<strong>有小于0.81％的误差</strong>。不过对于UV统计来说，这完全可以忽略。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/image-20230504161612994.png alt=image-20230504161612994></p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/fe229be298dde84c73562d3fc35d1103.png alt=image-20221122110053643></p><h3 id=8-2-测试百万数据的统计><a href=#8-2-测试百万数据的统计 class=headerlink title="8.2 测试百万数据的统计"></a>8.2 测试百万数据的统计</h3><p>测试思路：我们直接利用单元测试，向HyperLogLog中添加100万条数据，看看内存占用和统计效果如何</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre></td><td class=code><pre><span class=line><span class=meta>@Test</span></span><br><span class=line><span class=keyword>void</span> <span class="title function_">testHyperLogLog</span><span class=params>()</span>&#123;</span><br><span class=line>    String[] values = <span class=keyword>new</span> <span class="title class_">String</span>[<span class=number>1000</span>];</span><br><span class=line>    <span class=type>int</span> j=<span class=number>0</span>;</span><br><span class=line>    <span class=keyword>for</span>(<span class=type>int</span> i=<span class=number>0</span>;i&lt;<span class=number>1000000</span>;i++)&#123;</span><br><span class=line>        j=i%<span class=number>1000</span>;</span><br><span class=line>        values[j]=<span class=string>&quot;user_&quot;</span>+i;</span><br><span class=line>        <span class=keyword>if</span>(j==<span class=number>999</span>)&#123;</span><br><span class=line>            stringRedisTemplate.opsForHyperLogLog().add(<span class=string>&quot;hl2&quot;</span>,values);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>//统计数量</span></span><br><span class=line>    System.out.println(stringRedisTemplate.opsForHyperLogLog().size(<span class=string>&quot;hl2&quot;</span>));</span><br><span class=line>&#125;</span><br><span class=line></span><br></pre></td></tr></table></figure><p>测试一百万个数据，最后存入997593个数据，内存一开始是1679336，现在变成1693720，相差14384，也就是14.046875kb,没超过16kb。</p><p><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/b4263f5eafa3709676a57e7f55220d17.png alt=image-20221122111243033></p><p>经过测试：我们会发生他的误差是在允许范围内，并且内存占用极小</p><p><a target=_blank rel=noopener href="https://blog.csdn.net/weixin_51515308/article/details/128010464?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168265841116800180697885%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168265841116800180697885&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-128010464-null-null.142%5Ev86%5Einsert_down1,239%5Ev2%5Einsert_chatgpt&utm_term=%E9%BB%91%E9%A9%ACredis%E5%AE%9E%E6%88%98%E7%AF%87&spm=1018.2226.3001.4187">参考笔记</a></p></article><div class=post-copyright><div class=post-copyright__title><span class=post-copyright-info><h>Redis实战2</h></span></div><div class=post-copyright__type><span class=post-copyright-info><a href="https://yuydot.gitee.io/2023/04/14/Redis%E5%AE%9E%E6%88%982-%E9%BB%91%E9%A9%AC%E5%A4%A7%E4%BC%97%E7%82%B9%E8%AF%84/">https://yuydot.gitee.io/2023/04/14/Redis实战2-黑马大众点评/</a></span></div><div class=post-copyright-m><div class=post-copyright-m-info><div class=post-copyright-a><h>作者</h><div class=post-copyright-cc-info><h>yuydot</h></div></div><div class=post-copyright-c><h>发布于</h><div class=post-copyright-cc-info><h>2023-04-14</h></div></div><div class=post-copyright-u><h>更新于</h><div class=post-copyright-cc-info><h>2023-05-04</h></div></div><div class=post-copyright-c><h>许可协议</h><div class=post-copyright-cc-info><a class=icon rel=noopener target=_blank title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel=noopener target=_blank title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href="/tags/Redis/">Redis</a></div><div class=post_share><div class=social-share data-image=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css media=print onload="this.media='all'"><script src=https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js defer></script></div></div><nav class=pagination-post id=pagination><div class="prev-post pull-left"><a href="/2023/04/18/ControllerAdvice%E5%AD%A6%E4%B9%A0/" title=ControllerAdvice学习><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-zygeko_2560x1601.png onerror="onerror=null;src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt="cover of previous post"><div class=pagination-info><div class=label>上一篇</div><div class=prev_info>ControllerAdvice学习</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/11/Redis%E5%AE%9E%E6%88%981-%E7%BC%93%E5%AD%98/" title=Redis实战1><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-73e7me_2560x1600.png onerror="onerror=null;src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt="cover of next post"><div class=pagination-info><div class=label>下一篇</div><div class=next_info>Redis实战1</div></div></a></div></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class=relatedPosts-list><div><a href="/2023/04/11/Redis%E5%AE%9E%E6%88%981-%E7%BC%93%E5%AD%98/" title=Redis实战1><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-73e7me_2560x1600.png alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2023-04-11</div><div class=title>Redis实战1</div></div></a></div><div><a href="/2023/05/04/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/" title=Redis分布式缓存><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-73e7me_2560x1600.png alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2023-05-04</div><div class=title>Redis分布式缓存</div></div></a></div><div><a href="/2023/03/31/Springboot%E4%B9%8BRedis%E5%B7%A5%E5%85%B7%E7%B1%BB/" title=Springboot之Redis工具类><img class=cover src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/b766f7558926c27aca44780f488d4910.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2023-03-31</div><div class=title>Springboot之Redis工具类</div></div></a></div></div></div><hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span>评论</span></div></div><div class=comment-wrap><div><div class=vcomment id=vcomment></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info"><div class=is-center><div class=avatar-img><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wang.jpg onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/friend_404.gif'" alt=avatar></div><div class=author-info__name>yuydot</div><div class=author-info__description>好像稍不努力，连快乐都养不起</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class=headline>文章</div><div class=length-num>19</div></a><a href="/tags/"><div class=headline>标签</div><div class=length-num>10</div></a><a href="/categories/"><div class=headline>分类</div><div class=length-num>5</div></a></div><a id=card-info-btn target=_blank rel=noopener href=https://github.com/Yuydot><i class="fab fa-github"></i><span>Follow Me</span><i class="faa-passing animated" style=padding-left:20px;display:inline-block;vertical-align:middle;><svg class=icon style=height:28px;width:28px;fill:currentColor;position:relative;top:5px><use xlink:href=#icon-xiaoqiche></use></svg></i></a><div class="card-info-social-icons is-center"><a class=social-icon href=https://github.com/Yuydot target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:1586488524@qq.com target=_blank title=Email><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class=announcement_content>This is my Blog <img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C.gif height=200 width=236></div><div id=welcome-info></div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>目录</span><span class=toc-percentage></span></div><div class=toc-content><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#1%E3%80%81%E5%8F%91%E5%B8%83%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0><span class=toc-number>1.</span> <span class=toc-text>1、发布探店笔记</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#1-1-%E5%87%86%E5%A4%87><span class=toc-number>1.1.</span> <span class=toc-text>1.1 准备</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#1-2-%E5%85%B7%E4%BD%93%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B><span class=toc-number>1.2.</span> <span class=toc-text>1.2 具体发布流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#2%E3%80%81%E6%9F%A5%E7%9C%8B%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0><span class=toc-number>2.</span> <span class=toc-text>2、查看探店笔记</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#2-1-%E5%AE%9E%E7%8E%B0%E6%9F%A5%E7%9C%8B%E5%8F%91%E5%B8%83%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0%E7%9A%84%E6%8E%A5%E5%8F%A3><span class=toc-number>2.1.</span> <span class=toc-text>2.1 实现查看发布探店笔记的接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#3%E3%80%81%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD><span class=toc-number>3.</span> <span class=toc-text>3、点赞功能</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#3-1-%E5%AE%9E%E7%8E%B0%E6%9F%A5%E7%9C%8B%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD%E7%9A%84%E6%8E%A5%E5%8F%A3><span class=toc-number>3.1.</span> <span class=toc-text>3.1 实现查看点赞功能的接口</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#3-2-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90><span class=toc-number>3.2.</span> <span class=toc-text>3.2 问题分析</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#3-3-%E5%AE%8C%E5%96%84%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD><span class=toc-number>3.3.</span> <span class=toc-text>3.3 完善点赞功能</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%EF%BC%9A><span class=toc-number>3.3.1.</span> <span class=toc-text>具体步骤：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#4%E3%80%81%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C><span class=toc-number>4.</span> <span class=toc-text>4、点赞排行榜</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#4-1%E3%80%81%E5%88%86%E6%9E%90%EF%BC%9A><span class=toc-number>4.1.</span> <span class=toc-text>4.1、分析：</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#4-2%E3%80%81%E4%BF%AE%E6%94%B9BlogServiceImpl><span class=toc-number>4.2.</span> <span class=toc-text>4.2、修改BlogServiceImpl</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#4-3%E3%80%81%E7%82%B9%E8%B5%9E%E5%88%97%E8%A1%A8%E6%9F%A5%E8%AF%A2%E5%88%97%E8%A1%A8><span class=toc-number>4.3.</span> <span class=toc-text>4.3、点赞列表查询列表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#5%E3%80%81%E5%85%B3%E6%B3%A8%E5%92%8C%E5%8F%96%E5%85%B3><span class=toc-number>5.</span> <span class=toc-text>5、关注和取关</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#5-1-%E5%85%B3%E6%B3%A8><span class=toc-number>5.1.</span> <span class=toc-text>5.1 关注</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#5-2-%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8><span class=toc-number>5.2.</span> <span class=toc-text>5.2 共同关注</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#5-3-Feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88><span class=toc-number>5.3.</span> <span class=toc-text>5.3 Feed流实现方案</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#5-3-1-%E4%BB%80%E4%B9%88%E6%98%AFFeed%E6%B5%81><span class=toc-number>5.3.1.</span> <span class=toc-text>5.3.1 什么是Feed流</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-3-2-Feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%BC%8F><span class=toc-number>5.3.2.</span> <span class=toc-text>5.3.2 Feed流实现模式</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-3-3-Feed%E6%B5%81%E7%9A%84Timeline%E6%A8%A1%E5%BC%8F><span class=toc-number>5.3.3.</span> <span class=toc-text>5.3.3 Feed流的Timeline模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#5-4-%E6%8E%A8%E9%80%81%E5%88%B0%E7%B2%89%E4%B8%9D%E6%94%B6%E4%BB%B6%E7%AE%B1><span class=toc-number>5.4.</span> <span class=toc-text>5.4 推送到粉丝收件箱</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#5-4-1-%E9%9C%80%E6%B1%82><span class=toc-number>5.4.1.</span> <span class=toc-text>5.4.1 需求</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-4-2-Feed%E6%B5%81%E4%BD%BF%E7%94%A8%E4%BC%A0%E7%BB%9F%E5%88%86%E9%A1%B5%E5%BC%8A%E7%AB%AF><span class=toc-number>5.4.2.</span> <span class=toc-text>5.4.2 Feed流使用传统分页弊端</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-4-3-Feed%E6%B5%81%E7%9A%84%E6%BB%9A%E5%8A%A8%E5%88%86%E9%A1%B5><span class=toc-number>5.4.3.</span> <span class=toc-text>5.4.3 Feed流的滚动分页</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-4-4-%E6%BB%9A%E5%8A%A8%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%94%B6%E4%BB%B6%E7%AE%B1><span class=toc-number>5.4.4.</span> <span class=toc-text>5.4.4 滚动分页查询收件箱</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#5-5-%E5%AE%9E%E7%8E%B0%E6%BB%9A%E5%8A%A8%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2><span class=toc-number>5.5.</span> <span class=toc-text>5.5 实现滚动分页查询</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#5-5-1-%E9%9C%80%E6%B1%82><span class=toc-number>5.5.1.</span> <span class=toc-text>5.5.1 需求</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#5-5-2-%E5%AE%9A%E4%B9%89%E5%87%BA%E6%9D%A5%E5%85%B7%E4%BD%93%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E5%AE%9E%E4%BD%93%E7%B1%BB><span class=toc-number>5.5.2.</span> <span class=toc-text>5.5.2 定义出来具体的返回值实体类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#6%E3%80%81%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7><span class=toc-number>6.</span> <span class=toc-text>6、附近商户</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#6-1-GEO%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95><span class=toc-number>6.1.</span> <span class=toc-text>6.1 GEO数据结构的基本用法</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#6-2-%E5%AF%BC%E5%85%A5%E5%BA%97%E9%93%BA%E6%95%B0%E6%8D%AE%E5%88%B0GEO><span class=toc-number>6.2.</span> <span class=toc-text>6.2 导入店铺数据到GEO</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#6-3-%E5%AE%9E%E7%8E%B0%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7%E5%8A%9F%E8%83%BD><span class=toc-number>6.3.</span> <span class=toc-text>6.3 实现附近商户功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#7%E3%80%81%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0><span class=toc-number>7.</span> <span class=toc-text>7、用户签到</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#7-1-BitMap%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA><span class=toc-number>7.1.</span> <span class=toc-text>7.1 BitMap功能演示</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#7-2-%E5%AE%9E%E7%8E%B0%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD><span class=toc-number>7.2.</span> <span class=toc-text>7.2 实现签到功能</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#7-3-%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1><span class=toc-number>7.3.</span> <span class=toc-text>7.3 签到统计</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#7-4-%E5%85%B3%E4%BA%8E%E4%BD%BF%E7%94%A8bitmap%E6%9D%A5%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E7%9A%84%E6%96%B9%E6%A1%88><span class=toc-number>7.4.</span> <span class=toc-text>7.4 关于使用bitmap来解决缓存穿透的方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#8%E3%80%81UV%E7%BB%9F%E8%AE%A1><span class=toc-number>8.</span> <span class=toc-text>8、UV统计</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#8-1-HyperLogLog><span class=toc-number>8.1.</span> <span class=toc-text>8.1 HyperLogLog</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#8-2-%E6%B5%8B%E8%AF%95%E7%99%BE%E4%B8%87%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BB%9F%E8%AE%A1><span class=toc-number>8.2.</span> <span class=toc-text>8.2 测试百万数据的统计</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>最新文章</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href="/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/" title=RabbtMQ教程二><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-zygeko_2560x1601.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=RabbtMQ教程二></a><div class=content><a class=title href="/2023/05/17/RabbtMQ%E6%95%99%E7%A8%8B%E4%BA%8C/" title=RabbtMQ教程二>RabbtMQ教程二</a><time datetime=2023-05-17T13:04:40.000Z title="发表于 2023-05-17 21:04:40">2023-05-17</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/" title=RabbtMQ教程一><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=RabbtMQ教程一></a><div class=content><a class=title href="/2023/05/09/RabbtMQ%E6%95%99%E7%A8%8B%E4%B8%80/" title=RabbtMQ教程一>RabbtMQ教程一</a><time datetime=2023-05-09T11:51:28.000Z title="发表于 2023-05-09 19:51:28">2023-05-09</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/05/06/MySQL%E8%BF%9B%E9%98%B6/" title=MySQL进阶><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-76qoky_2560x1600.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=MySQL进阶></a><div class=content><a class=title href="/2023/05/06/MySQL%E8%BF%9B%E9%98%B6/" title=MySQL进阶>MySQL进阶</a><time datetime=2023-05-06T02:23:18.000Z title="发表于 2023-05-06 10:23:18">2023-05-06</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/05/04/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/" title=Redis分布式缓存><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/wallhaven-73e7me_2560x1600.png onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=Redis分布式缓存></a><div class=content><a class=title href="/2023/05/04/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/" title=Redis分布式缓存>Redis分布式缓存</a><time datetime=2023-05-04T08:58:45.000Z title="发表于 2023-05-04 16:58:45">2023-05-04</time></div></div><div class=aside-list-item><a class=thumbnail href="/2023/04/19/Mapstruct%E5%B7%A5%E5%85%B7/" title=Mapstruct工具><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/502997c6c932d8f8028954ee7fb88d2c.jpg onerror="this.onerror=null;this.src='https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/404.jpg'" alt=Mapstruct工具></a><div class=content><a class=title href="/2023/04/19/Mapstruct%E5%B7%A5%E5%85%B7/" title=Mapstruct工具>Mapstruct工具</a><time datetime=2023-04-19T12:30:42.000Z title="发表于 2023-04-19 20:30:42">2023-04-19</time></div></div></div></div></div></div></main><footer id=footer><div id=footer-wrap><div id=ft><div class=ft-item-1><div class=t-top><div class=t-t-l><p class="ft-t t-l-t">格言🧬</p><div class=bg-ad><div>我不再装模作样地拥有很多朋友，而是回到了孤单之中，以真正的我开始了独自的生活。有时我也会因为寂寞而难以忍受空虚的折磨，但我宁愿以这样的方式来维护自己的自尊，也不愿以耻辱为代价去换取那种表面的朋友。✨</div><div class=btn-xz-box><a class=btn-xz target=_blank rel=noopener href="https://stellarium.org/">点击开启星辰之旅</a></div></div></div><div class=t-t-r><p class="ft-t t-l-t">猜你想看💡</p><ul class=ft-links><li><a href="/shuoshuo/">分享生活</a><a href="/box/nav/">网址导航</a></li><li><a href="/social/links/">我的朋友</a><a href="/messageboard/">留点什么</a></li><li><a href="/personal/about/">关于作者</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li><li><a href="/box/Gallery/">我的画廊</a><a href="/personal/bb/">我的唠叨</a></li><li><a href="/site/time/">建设进程</a><a href="/site/census/">网站统计</a></li></ul></div></div></div><div class=ft-item-2><p class=ft-t>推荐友链⌛</p><div class=ft-img-group><div class=img-group-item><a target=_blank rel=noopener href="https://www.fomal.cc/" title=Fomalhaut🥝><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224623.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://tzy1997.com/" title=唐志远の博客><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224801.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://akilar.top/" title=Akilarの糖果屋><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224820.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://butterfly.js.org/" title=Butterfly><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224710.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://anzhiy.cn/" title=安知鱼><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224841.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://www.acozycotage.net/" title=Acozycotage><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224859.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://cdn.netdun.net/" title=网盾星球><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224948.png></a></div><div class=img-group-item><a target=_blank rel=noopener href="https://blog.leonus.cn/" title=Leonus><img src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-lazy-src="https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/R-C (1).gif" data-original=https://yuydot-image-host.oss-cn-beijing.aliyuncs.com/img/20230426224927.png></a></div></div></div></div><div class=copyright><span><b>&copy;2023</b></span><span><b>&nbsp;&nbsp;By yuydot</b></span></div><div id=workboard></div><p id=ghbdages></p></div></footer></div><div id=rightside><div id=rightside-config-hide><button id=readmode type=button title=阅读模式><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick=switchNightMode() title=浅色和深色模式转换><svg width=25 height=25 viewbox="0 0 1024 1024"><use id=modeicon xlink:href=#icon-moon></use></svg></a><button id=hide-aside-btn type=button title=单栏和双栏切换><i class="fas fa-arrows-alt-h"></i></button></div><div id=rightside-config-show><button id=rightside_config type=button title=设置><i class="fas fa-cog fa-spin"></i></button><button class=close id=mobile-toc-button type=button title=目录><i class="fas fa-list-ul"></i></button><button id=chat_btn type=button title=聊天><i class="fas fa-sms"></i></button><a id=to_comment href=#post-comment title=直达评论><i class="fas fa-comments"></i></a><button id=go-up type=button title=回到顶部><span class=scroll-percent></span><i class="fas fa-arrow-up"><span id=percent>0<span>%</span></span></i></button><button id=go-down type=button title=直达底部 onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src=/js/utils.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/4.0.31/fancybox.umd.min.js></script><script src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js></script><div class=js-pjax><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'AQGZMCqJVLEhHK6FvPAjGaz9-gzGzoHsz',
      appKey: 'OG699oy4JvBM9mTDwTovhlTO',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.16/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src=/js/jquery-3.6.0.min.js></script><script src=/js/weather.js></script><script src=/js/footer.js></script><script defer data-pjax src=/js/readPercent.js></script><div class="aplayer no-destroy" data-id=148314925 data-server=netease data-type=playlist data-fixed=true data-autoplay=false data-mini=true></div><script async src=/js/fps.js></script><canvas id=snow></canvas><script async src=/js/snow.js></script><script async src=/js/title.js></script><script defer src=/js/runtime.js></script><script src=/js/sun_moon.js async></script><script async data-pjax src=/js/txmap.js></script><script type=text/javascript src=/js/rightmenu.js></script><script async src=https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js></script><script async src=https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js></script><script defer data-pjax src=/js/cat.js></script><script>(function(d, w, c) {
    w.ChatraID = 'rTwLAKp9sD8gKkYZS';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (true) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><link rel=stylesheet href=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css media=print onload="this.media='all'"><script src=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js></script><script src=https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js></script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div><div class=js-pjax id=rightMenu><div class="rightMenu-group rightMenu-small"><a class=rightMenu-item href=javascript:window.history.back();><i class="fa fa-arrow-left"></i></a><a class=rightMenu-item href=javascript:window.history.forward();><i class="fa fa-arrow-right"></i></a><a class=rightMenu-item href=javascript:window.location.reload();><i class="fa fa-refresh"></i></a><a class=rightMenu-item href=javascript:rmf.scrollToTop();><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-text><a class=rightMenu-item href=javascript:rmf.copySelect();><i class="fa fa-copy"></i><span>复制</span></a><a class=rightMenu-item href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-too><a class=rightMenu-item href=javascript:window.open(window.getSelection().toString());window.location.reload();><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-paste><a class=rightMenu-item href=javascript:rmf.paste()><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-post><a class=rightMenu-item href=#post-comment><i class="fas fa-comment"></i><span>空降评论</span></a><a class=rightMenu-item href=javascript:rmf.copyWordsLink()><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-to><a class=rightMenu-item href=javascript:rmf.openWithNewTab()><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class=rightMenu-item id=menu-too href=javascript:rmf.open()><i class="fa fa-link"></i><span>转到链接</span></a><a class=rightMenu-item href=javascript:rmf.copyLink()><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id=menu-img><a class=rightMenu-item href=javascript:rmf.saveAs()><i class="fa fa-download"></i><span>保存图片</span></a><a class=rightMenu-item href=javascript:rmf.openWithNewTab()><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class=rightMenu-item href=javascript:rmf.copyLink()><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class=rightMenu-item href=javascript:randomPost()><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class=rightMenu-item href=javascript:switchNightMode();><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class=rightMenu-item href=javascript:rmf.switchReadMode();><i class="fa fa-book"></i><span>阅读模式</span></a><a class=rightMenu-item href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class=rightMenu-item href=javascript:toggleWinbox();><i class="fas fa-cog"></i><span>美化设置</span></a><a class=rightMenu-item href=javascript:rmf.fullScreen();><i class="fas fa-expand"></i><span>切换全屏</span></a><a class=rightMenu-item href=javascript:window.print();><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://yuydot.gitee.io/categories/Spring/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 Spring (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yuydot.gitee.io/categories/Git/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱‍👓 Git (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://yuydot.gitee.io/categories/数据库/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 数据库 (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://yuydot.gitee.io/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style><style></style><div class=js-pjax><script async>var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async>var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src=https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js></script><script defer src=https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js></script><style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body></html>